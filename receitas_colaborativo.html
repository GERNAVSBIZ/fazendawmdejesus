<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Receitas da Fazenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; margin: auto; height: 400px; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        let chartInstances = {};
        let originalData = [];
        const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        function signIn() { auth.signInWithPopup(provider).catch(e => console.error("Auth Error:", e)); }
        function signOut() { auth.signOut().catch(e => console.error("Sign Out Error:", e)); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-img').src = user.photoURL;
                loadAndProcessData();
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        async function loadAndProcessData() {
            try {
                const snapshot = await db.collection("receitas").orderBy("Timestamp", "desc").get();
                originalData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                initializeDashboard(originalData);
            } catch (error) {
                console.error("Erro ao carregar dados: ", error);
                alert("Erro ao carregar dados. Verifique as permissões do Firestore e se a coleção 'receitas' existe.");
            }
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date();
             if (dateStr.toDate) { // Check if it's a Firestore Timestamp
                return dateStr.toDate();
            }
            if (typeof dateStr !== 'string') return new Date();
             if (dateStr.includes('-')) { 
                return new Date(dateStr + "T00:00:00");
            }
            const parts = dateStr.split('/');
            if (parts.length !== 3) return new Date();
            const [day, month, year] = parts;
            return new Date(Number(year), Number(month) - 1, Number(day));
        }
        
        function parseCurrency(currencyStr) {
            if (typeof currencyStr !== 'string') return Number(currencyStr) || 0;
            return Number(currencyStr.replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
        }
        
        function initializeDashboard(data) {
            populateFilters(data);
            addEventListeners();
            filterAndDisplay();
        }

        function addEventListeners() {
            document.getElementById('yearFilter').addEventListener('change', filterAndDisplay);
            document.getElementById('monthFilter').addEventListener('change', filterAndDisplay);
            document.getElementById('typeFilter').addEventListener('change', filterAndDisplay);
            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('csv-upload-input').click());
            document.getElementById('csv-upload-input').addEventListener('change', handleFileSelect);
            document.getElementById('manual-entry-form').addEventListener('submit', handleManualEntry);
        }
        
        async function handleManualEntry(event) {
            event.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("Você precisa estar logado para adicionar registros.");
                return;
            }

            const newEntry = {
                Data: document.getElementById('entry-data').value, // Mantém YYYY-MM-DD
                'Tipo de Receita': document.getElementById('entry-tipo').value,
                Total: document.getElementById('entry-total').value,
                Observações: document.getElementById('entry-obs').value,
                Usuario: user.displayName,
                uid: user.uid,
                Timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection("receitas").add(newEntry);
                alert("Receita adicionada com sucesso!");
                document.getElementById('manual-entry-form').reset();
                loadAndProcessData();
            } catch (error) {
                console.error("Erro ao adicionar receita: ", error);
                alert("Ocorreu um erro ao adicionar a receita.");
            }
        }
        
        function filterAndDisplay() {
            let filteredData = originalData;
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const type = document.getElementById('typeFilter').value;

            if (year !== 'all') filteredData = filteredData.filter(d => parseDate(d.Data).getFullYear() == year);
            if (month !== 'all') filteredData = filteredData.filter(d => parseDate(d.Data).getMonth() == month);
            if (type !== 'all') filteredData = filteredData.filter(d => d['Tipo de Receita'] === type);
            
            displayData(filteredData);
            createMonthlyRevenueChart(filteredData);
            createRevenueSourceChart(filteredData);
        }

        // --- Funções colapsadas para economizar espaço ---
        function handleFileSelect(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){const parsedData=parseCSV(e.target.result);if(parsedData.length>0)uploadCSVData(parsedData,file.name)};reader.readAsText(file,'ISO-8859-1')}
        function parseCSV(text){const lines=text.split(/\r?\n/).filter(line=>line.trim()!=='');let headerIndex=-1;for(let i=0;i<lines.length;i++){if(lines[i].toLowerCase().includes('data')){headerIndex=i;break}}if(headerIndex===-1){alert("Erro: Cabeçalho 'Data' não encontrado.");return[]}const headers=lines[headerIndex].split(';').map(h=>h.trim());const dataLines=lines.slice(headerIndex+1);return dataLines.map(line=>{const values=line.split(';');let obj={};headers.forEach((header,i)=>{if(header)obj[header]=values[i]||''});return obj}).filter(obj=>obj.Data)}
        async function uploadCSVData(data,fileName){const user=auth.currentUser;if(!user){alert("Você precisa estar logado.");return}if(!confirm(`Deseja enviar ${data.length} registros do arquivo ${fileName}?`))return;const batch=db.batch();const collectionRef=db.collection("receitas");data.forEach(item=>{const docRef=collectionRef.doc();batch.set(docRef,{...item,Usuario:user.displayName,uid:user.uid,Timestamp:firebase.firestore.FieldValue.serverTimestamp()})});try{await batch.commit();alert("Dados do CSV enviados com sucesso!");loadAndProcessData()}catch(error){console.error("Erro ao enviar CSV:",error);alert("Erro ao enviar dados.")}}
        function populateFilters(data){const types=[...new Set(data.map(item=>item['Tipo de Receita']))].filter(Boolean).sort();const years=[...new Set(data.map(item=>parseDate(item.Data).getFullYear()))].filter(Boolean).sort((a,b)=>b-a);const populateSelect=(elementId,options,isMonth=false)=>{const select=document.getElementById(elementId);select.innerHTML=`<option value="all">${isMonth?'Todos os Meses':'Todos'}</option>`;if(isMonth){options.forEach((opt,i)=>select.add(new Option(opt,i)))}else{options.forEach(opt=>select.add(new Option(opt,opt)))}};populateSelect('typeFilter',types);populateSelect('yearFilter',years);populateSelect('monthFilter',meses,true)}
        function displayData(data){const tableBody=document.getElementById('revenueTableBody');tableBody.innerHTML='';let totalGeral=0;if(!data||data.length===0){tableBody.innerHTML=`<tr><td colspan="5" class="text-center py-4">Nenhum dado encontrado.</td></tr>`}else{data.forEach(row=>{const tr=document.createElement('tr');tr.className='border-b border-gray-200 dark:border-gray-700';tr.innerHTML=`<td class="py-3 px-4">${parseDate(row.Data).toLocaleDateString('pt-BR')}</td><td class="py-3 px-4">${row['Tipo de Receita']||'N/A'}</td><td class="py-3 px-4 text-right">${parseCurrency(row.Total).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td><td class="py-3 px-4">${row.Observações||''}</td><td class="py-3 px-4">${row.Usuario||'N/A'}</td>`;tableBody.appendChild(tr);totalGeral+=parseCurrency(row.Total)})};document.getElementById('total-geral').textContent=totalGeral.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
        function createMonthlyRevenueChart(data){const ctx=document.getElementById('monthlyRevenueChart').getContext('2d');if(chartInstances.monthly)chartInstances.monthly.destroy();const monthlyTotals=Array(12).fill(0);const yearFilter=document.getElementById('yearFilter').value;let filteredData=data;if(yearFilter!=='all'){filteredData=data.filter(d=>parseDate(d.Data).getFullYear()==yearFilter)}filteredData.forEach(row=>{monthlyTotals[parseDate(row.Data).getMonth()]+=parseCurrency(row.Total)});const label=`Receita Mensal (${yearFilter==='all'?'Geral':yearFilter})`;chartInstances.monthly=new Chart(ctx,{type:'bar',data:{labels:meses,datasets:[{label:label,data:monthlyTotals,backgroundColor:'rgba(34, 197, 94, 0.7)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}}}})}
        function createRevenueSourceChart(data){const ctx=document.getElementById('revenueSourceChart').getContext('2d');if(chartInstances.source)chartInstances.source.destroy();const sourceTotals=data.reduce((acc,cur)=>{const type=cur['Tipo de Receita'];const total=parseCurrency(cur.Total);acc[type]=(acc[type]||0)+total;return acc},{});const sortedSources=Object.entries(sourceTotals).sort((a,b)=>b[1]-a[1]);chartInstances.source=new Chart(ctx,{type:'doughnut',data:{labels:sortedSources.map(s=>s[0]),datasets:[{data:sortedSources.map(s=>s[1]),backgroundColor:['#22c55e','#84cc16','#f97316','#3b82f6','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}})}
    </script>
    
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold mb-4">Análise de Receitas da Fazenda</h1>
            <p class="mb-6">Por favor, faça login para continuar.</p>
            <button onclick="signIn()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mx-auto">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" /><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold">Análise de Receitas</h1>
                <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                <button id="upload-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Carregar CSV
                </button>
            </div>
            <div class="flex items-center">
                <span id="user-name" class="mr-4 hidden sm:block"></span>
                <img id="user-img" class="w-10 h-10 rounded-full mr-4" alt="User Avatar">
                <button onclick="signOut()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
            </div>
        </header>

        <main class="p-6">
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                 <div><label for="yearFilter" class="block text-sm font-medium">Ano:</label><select id="yearFilter" class="mt-1 block w-full p-2 border rounded-md"></select></div>
                 <div><label for="monthFilter" class="block text-sm font-medium">Mês:</label><select id="monthFilter" class="mt-1 block w-full p-2 border rounded-md"></select></div>
                 <div><label for="typeFilter" class="block text-sm font-medium">Tipo de Receita:</label><select id="typeFilter" class="mt-1 block w-full p-2 border rounded-md"></select></div>
            </div>

            <!-- Formulário de Adição Manual -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                <h2 class="text-lg font-semibold mb-4">Adicionar Nova Receita</h2>
                <form id="manual-entry-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div><label for="entry-data" class="block text-sm font-medium">Data:</label><input type="date" id="entry-data" required class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div>
                    <div><label for="entry-tipo" class="block text-sm font-medium">Tipo:</label><input type="text" id="entry-tipo" required class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" placeholder="Ex: LEITE"></div>
                    <div><label for="entry-total" class="block text-sm font-medium">Valor Total (R$):</label><input type="number" step="0.01" id="entry-total" required class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" placeholder="Ex: 5500.50"></div>
                    <div class="md:col-span-2"><label for="entry-obs" class="block text-sm font-medium">Observações:</label><input type="text" id="entry-obs" class="mt-1 block w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full md:col-start-5">Adicionar</button>
                </form>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h2 class="text-lg font-semibold mb-2 text-center">Fontes de Receita</h2><div class="chart-container"><canvas id="revenueSourceChart"></canvas></div></div>
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h2 class="text-lg font-semibold mb-2 text-center">Receita Mensal</h2><div class="chart-container"><canvas id="monthlyRevenueChart"></canvas></div></div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Tabela de Receitas</h2>
                    <div class="text-right"><span class="text-sm font-medium">Total Filtrado:</span><span id="total-geral" class="text-xl font-bold text-green-500 ml-2"></span></div>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700 sticky top-0">
                            <tr>
                                <th class="py-3 px-4">Data</th>
                                <th class="py-3 px-4">Tipo</th>
                                <th class="py-3 px-4 text-right">Total</th>
                                <th class="py-3 px-4">Observações</th>
                                <th class="py-3 px-4">Lançado por</th>
                            </tr>
                        </thead>
                        <tbody id="revenueTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</body>
</html>

