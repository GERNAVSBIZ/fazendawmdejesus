<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fazenda WM - Gestão Financeira</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para traduzir o React no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuração para evitar zoom no input em iOS -->
    <style>
        @layer utilities {
            .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        }
        input, select, textarea { font-size: 16px !important; } /* Evita zoom no iPhone */
        
        /* Animação suave de entrada */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 select-none">

    <!-- SHARED NAVBAR START -->
    <nav class="bg-emerald-700 text-white shadow-md sticky top-0 z-50 print:hidden">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-14">
                <a href="index.html" class="font-bold text-lg flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span>WM de Jesus</span>
                </a>
                <div class="flex space-x-1 overflow-x-auto">
                     <a href="index.html" class="px-3 py-2 rounded hover:bg-emerald-600 text-sm whitespace-nowrap transition-colors">Início</a>
                    <a href="leite_colaborativo.html" class="px-3 py-2 rounded hover:bg-emerald-600 text-sm whitespace-nowrap transition-colors">Leite</a>
                    <a href="despesas.html" class="px-3 py-2 rounded hover:bg-emerald-600 text-sm whitespace-nowrap transition-colors">Despesas</a>
                    <a href="financeiro.html" class="px-3 py-2 rounded hover:bg-emerald-600 text-sm whitespace-nowrap transition-colors">Financeiro</a>
                    <a href="registro_animais.html" class="px-3 py-2 rounded hover:bg-emerald-600 text-sm whitespace-nowrap transition-colors">Rebanho</a>
                     <a href="vacas_producao.html" class="px-3 py-2 rounded hover:bg-emerald-600 text-sm whitespace-nowrap transition-colors">Produção</a>
                </div>
            </div>
        </div>
    </nav>
    <!-- SHARED NAVBAR END -->

    <div id="root"></div>

    <!-- Script Principal da Aplicação -->
    <script type="text/babel" data-type="module" data-presets="react">
        // Importações via CDN
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            PlusCircle, Upload, Home, List, Trash2, Edit2, Save, X, Check, 
            DollarSign, FileText, Calendar, Search, ArrowUpCircle, LogOut, User, Lock, Sprout
        } from 'https://esm.sh/lucide-react@0.292.0';
        
        // Importações do Firebase v10
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, 
            query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Configuração da Fazenda WM ---
        const firebaseConfig = window.globalFirebaseConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'fazenda-wm-producao'; 

        // --- Funções Auxiliares ---
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        // --- Componentes ---

        // 0. Login Screen (Nova tela de Autenticação)
        const AuthScreen = () => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error(err);
                    let msg = "Ocorreu um erro.";
                    if (err.code === 'auth/invalid-credential') msg = "Email ou senha incorretos.";
                    if (err.code === 'auth/email-already-in-use') msg = "Este email já está cadastrado.";
                    if (err.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                    setError(msg);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-600 to-green-800 text-white">
                    <div className="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-gray-800 fade-in">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-emerald-100 p-4 rounded-full mb-3">
                                <Sprout size={40} className="text-emerald-600" />
                            </div>
                            <h1 className="text-2xl font-bold text-emerald-900">Fazenda WM</h1>
                            <p className="text-sm text-gray-500">Gestão de Receitas</p>
                        </div>

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Email</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-3 text-gray-400"><User size={20} /></div>
                                    <input 
                                        type="email" required placeholder="seu@email.com"
                                        className="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"
                                        value={email} onChange={e => setEmail(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Senha</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-3 text-gray-400"><Lock size={20} /></div>
                                    <input 
                                        type="password" required placeholder="******" minLength={6}
                                        className="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"
                                        value={password} onChange={e => setPassword(e.target.value)}
                                    />
                                </div>
                            </div>

                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-xl text-center border border-red-100">{error}</div>}

                            <button 
                                type="submit" disabled={loading}
                                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-all disabled:opacity-70 mt-2"
                            >
                                {loading ? 'Carregando...' : (isRegistering ? 'Criar Conta' : 'Entrar')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => { setIsRegistering(!isRegistering); setError(''); }}
                                className="text-emerald-600 text-sm font-semibold hover:underline"
                            >
                                {isRegistering ? 'Já tenho uma conta' : 'Não tem conta? Cadastre-se'}
                            </button>
                        </div>
                    </div>
                    <p className="mt-8 text-emerald-100 text-xs opacity-60">Versão Produção v1.0</p>
                </div>
            );
        };

        // 1. Dashboard
        const Dashboard = ({ revenues, setActiveTab }) => {
            const totalRevenue = revenues.reduce((acc, curr) => acc + Number(curr.amount), 0);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyRevenue = revenues
                .filter(r => {
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                })
                .reduce((acc, curr) => acc + Number(curr.amount), 0);

            const recentRevenues = [...revenues]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            return (
                <div className="space-y-6 pb-24 fade-in">
                    <header className="bg-emerald-600 text-white p-6 rounded-b-3xl shadow-lg relative">
                        <div className="flex justify-between items-start mb-2">
                            <div>
                                <h1 className="text-2xl font-bold">Fazenda WM</h1>
                                <p className="text-emerald-100 text-sm">Visão Financeira</p>
                            </div>
                            <button onClick={() => signOut(auth)} className="bg-emerald-700 p-2 rounded-lg hover:bg-emerald-800 transition-colors" title="Sair">
                                <LogOut size={18} />
                            </button>
                        </div>
                        
                        <div className="mt-6 bg-white/10 backdrop-blur-md p-4 rounded-2xl border border-white/20">
                            <span className="text-emerald-50 text-xs uppercase tracking-wider">Receita Total</span>
                            <div className="text-3xl font-bold mt-1">{formatCurrency(totalRevenue)}</div>
                        </div>

                        <div className="mt-4 flex justify-between items-center text-emerald-100 text-sm">
                            <span>Este Mês:</span>
                            <span className="font-semibold text-white">{formatCurrency(monthlyRevenue)}</span>
                        </div>
                    </header>

                    <div className="px-4">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold text-gray-800">Últimas Entradas</h2>
                            <button 
                                onClick={() => setActiveTab('list')}
                                className="text-emerald-600 text-sm font-semibold hover:underline"
                            >
                                Ver todas
                            </button>
                        </div>

                        {recentRevenues.length === 0 ? (
                            <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-xl border border-gray-100">
                                <p>Nenhuma receita registrada.</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {recentRevenues.map((rev) => (
                                    <div key={rev.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-emerald-100 p-2 rounded-full text-emerald-600">
                                                <ArrowUpCircle size={20} />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-gray-800 line-clamp-1">{rev.description}</p>
                                                <p className="text-xs text-gray-500">{formatDate(rev.date)} • {rev.category || 'Geral'}</p>
                                            </div>
                                        </div>
                                        <span className="font-bold text-emerald-600">{formatCurrency(rev.amount)}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div className="px-4 grid grid-cols-2 gap-4">
                        <button 
                            onClick={() => setActiveTab('add')}
                            className="bg-emerald-600 text-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform"
                        >
                            <PlusCircle size={24} />
                            <span className="font-semibold">Nova Receita</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('import')}
                            className="bg-white text-emerald-600 border border-emerald-100 p-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform"
                        >
                            <Upload size={24} />
                            <span className="font-semibold">Importar CSV</span>
                        </button>
                    </div>
                </div>
            );
        };

        // 2. Add Manual Revenue
        const AddRevenue = ({ onSave, setActiveTab }) => {
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                description: '',
                amount: '',
                category: 'Venda de Leite'
            });
            const [loading, setLoading] = useState(false);

            const categories = [
                'Venda de Leite', 'Venda de Animais', 'Venda de Queijo',
                'Serviços Prestados', 'Aportes', 'Outros'
            ];

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.description || !formData.amount) return;

                setLoading(true);
                await onSave({
                    ...formData,
                    amount: parseFloat(formData.amount),
                    source: 'manual'
                });
                setLoading(false);
                setActiveTab('list');
            };

            return (
                <div className="p-4 pb-24 max-w-lg mx-auto fade-in">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Nova Receita Manual</h2>
                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Data</label>
                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400"><Calendar size={20} /></div>
                                <input 
                                    type="date" required
                                    className="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"
                                    value={formData.date}
                                    onChange={(e) => setFormData({...formData, date: e.target.value})}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400"><FileText size={20} /></div>
                                <input 
                                    type="text" required placeholder="Ex: Venda para Laticínio X"
                                    className="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400"><DollarSign size={20} /></div>
                                <input 
                                    type="number" required step="0.01" min="0.01" placeholder="0,00"
                                    className="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none"
                                    value={formData.amount}
                                    onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                            <select 
                                className="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none appearance-none"
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                            >
                                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                            </select>
                        </div>

                        <button 
                            type="submit" disabled={loading}
                            className="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4 active:scale-95 transition-all disabled:opacity-70 flex items-center justify-center gap-2"
                        >
                            {loading ? 'Salvando...' : <><Check size={20} /> Salvar Receita</>}
                        </button>
                    </form>
                </div>
            );
        };

        // 3. Import CSV
        const ImportRevenue = ({ onBulkSave, setActiveTab }) => {
            const [csvData, setCsvData] = useState([]);
            const [dragActive, setDragActive] = useState(false);
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);

            const parseCSVLine = (text) => {
                const re_value = /(?!\s*$)\s*(?:'([^']*)'|"([^"]*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
                const a = [];
                text.replace(re_value, function(m0, m1, m2, m3) {
                    if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                    else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                    else if (m3 !== undefined) a.push(m3);
                    return '';
                });
                if (/,\s*$/.test(text)) a.push('');
                return a;
            };

            const handleFile = (file) => {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const parsedItems = [];
                    
                    lines.forEach((line, index) => {
                        if (!line.trim()) return;
                        const cols = parseCSVLine(line);
                        if (cols.length < 5) return;

                        let rawValue = cols[5];
                        if (!rawValue) return;
                        const cleanValue = parseFloat(rawValue);

                        if (!isNaN(cleanValue) && cleanValue > 0) {
                            const dateParts = cols[0].split('/');
                            let formattedDate = new Date().toISOString().split('T')[0];
                            if (dateParts.length === 3) {
                                formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                            }

                            parsedItems.push({
                                id: Date.now() + index,
                                date: formattedDate,
                                description: cols[2] || 'Sem descrição',
                                amount: cleanValue,
                                category: 'Outros',
                                selected: true
                            });
                        }
                    });

                    setCsvData(parsedItems);
                    if (parsedItems.length > 0) setStep(2);
                    else alert("Nenhuma receita (valor positivo) encontrada neste arquivo.");
                };
                reader.readAsText(file);
            };

            const updateItem = (id, field, value) => {
                setCsvData(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
            };

            const toggleSelect = (id) => {
                setCsvData(prev => prev.map(item => item.id === id ? { ...item, selected: !item.selected } : item));
            };

            const handleFinalImport = async () => {
                setLoading(true);
                const selectedItems = csvData.filter(i => i.selected).map(({ id, selected, ...rest }) => ({
                    ...rest, source: 'import'
                }));
                await onBulkSave(selectedItems);
                setLoading(false);
                setActiveTab('list');
            };

            if (step === 1) {
                return (
                    <div className="p-4 flex flex-col items-center justify-center min-h-[60vh] fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Importar Extrato</h2>
                        <p className="text-gray-500 text-center mb-8">Carregue o CSV do seu banco. <br/>O sistema filtrará apenas as entradas.</p>
                        
                        <label 
                            className="w-full max-w-sm aspect-video border-2 border-dashed border-emerald-300 rounded-2xl flex flex-col items-center justify-center bg-emerald-50 cursor-pointer hover:bg-emerald-100 transition-colors"
                            onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                            onDragLeave={() => setDragActive(false)}
                            onDrop={(e) => { e.preventDefault(); setDragActive(false); handleFile(e.dataTransfer.files[0]); }}
                        >
                            <Upload size={48} className="text-emerald-500 mb-4" />
                            <span className="font-semibold text-emerald-700">Toque para selecionar</span>
                            <span className="text-xs text-emerald-500 mt-2">ou arraste o arquivo aqui</span>
                            <input type="file" accept=".csv" className="hidden" onChange={(e) => handleFile(e.target.files[0])} />
                        </label>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    <div className="bg-white p-4 shadow-sm z-10">
                        <div className="flex justify-between items-center mb-2">
                            <h2 className="text-lg font-bold">Revisar Importação</h2>
                            <button onClick={() => setStep(1)} className="text-sm text-red-500">Cancelar</button>
                        </div>
                        <p className="text-xs text-gray-500">Desmarque os itens que não deseja importar ou edite.</p>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-32">
                        {csvData.map((item) => (
                            <div key={item.id} className={`bg-white p-3 rounded-xl border-2 transition-all ${item.selected ? 'border-emerald-500 shadow-sm' : 'border-gray-200 opacity-60'}`}>
                                <div className="flex items-start gap-3">
                                    <div onClick={() => toggleSelect(item.id)} className="pt-1 cursor-pointer">
                                        {item.selected ? 
                                            <div className="w-5 h-5 bg-emerald-500 rounded-md flex items-center justify-center text-white"><Check size={14} /></div> : 
                                            <div className="w-5 h-5 border-2 border-gray-300 rounded-md" />
                                        }
                                    </div>
                                    <div className="flex-1 space-y-2">
                                        <input 
                                            type="text" value={item.description}
                                            onChange={(e) => updateItem(item.id, 'description', e.target.value)}
                                            className="w-full font-medium text-gray-800 bg-transparent border-b border-dashed border-gray-300 focus:border-emerald-500 outline-none pb-1"
                                        />
                                        <div className="flex gap-2">
                                            <input 
                                                type="date" value={item.date}
                                                onChange={(e) => updateItem(item.id, 'date', e.target.value)}
                                                className="text-xs bg-gray-100 rounded px-2 py-1 text-gray-600 w-28"
                                            />
                                            <input 
                                                type="number" step="0.01" value={item.amount}
                                                onChange={(e) => updateItem(item.id, 'amount', parseFloat(e.target.value))}
                                                className="text-xs bg-emerald-50 text-emerald-700 font-bold rounded px-2 py-1 flex-1 text-right"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="fixed bottom-[80px] left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent">
                        <button 
                            onClick={handleFinalImport}
                            disabled={loading || csvData.filter(i => i.selected).length === 0}
                            className="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 active:scale-95 transition-transform"
                        >
                            {loading ? 'Importando...' : <><Save size={20} /> Importar {csvData.filter(i => i.selected).length} Receitas</>}
                        </button>
                    </div>
                </div>
            );
        };

        // 4. List Component
        const RevenueList = ({ revenues, onDelete, onUpdate }) => {
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [searchTerm, setSearchTerm] = useState('');

            const handleEditClick = (rev) => { setEditingId(rev.id); setEditForm(rev); };
            const handleSaveEdit = async () => { await onUpdate(editingId, editForm); setEditingId(null); };

            const filteredRevenues = revenues.filter(r => 
                r.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                r.category.toLowerCase().includes(searchTerm.toLowerCase())
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="flex flex-col h-full bg-gray-50 pb-20 fade-in">
                    <div className="bg-emerald-600 p-4 pb-6 rounded-b-3xl shadow-md z-10 sticky top-0">
                        <h2 className="text-xl font-bold text-white mb-4">Histórico</h2>
                        <div className="relative">
                            <div className="absolute left-3 top-3 text-emerald-700"><Search size={18} /></div>
                            <input 
                                type="text" placeholder="Buscar..." 
                                className="w-full pl-10 pr-4 py-2.5 bg-emerald-50 rounded-xl text-emerald-900 placeholder-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-300"
                                value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="p-4 space-y-3 overflow-y-auto">
                        {filteredRevenues.map((rev) => (
                            <div key={rev.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                                {editingId === rev.id ? (
                                    <div className="space-y-3">
                                        <input 
                                            type="text" value={editForm.description}
                                            onChange={(e) => setEditForm({...editForm, description: e.target.value})}
                                            className="w-full p-2 border rounded-lg"
                                        />
                                        <div className="flex gap-2">
                                            <input 
                                                type="date" value={editForm.date}
                                                onChange={(e) => setEditForm({...editForm, date: e.target.value})}
                                                className="w-1/2 p-2 border rounded-lg"
                                            />
                                            <input 
                                                type="number" value={editForm.amount}
                                                onChange={(e) => setEditForm({...editForm, amount: parseFloat(e.target.value)})}
                                                className="w-1/2 p-2 border rounded-lg text-right"
                                            />
                                        </div>
                                        <div className="flex justify-end gap-2 mt-2">
                                            <button onClick={() => setEditingId(null)} className="p-2 bg-gray-200 rounded-lg"><X size={18} /></button>
                                            <button onClick={handleSaveEdit} className="p-2 bg-emerald-600 text-white rounded-lg"><Check size={18} /></button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <p className="font-bold text-gray-800">{rev.description}</p>
                                            <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                                <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600">{formatDate(rev.date)}</span>
                                                <span>{rev.category}</span>
                                                {rev.source === 'import' && <span className="text-emerald-500 font-medium">Auto</span>}
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-end gap-2">
                                            <span className="font-bold text-emerald-600 text-lg">{formatCurrency(rev.amount)}</span>
                                            <div className="flex gap-3">
                                                <button onClick={() => handleEditClick(rev)} className="text-gray-400 hover:text-emerald-600"><Edit2 size={16} /></button>
                                                <button onClick={() => onDelete(rev.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [user, setUser] = useState(null);
            const [revenues, setRevenues] = useState([]);
            const [loading, setLoading] = useState(true);

            // Listener de Autenticação
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const q = query(collection(db, 'artifacts', appId, 'users', u.uid, 'farm_revenues'), orderBy('date', 'desc'));
                        onSnapshot(q, (snap) => {
                            setRevenues(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                            setLoading(false);
                        });
                    } else {
                        setRevenues([]);
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // CRUD Actions
            const addRevenue = async (data) => user && addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'farm_revenues'), { ...data, createdAt: serverTimestamp() });
            
            const addBulkRevenue = async (items) => {
                if (!user) return;
                const batchPromises = items.map(item => 
                    addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'farm_revenues'), {
                        date: item.date, description: item.description, amount: item.amount,
                        category: item.category, source: 'import', createdAt: serverTimestamp()
                    })
                );
                await Promise.all(batchPromises);
            };

            const updateRevenue = async (id, data) => user && updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'farm_revenues', id), data);
            
            const deleteRevenue = async (id) => {
                if (user && confirm('Tem certeza?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'farm_revenues', id));
            };

            // Loading Screen
            if (loading) return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-emerald-50 text-emerald-600">
                    <Sprout className="animate-bounce mb-4" size={48} />
                    <span className="font-bold">Carregando Fazenda WM...</span>
                </div>
            );

            // Auth Screen Check
            if (!user) {
                return <AuthScreen />;
            }

            // App Logado
            return (
                <div className="h-screen w-full flex flex-col font-sans overflow-hidden">
                    <main className="flex-1 overflow-y-auto">
                        {activeTab === 'home' && <Dashboard revenues={revenues} setActiveTab={setActiveTab} />}
                        {activeTab === 'add' && <AddRevenue onSave={addRevenue} setActiveTab={setActiveTab} />}
                        {activeTab === 'import' && <ImportRevenue onBulkSave={addBulkRevenue} setActiveTab={setActiveTab} />}
                        {activeTab === 'list' && <RevenueList revenues={revenues} onDelete={deleteRevenue} onUpdate={updateRevenue} />}
                    </main>

                    <nav className="bg-white border-t border-gray-200 fixed bottom-0 w-full pb-safe z-50">
                        <div className="flex justify-around items-center h-16">
                            {[
                                { id: 'home', icon: Home, label: 'Início' },
                                { id: 'add', icon: PlusCircle, label: 'Novo' },
                                { id: 'import', icon: Upload, label: 'CSV' },
                                { id: 'list', icon: List, label: 'Histórico' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                    className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab ===(tab.id) ? 'text-emerald-600' : 'text-gray-400'}`}
                                >
                                    <tab.icon size={22} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                                    <span className="text-[10px] font-medium">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
