<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fazenda WM - Gestão Completa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para traduzir o React no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuração para evitar zoom no input em iOS e estilos globais -->
    <style>
        @layer utilities {
            .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        }
        input, select, textarea { font-size: 16px !important; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Barra de progresso para o balanço */
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 select-none">
    <div id="root"></div>

    <!-- Script Principal da Aplicação -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            PlusCircle, Upload, Home, List, Trash2, Edit2, Save, X, Check, 
            DollarSign, FileText, Calendar, Search, ArrowUpCircle, ArrowDownCircle,
            LogOut, User, Lock, Sprout, TrendingUp, TrendingDown, PieChart, Info,
            Filter, Settings, Tag, Zap, ChevronLeft, ChevronRight, AlertCircle, AlertTriangle, Ban,
            Scale, CheckCircle2, XCircle, Database, ChevronDown, ChevronUp, Eye, Bug
        } from 'https://esm.sh/lucide-react@0.292.0';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, 
            query, orderBy, serverTimestamp, setDoc, where, getDocs 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURAÇÃO (PROJETO UNIFICADO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appNamespace = 'fazenda-wm-integrada'; // Dados novos (receitas/despesas csv)

        // --- Utilitários ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        // --- Default Config ---
        const defaultConfig = {
            revenueCats: ['Venda de Leite', 'Venda de Animais', 'Venda de Queijo', 'Serviços', 'Outros'],
            expenseCats: ['Ração/Sal', 'Medicamentos', 'Manutenção', 'Energia', 'Mão de Obra', 'Combustível', 'Outros'],
            rules: [
                { keyword: 'MARCELIO', category: 'Venda de Leite', type: 'revenue' },
                { keyword: 'CDB', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'RESGATE', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'INVESTIMENTO', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'APLICAÇÃO', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'SALDO', category: 'IGNORAR', type: 'revenue' }
            ]
        };

        // --- Componente: Tela de Login ---
        const AuthScreen = () => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error("Erro auth:", err);
                    let msg = "Erro desconhecido: " + err.code;
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') msg = "Email ou senha incorretos.";
                    else if (err.code === 'auth/operation-not-allowed') msg = "Erro de Configuração: Ative 'Email/Senha' no Firebase Console.";
                    setError(msg);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-800 to-green-900 text-white">
                    <div className="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-gray-800 fade-in">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-emerald-100 p-4 rounded-full mb-3">
                                <Sprout size={40} className="text-emerald-700" />
                            </div>
                            <h1 className="text-2xl font-bold text-emerald-900">Fazenda WM</h1>
                            <p className="text-sm font-medium text-emerald-600 uppercase tracking-wide mt-1">{isRegistering ? 'Criar Nova Conta' : 'Acessar Sistema'}</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Email</label>
                                <input type="email" required placeholder="seu@email.com" className="w-full px-4 py-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Senha</label>
                                <input type="password" required minLength={6} placeholder="******" className="w-full px-4 py-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            {error && <div className="bg-red-50 border border-red-100 p-3 rounded-xl text-red-600 text-xs">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-emerald-700 hover:bg-emerald-800 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 disabled:opacity-70">{loading ? 'Processando...' : (isRegistering ? 'Confirmar' : 'Entrar')}</button>
                        </form>
                        <div className="mt-6 pt-6 border-t border-gray-100 text-center">
                            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-emerald-700 text-sm font-semibold hover:underline">{isRegistering ? 'Já tenho conta' : 'Criar conta'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente: Painel de Balanço ---
        const BalancePanel = ({ revenues, expenses }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const totalRev = revenues.reduce((acc, curr) => acc + Number(curr.amount), 0);
            const totalExp = expenses.reduce((acc, curr) => acc + Number(curr.amount), 0);
            const balance = totalRev - totalExp;
            
            const changeMonth = (offset) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + offset); setViewDate(d); };
            const currentMonth = viewDate.getMonth();
            const currentYear = viewDate.getFullYear();
            
            const monthRev = revenues.filter(r => { const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((acc, curr) => acc + Number(curr.amount), 0);
            const monthExp = expenses.filter(r => { const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((acc, curr) => acc + Number(curr.amount), 0);
            const monthBalance = monthRev - monthExp;
            const totalVolume = totalRev + totalExp;
            const revPercent = totalVolume > 0 ? (totalRev / totalVolume) * 100 : 50;
            const monthLabel = viewDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            const monthLabelFormatted = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            if (totalVolume === 0) return (
                <div className="h-full flex flex-col items-center justify-center p-8 fade-in text-center">
                    <div className="bg-emerald-100 p-6 rounded-full mb-6"><Upload size={48} className="text-emerald-600" /></div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">Bem-vindo!</h2>
                    <p className="text-gray-500 mb-8 max-w-xs">Comece importando seu extrato bancário nas abas abaixo.</p>
                    <button onClick={() => signOut(auth)} className="mt-8 text-emerald-600 font-bold text-sm">Sair</button>
                </div>
            );

            return (
                <div className="space-y-6 pb-24 fade-in">
                    <header className="bg-gray-900 text-white p-6 rounded-b-3xl shadow-lg relative overflow-hidden">
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <div><h1 className="text-2xl font-bold">Balanço Geral</h1><p className="text-gray-400 text-sm">Resumo Financeiro</p></div>
                            <button onClick={() => signOut(auth)} className="bg-white/10 p-2 rounded-lg hover:bg-white/20"><LogOut size={18} /></button>
                        </div>
                        <div className="bg-white/10 backdrop-blur-md p-5 rounded-2xl border border-white/10 relative z-10">
                            <span className="text-gray-400 text-xs uppercase tracking-wider">Saldo Acumulado</span>
                            <div className={`text-4xl font-bold mt-1 ${balance >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(balance)}</div>
                            <div className="mt-4 flex gap-4">
                                <div className="flex-1"><div className="flex items-center gap-1 text-emerald-400 text-xs mb-1"><ArrowUpCircle size={12} /> Receitas</div><div className="font-semibold text-lg">{formatCurrency(totalRev)}</div></div>
                                <div className="w-px bg-white/20"></div>
                                <div className="flex-1"><div className="flex items-center gap-1 text-red-400 text-xs mb-1"><ArrowDownCircle size={12} /> Despesas</div><div className="font-semibold text-lg">{formatCurrency(totalExp)}</div></div>
                            </div>
                        </div>
                    </header>
                    <div className="px-6">
                        <h3 className="text-gray-600 font-bold mb-3 flex items-center gap-2"><PieChart size={18}/> Proporção</h3>
                        <div className="h-4 bg-gray-200 rounded-full overflow-hidden flex">
                            <div className="h-full bg-emerald-500 progress-bar" style={{width: `${revPercent}%`}}></div>
                            <div className="h-full bg-red-500 progress-bar" style={{width: `${100 - revPercent}%`}}></div>
                        </div>
                    </div>
                    <div className="px-6">
                        <div className="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-gray-100 mb-4">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-xl text-gray-600"><ChevronLeft size={20}/></button>
                            <span className="font-bold text-gray-800 text-sm uppercase tracking-wide">{monthLabelFormatted}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-xl text-gray-600"><ChevronRight size={20}/></button>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center"><p className="text-xs text-gray-500">Entradas</p><p className="font-bold text-emerald-600 text-lg">{formatCurrency(monthRev)}</p></div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center"><p className="text-xs text-gray-500">Saídas</p><p className="font-bold text-red-600 text-lg">{formatCurrency(monthExp)}</p></div>
                        </div>
                        <div className={`mt-3 p-3 rounded-xl border flex justify-between items-center ${monthBalance >= 0 ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-red-50 border-red-100 text-red-700'}`}>
                            <span className="text-sm font-semibold">Resultado Mês</span><span className="font-bold">{formatCurrency(monthBalance)}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente: Conciliação Inteligente (Comparação Direta de DBs) ---
        const ReconciliationTool = ({ oldSystemExpenses, newSystemExpenses }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const [analysis, setAnalysis] = useState(null);
            const [expandedDay, setExpandedDay] = useState(null);
            const [debugMode, setDebugMode] = useState(false); // DEBUG TOGGLE
            
            const changeMonth = (offset) => {
                const d = new Date(viewDate);
                d.setMonth(d.getMonth() + offset);
                setViewDate(d);
                setExpandedDay(null);
            };

            const currentMonthLabel = viewDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            const monthLabelFormatted = currentMonthLabel.charAt(0).toUpperCase() + currentMonthLabel.slice(1);

            useEffect(() => {
                // Executa a análise sempre que os dados ou a data mudam
                analyze(newSystemExpenses, oldSystemExpenses);
            }, [viewDate, newSystemExpenses, oldSystemExpenses]);

            const analyze = (newSys, oldSys) => {
                const currentMonth = viewDate.getMonth();
                const currentYear = viewDate.getFullYear();

                // 1. Filtrar ambos os sistemas pelo mês selecionado
                const bankItems = newSys.filter(item => {
                    const d = new Date(item.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const manualItems = oldSys.filter(item => {
                    let d;
                    // Tratamento robusto de data do sistema antigo
                    if (item.date && item.date.seconds) d = new Date(item.date.seconds * 1000); 
                    else if (item.date) d = new Date(item.date);
                    else return false;
                    
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                // Se não tiver dados no sistema novo (banco), não tem como conciliar
                if (bankItems.length === 0) {
                    setAnalysis(null);
                    return;
                }

                // 2. Agrupamento por Dia
                const dailyData = {};
                const allDates = new Set();

                const getDateStr = (item) => {
                    if (item.date && item.date.seconds) {
                        return new Date(item.date.seconds * 1000).toISOString().split('T')[0];
                    }
                    return item.date; // Assumindo YYYY-MM-DD
                }

                bankItems.forEach(item => {
                    const dStr = getDateStr(item);
                    allDates.add(dStr);
                    if (!dailyData[dStr]) dailyData[dStr] = { bank: [], manual: [] };
                    dailyData[dStr].bank.push(item);
                });

                manualItems.forEach(item => {
                    const dStr = getDateStr(item);
                    allDates.add(dStr);
                    if (!dailyData[dStr]) dailyData[dStr] = { bank: [], manual: [] };
                    dailyData[dStr].manual.push(item);
                });

                // 3. Comparação Diária
                const dailyReports = Array.from(allDates).sort().map(date => {
                    const dayData = dailyData[date];
                    const bankTotal = dayData.bank.reduce((sum, i) => sum + Number(i.amount), 0);
                    // O sistema antigo pode ter 'valor' em vez de 'amount' e pode ser string
                    const manualTotal = dayData.manual.reduce((sum, i) => sum + Number(i.amount || i.valor || 0), 0); 
                    const diff = bankTotal - manualTotal;

                    return {
                        date,
                        bankTotal,
                        manualTotal,
                        diff,
                        bankItems: dayData.bank,
                        manualItems: dayData.manual,
                        isMatch: Math.abs(diff) < 0.05 
                    };
                });

                const totalBank = dailyReports.reduce((acc, d) => acc + d.bankTotal, 0);
                const totalManual = dailyReports.reduce((acc, d) => acc + d.manualTotal, 0);
                const totalDiff = totalBank - totalManual;

                setAnalysis({
                    monthly: { bank: totalBank, manual: totalManual, diff: totalDiff },
                    daily: dailyReports,
                    debugManualCount: manualItems.length // Debug info
                });
            };

            const addMissingItem = async (item) => {
                await onAddMissing({
                    date: item.date,
                    description: item.description,
                    amount: item.amount,
                    category: 'Outros', 
                    type: 'expense',
                    source: 'reconciliation'
                });
                alert("Item adicionado! A página atualizará em breve.");
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    <div className="bg-purple-800 p-4 pt-6 pb-2 text-white sticky top-0 z-20">
                        <div className="flex items-center justify-between mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2"><Scale size={24}/> Conciliação</h1>
                            <div className="flex items-center gap-2 bg-purple-900/50 p-1 rounded-lg">
                                <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-white/10 rounded"><ChevronLeft size={20}/></button>
                                <span className="text-sm font-bold w-28 text-center">{monthLabelFormatted}</span>
                                <button onClick={() => changeMonth(1)} className="p-1 hover:bg-white/10 rounded"><ChevronRight size={20}/></button>
                            </div>
                        </div>
                    </div>

                    {!analysis ? (
                        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center opacity-60">
                            <div className="bg-purple-100 p-4 rounded-full mb-4"><Database size={32} className="text-purple-600" /></div>
                            <p className="text-gray-500 text-sm mb-2 font-bold">Sem dados bancários para este mês.</p>
                            <p className="text-gray-400 text-xs">Vá em "Despesas" > "Importar CSV" para carregar o extrato do banco deste período.</p>
                            {/* Debug Trigger */}
                            <button onClick={() => setDebugMode(!debugMode)} className="mt-8 text-xs text-purple-400 underline">Debug</button>
                            {debugMode && (
                                <div className="mt-4 text-left text-xs bg-gray-100 p-2 rounded overflow-auto max-h-40 w-full border border-gray-300">
                                    <p>Total Banco Antigo Carregado: {oldSystemExpenses.length}</p>
                                    <p>Primeiro Item Antigo: {JSON.stringify(oldSystemExpenses[0] || 'N/A')}</p>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto pb-24">
                            {/* Resumo do Mês */}
                            <div className="bg-purple-700 text-white p-4 pt-0 pb-6 rounded-b-3xl shadow-lg mb-4">
                                <div className="flex gap-4 mb-4">
                                    <div className="flex-1">
                                        <span className="text-[10px] uppercase text-purple-200">Total Banco</span>
                                        <div className="text-xl font-bold">{formatCurrency(analysis.monthly.bank)}</div>
                                    </div>
                                    <div className="w-px bg-white/20"></div>
                                    <div className="flex-1">
                                        <span className="text-[10px] uppercase text-purple-200">Total Manual <span className="text-purple-300">({analysis.debugManualCount} itens)</span></span>
                                        <div className="text-xl font-bold">{formatCurrency(analysis.monthly.manual)}</div>
                                    </div>
                                </div>
                                <div className={`p-3 rounded-xl flex items-center justify-between ${Math.abs(analysis.monthly.diff) > 0.05 ? 'bg-red-500/20 text-red-100 border border-red-400/30' : 'bg-green-500/20 text-green-100 border border-green-400/30'}`}>
                                    <span className="text-xs font-bold uppercase flex items-center gap-1">
                                        {Math.abs(analysis.monthly.diff) > 0.05 ? <AlertCircle size={14}/> : <CheckCircle2 size={14}/>} 
                                        Diferença Mensal
                                    </span>
                                    <span className="font-bold text-lg">{formatCurrency(analysis.monthly.diff)}</span>
                                </div>
                            </div>

                            {/* Lista de Dias */}
                            <div className="px-4 space-y-3">
                                {analysis.daily.filter(day => !day.isMatch).length === 0 && (
                                    <div className="text-center py-8 text-gray-400 bg-white rounded-xl shadow-sm border border-gray-100">
                                        <CheckCircle2 size={48} className="mx-auto text-emerald-400 mb-2"/>
                                        <p className="font-bold text-emerald-600">Parabéns!</p>
                                        <p className="text-xs">Todos os dias bateram perfeitamente.</p>
                                    </div>
                                )}

                                {analysis.daily.map((day) => {
                                    if (day.isMatch) return null; 
                                    
                                    const isExpanded = expandedDay === day.date;
                                    const diffColor = day.diff > 0 ? 'text-red-600' : 'text-yellow-600'; 
                                    
                                    return (
                                        <div key={day.date} className={`bg-white rounded-xl shadow-sm border ${day.diff > 0 ? 'border-red-200' : 'border-yellow-200'} overflow-hidden`}>
                                            <div 
                                                onClick={() => setExpandedDay(isExpanded ? null : day.date)}
                                                className={`p-3 flex items-center justify-between cursor-pointer transition-colors ${day.diff > 0 ? 'bg-red-50 hover:bg-red-100' : 'bg-yellow-50 hover:bg-yellow-100'}`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-white/80 font-bold px-2 py-1 rounded text-xs text-center w-12 border border-gray-200 shadow-sm text-gray-700">
                                                        {day.date.split('-')[2]}/{day.date.split('-')[1]}
                                                    </div>
                                                    <div>
                                                        <div className="text-[10px] text-gray-500 font-bold uppercase tracking-wide">Diferença</div>
                                                        <div className={`font-bold ${diffColor}`}>{formatCurrency(day.diff)}</div>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-[10px] text-gray-400">Banco vs Manual</div>
                                                    <div className="text-xs font-medium text-gray-600">
                                                        {formatCurrency(day.bankTotal)} vs {formatCurrency(day.manualTotal)}
                                                    </div>
                                                </div>
                                                {isExpanded ? <ChevronUp size={16} className="text-gray-400"/> : <ChevronDown size={16} className="text-gray-400"/>}
                                            </div>

                                            {isExpanded && (
                                                <div className="p-3 bg-white text-xs border-t border-gray-100">
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <h4 className="font-bold text-gray-500 mb-2 uppercase text-[10px] flex items-center gap-1"><Database size={10}/> Banco (Novo)</h4>
                                                            <div className="space-y-1">
                                                                {day.bankItems.map((item, i) => (
                                                                    <div key={i} className="flex justify-between border-b border-gray-50 pb-1 last:border-0">
                                                                        <span className="truncate w-14 text-gray-600" title={item.description}>{item.description}</span>
                                                                        <span className="font-bold">{formatCurrency(item.amount)}</span>
                                                                    </div>
                                                                ))}
                                                                {day.bankItems.length === 0 && <span className="text-gray-300 italic">-</span>}
                                                            </div>
                                                        </div>
                                                        <div className="border-l border-gray-100 pl-4">
                                                            <h4 className="font-bold text-gray-500 mb-2 uppercase text-[10px] flex items-center gap-1"><FileText size={10}/> Manual (Antigo)</h4>
                                                            <div className="space-y-1">
                                                                {day.manualItems.map((item, i) => (
                                                                    <div key={i} className="flex justify-between border-b border-gray-50 pb-1 last:border-0">
                                                                        <span className="truncate w-14 text-gray-600" title={item.description || item.descricao}>{item.description || item.descricao}</span>
                                                                        <span className="font-medium text-gray-500">{formatCurrency(item.amount || item.valor)}</span>
                                                                    </div>
                                                                ))}
                                                                {day.manualItems.length === 0 && <span className="text-gray-300 italic">-</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Componente: Configurações ---
        const SettingsPanel = ({ config, onUpdateConfig }) => {
            const [view, setView] = useState('categories');
            const [newItem, setNewItem] = useState('');
            const [newRule, setNewRule] = useState({ keyword: '', category: '', type: 'revenue' });

            const addCategory = (type) => {
                if (!newItem.trim()) return;
                const field = type === 'revenue' ? 'revenueCats' : 'expenseCats';
                const newCats = [...config[field], newItem.trim()];
                onUpdateConfig({ ...config, [field]: newCats });
                setNewItem('');
            };
            const removeCategory = (type, cat) => {
                if(!confirm(`Remover?`)) return;
                const field = type === 'revenue' ? 'revenueCats' : 'expenseCats';
                onUpdateConfig({ ...config, [field]: config[field].filter(c => c !== cat) });
            };
            const addRule = () => {
                if (!newRule.keyword || !newRule.category) return;
                onUpdateConfig({ ...config, rules: [...config.rules, { ...newRule, keyword: newRule.keyword.toUpperCase() }] });
                setNewRule({ ...newRule, keyword: '' });
            };
            const removeRule = (idx) => onUpdateConfig({ ...config, rules: config.rules.filter((_, i) => i !== idx) });

            return (
                <div className="pb-24 fade-in bg-gray-50 min-h-full">
                     <header className="bg-gray-800 text-white p-6 rounded-b-3xl shadow-lg mb-6">
                        <h1 className="text-2xl font-bold flex items-center gap-2"><Settings size={24}/> Ajustes</h1>
                        <div className="flex mt-6 bg-gray-700/50 p-1 rounded-xl">
                            <button onClick={() => setView('categories')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${view === 'categories' ? 'bg-emerald-500 text-white shadow' : 'text-gray-300'}`}>Categorias</button>
                            <button onClick={() => setView('rules')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${view === 'rules' ? 'bg-emerald-500 text-white shadow' : 'text-gray-300'}`}>Automação</button>
                        </div>
                    </header>
                    {view === 'categories' && (
                        <div className="px-4 space-y-6">
                            {/* Simplificado para brevidade, lógica mantida */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-emerald-700 mb-3 flex items-center gap-2">Receitas</h3>
                                <div className="flex gap-2 mb-3"><input className="flex-1 border rounded px-2 text-sm" value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nova..." /><button onClick={() => addCategory('revenue')} className="bg-emerald-600 text-white px-3 rounded font-bold">+</button></div>
                                <div className="flex flex-wrap gap-2">{config.revenueCats.map(c => <span key={c} className="bg-emerald-50 text-emerald-800 text-xs px-2 py-1 rounded border border-emerald-100 flex gap-1 items-center">{c}<button onClick={() => removeCategory('revenue', c)}><X size={10}/></button></span>)}</div>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-red-700 mb-3 flex items-center gap-2">Despesas</h3>
                                <div className="flex gap-2 mb-3"><input className="flex-1 border rounded px-2 text-sm" value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nova..." /><button onClick={() => addCategory('expense')} className="bg-red-600 text-white px-3 rounded font-bold">+</button></div>
                                <div className="flex flex-wrap gap-2">{config.expenseCats.map(c => <span key={c} className="bg-red-50 text-red-800 text-xs px-2 py-1 rounded border border-red-100 flex gap-1 items-center">{c}<button onClick={() => removeCategory('expense', c)}><X size={10}/></button></span>)}</div>
                            </div>
                        </div>
                    )}
                    {view === 'rules' && (
                        <div className="px-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="space-y-3 mb-6 bg-gray-50 p-3 rounded-xl border border-gray-200">
                                    <div className="flex gap-2"><select className="bg-white border rounded text-xs w-20" value={newRule.type} onChange={e => setNewRule({...newRule, type: e.target.value, category: ''})}><option value="revenue">Receita</option><option value="expense">Despesa</option></select><input className="flex-1 border rounded px-2 text-xs" placeholder="Palavra Chave" value={newRule.keyword} onChange={e => setNewRule({...newRule, keyword: e.target.value})} /></div>
                                    <div className="flex gap-2"><select className="flex-1 bg-white border rounded text-xs" value={newRule.category} onChange={e => setNewRule({...newRule, category: e.target.value})}><option value="">Categoria...</option><option value="IGNORAR" className="text-red-600 font-bold">⛔ IGNORAR</option>{(newRule.type === 'revenue' ? config.revenueCats : config.expenseCats).map(c => <option key={c} value={c}>{c}</option>)}</select><button onClick={addRule} className="bg-gray-800 text-white px-3 rounded text-xs font-bold">Add</button></div>
                                </div>
                                <div className="space-y-2">{config.rules.map((r, i) => <div key={i} className="flex justify-between items-center p-2 border rounded bg-gray-50 text-xs"><span><b>"{r.keyword}"</b> &rarr; {r.category}</span><button onClick={() => removeRule(i)} className="text-red-500"><Trash2 size={14}/></button></div>)}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Componente: Lista e Ações (Mantido) ---
        const TransactionManager = ({ type, data, onAdd, onImport, onDelete, onUpdate, config }) => {
            const [view, setView] = useState('list');
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], description: '', amount: '', category: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [editItem, setEditItem] = useState(null);
            const isRevenue = type === 'revenue';
            const themeColor = isRevenue ? 'emerald' : 'red';
            const categories = isRevenue ? config.revenueCats : config.expenseCats;
            const filteredData = data.filter(item => item.description.toLowerCase().includes(searchTerm.toLowerCase()) || (item.category && item.category.toLowerCase().includes(searchTerm.toLowerCase()))).sort((a, b) => new Date(b.date) - new Date(a.date));

            const handleSubmit = async (e) => { e.preventDefault(); await onAdd({ ...formData, amount: parseFloat(formData.amount), type, category: formData.category || 'Outros' }); setFormData({ date: new Date().toISOString().split('T')[0], description: '', amount: '', category: '' }); setView('list'); };
            const [csvItems, setCsvItems] = useState([]);
            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n'); const parsed = [];
                    lines.forEach((line, idx) => {
                        if (!line.trim()) return;
                        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g, '').trim());
                        if (cols.length < 5) return;
                        let val = parseFloat(cols[cols.length - 1] || cols[5]);
                        const isValid = isRevenue ? (val > 0) : (val < 0);
                        if (!isNaN(val) && isValid) {
                            const descOriginal = cols[2] || 'Sem descrição';
                            const descUpper = descOriginal.toUpperCase();
                            if (isRevenue && (descUpper.includes('CDB') || descUpper.includes('RESGATE') || descUpper.includes('INVESTIMENTO'))) return;
                            
                            let autoCategory = 'Importado';
                            const matchedRule = config.rules.find(r => r.type === type && descUpper.includes(r.keyword));
                            if (matchedRule) { if (matchedRule.category === 'IGNORAR') return; autoCategory = matchedRule.category; }
                            
                            const dParts = cols[0].split('/');
                            const dateIso = dParts.length === 3 ? `${dParts[2]}-${dParts[1]}-${dParts[0]}` : new Date().toISOString().split('T')[0];
                            const isDuplicate = data.some(existing => existing.date === dateIso && existing.description === descOriginal && Math.abs(existing.amount) === Math.abs(val));
                            parsed.push({ id: Date.now() + idx, date: dateIso, description: descOriginal, amount: Math.abs(val), category: autoCategory, selected: !isDuplicate, isDuplicate });
                        }
                    });
                    setCsvItems(parsed);
                };
                reader.readAsText(file, 'ISO-8859-1');
            };

            if (view === 'add') return (
                <div className="p-4 pb-24 fade-in">
                    <div className="flex items-center gap-2 mb-6"><button onClick={() => setView('list')} className="p-2 bg-gray-100 rounded-full"><X size={20}/></button><h2 className="text-2xl font-bold text-gray-800">Nova {isRevenue ? 'Receita' : 'Despesa'}</h2></div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Descrição</label><input required className="w-full p-3 border rounded-xl" placeholder="Ex: Ração" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                        <div className="flex gap-3"><div className="w-1/2"><label className="text-xs font-bold text-gray-500 uppercase">Valor</label><input type="number" step="0.01" required className="w-full p-3 border rounded-xl" placeholder="0,00" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} /></div><div className="w-1/2"><label className="text-xs font-bold text-gray-500 uppercase">Data</label><input type="date" required className="w-full p-3 border rounded-xl" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} /></div></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Categoria</label><select className="w-full p-3 border rounded-xl bg-white" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}><option value="">Selecione...</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                        <button type="submit" className={`w-full py-4 rounded-xl text-white font-bold shadow-lg mt-4 bg-${themeColor}-600`}>Salvar</button>
                    </form>
                </div>
            );

            if (view === 'import') return (
                <div className="p-4 pb-24 fade-in h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">Importar CSV</h2><button onClick={() => { setView('list'); setCsvItems([]); }} className="text-gray-500">Cancelar</button></div>
                    {csvItems.length === 0 ? (
                        <div className="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50"><Upload size={48} className="text-gray-400 mb-2"/><p className="text-gray-500 text-sm mb-4">Selecione o extrato</p><input type="file" accept=".csv" onChange={e => handleFile(e.target.files[0])} /></div>
                    ) : (
                        <>
                            <div className="flex-1 overflow-y-auto space-y-2 mb-4">{csvItems.map((item, idx) => (
                                <div key={idx} className={`p-3 border rounded-lg flex gap-3 ${item.selected ? `border-${themeColor}-500 bg-${themeColor}-50` : 'border-gray-200 opacity-50'}`}><input type="checkbox" checked={item.selected} onChange={() => { const n = [...csvItems]; n[idx].selected = !n[idx].selected; setCsvItems(n); }} /><div className="flex-1"><div className="flex justify-between font-bold text-sm"><span>{item.description}</span><span>{formatCurrency(item.amount)}</span></div><div className="flex justify-between items-center mt-1"><span className="text-xs text-gray-500">{formatDate(item.date)}</span>{item.isDuplicate && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><AlertCircle size={10} /> Duplicado</span>}<span className={`text-[10px] px-2 py-0.5 rounded-full ${item.category !== 'Importado' ? 'bg-blue-100 text-blue-700 font-bold' : 'bg-gray-100 text-gray-500'}`}>{item.category}</span></div></div></div>
                            ))}</div>
                            <button onClick={async () => { const toImport = csvItems.filter(i => i.selected).map(({id, selected, isDuplicate, ...rest}) => ({...rest, type, source: 'import'})); await onImport(toImport); setView('list'); setCsvItems([]); }} disabled={csvItems.filter(i => i.selected).length === 0} className={`w-full py-3 rounded-xl text-white font-bold shadow bg-${themeColor}-600 disabled:opacity-50`}>Confirmar ({csvItems.filter(i => i.selected).length})</button>
                        </>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    <header className={`bg-${themeColor}-600 text-white p-6 pb-8 rounded-b-3xl shadow-lg sticky top-0 z-10`}>
                        <div className="flex justify-between items-center mb-4"><h1 className="text-2xl font-bold">{isRevenue ? 'Receitas' : 'Despesas'}</h1><div className="flex gap-2"><button onClick={() => setView('import')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Importar"><Upload size={20}/></button><button onClick={() => setView('add')} className="bg-white text-gray-900 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm active:scale-95 transition"><PlusCircle size={18}/> Novo</button></div></div>
                        <div className="relative"><Search className={`absolute left-3 top-3 text-${themeColor}-200`} size={18} /><input type="text" placeholder="Buscar..." className={`w-full pl-10 pr-4 py-2.5 bg-${themeColor}-700 rounded-xl text-white placeholder-${themeColor}-300 focus:outline-none focus:ring-2 focus:ring-white/50`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                    </header>
                    <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-3">
                        {filteredData.length === 0 ? <div className="text-center py-10 text-gray-400"><p className="mb-2">Nenhum registro.</p><button onClick={() => setView('import')} className={`text-sm text-${themeColor}-600 font-bold underline`}>Importar</button></div> : filteredData.map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                {editItem === item.id ? (
                                    <div className="flex-1 flex gap-2"><input className="border rounded px-2 py-1 w-full" value={item.description} onChange={(e) => onUpdate(item.id, { description: e.target.value })} /><input type="number" className="border rounded px-2 py-1 w-24" value={item.amount} onChange={(e) => onUpdate(item.id, { amount: parseFloat(e.target.value) })} /><button onClick={() => setEditItem(null)} className="p-2 bg-green-100 text-green-700 rounded"><Check size={16}/></button></div>
                                ) : (
                                    <><div className="flex-1"><h3 className="font-bold text-gray-800">{item.description}</h3><div className="flex items-center gap-2 text-xs text-gray-500 mt-1"><span className="bg-gray-100 px-2 py-0.5 rounded">{formatDate(item.date)}</span><span>{item.category}</span></div></div><div className="text-right"><div className={`font-bold text-lg text-${themeColor}-600`}>{formatCurrency(item.amount)}</div><div className="flex justify-end gap-3 mt-1"><button onClick={() => setEditItem(item.id)} className="text-gray-400 hover:text-blue-500"><Edit2 size={14}/></button><button onClick={() => onDelete(item.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={14}/></button></div></div></>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('balance');
            const [revenues, setRevenues] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [oldExpenses, setOldExpenses] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [config, setConfig] = useState(defaultConfig);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const qRev = query(collection(db, 'artifacts', appNamespace, 'users', u.uid, 'farm_revenues'), orderBy('date', 'desc'));
                        onSnapshot(qRev, (snap) => setRevenues(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                        const qExp = query(collection(db, 'artifacts', appNamespace, 'users', u.uid, 'farm_expenses'), orderBy('date', 'desc'));
                        onSnapshot(qExp, (snap) => setExpenses(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                        
                        // TENTA BUSCAR DADOS ANTIGOS - ESTRATÉGIA DE FORÇA BRUTA (DEBUG)
                        // 1. Tenta direto na raiz 'despesas'
                        const qRoot = query(collection(db, 'despesas'));
                        
                        // 2. Tenta em 'users/{uid}/despesas'
                        const qUser = query(collection(db, 'users', u.uid, 'despesas'));

                        // Executa ambas e pega o que vier (prioridade para a que tiver dados)
                        getDocs(qRoot).then(snapRoot => {
                            if (!snapRoot.empty) {
                                console.log("Dados encontrados na RAIZ 'despesas'", snapRoot.size);
                                setOldExpenses(snapRoot.docs.map(d => ({id: d.id, ...d.data()})));
                            } else {
                                console.log("Nada na raiz, tentando subcoleção do usuário...");
                                getDocs(qUser).then(snapUser => {
                                    if (!snapUser.empty) {
                                        console.log("Dados encontrados em 'users/uid/despesas'", snapUser.size);
                                        setOldExpenses(snapUser.docs.map(d => ({id: d.id, ...d.data()})));
                                    } else {
                                        console.warn("Nenhum dado antigo encontrado em lugar nenhum.");
                                        setOldExpenses([]);
                                    }
                                });
                            }
                        }).catch(err => console.error("Erro ao buscar dados antigos:", err));

                        onSnapshot(doc(db, 'artifacts', appNamespace, 'users', u.uid, 'config', 'main'), (snap) => {
                            if (snap.exists()) setConfig(snap.data());
                            else setDoc(doc(db, 'artifacts', appNamespace, 'users', u.uid, 'config', 'main'), defaultConfig);
                        });

                        setLoading(false);
                    } else {
                        setRevenues([]); setExpenses([]); setOldExpenses([]); setLoading(false);
                    }
                });
                return () => unsub();
            }, []);

            const addTransaction = async (data) => {
                const collName = data.type === 'revenue' ? 'farm_revenues' : 'farm_expenses';
                await addDoc(collection(db, 'artifacts', appNamespace, 'users', user.uid, collName), { ...data, createdAt: serverTimestamp() });
            };
            const addBulk = async (items) => { const batch = items.map(item => addDoc(collection(db, 'artifacts', appNamespace, 'users', user.uid, item.type === 'revenue' ? 'farm_revenues' : 'farm_expenses'), { ...item, createdAt: serverTimestamp() })); await Promise.all(batch); };
            const deleteTransaction = async (id, type) => { if(!confirm('Tem certeza?')) return; await deleteDoc(doc(db, 'artifacts', appNamespace, 'users', user.uid, type === 'revenue' ? 'farm_revenues' : 'farm_expenses', id)); };
            const updateTransaction = async (id, data, type) => { await updateDoc(doc(db, 'artifacts', appNamespace, 'users', user.uid, type === 'revenue' ? 'farm_revenues' : 'farm_expenses', id), data); };
            const updateConfig = async (newConfig) => { setConfig(newConfig); await setDoc(doc(db, 'artifacts', appNamespace, 'users', user.uid, 'config', 'main'), newConfig); };

            if (loading) return <div className="h-screen w-full flex items-center justify-center text-emerald-800 font-bold bg-emerald-50">Carregando Sistema...</div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="h-screen w-full flex flex-col font-sans overflow-hidden bg-gray-50">
                    <main className="flex-1 overflow-y-auto">
                        {activeTab === 'balance' && <BalancePanel revenues={revenues} expenses={expenses} />}
                        {activeTab === 'reconcile' && <ReconciliationTool oldSystemExpenses={oldExpenses} newSystemExpenses={expenses} />}
                        {activeTab === 'revenues' && <TransactionManager type="revenue" data={revenues} onAdd={addTransaction} onImport={addBulk} onDelete={(id) => deleteTransaction(id, 'revenue')} onUpdate={(id, data) => updateTransaction(id, data, 'revenue')} config={config} />}
                        {activeTab === 'expenses' && <TransactionManager type="expense" data={expenses} onAdd={addTransaction} onImport={addBulk} onDelete={(id) => deleteTransaction(id, 'expense')} onUpdate={(id, data) => updateTransaction(id, data, 'expense')} config={config} />}
                        {activeTab === 'settings' && <SettingsPanel config={config} onUpdateConfig={updateConfig} />}
                    </main>
                    <nav className="bg-white border-t border-gray-200 fixed bottom-0 w-full pb-safe z-50">
                        <div className="flex justify-around items-center h-16">
                            <button onClick={() => setActiveTab('balance')} className={`flex flex-col items-center justify-center w-full ${activeTab === 'balance' ? 'text-gray-900' : 'text-gray-400'}`}><PieChart size={20} /><span className="text-[9px]">Balanço</span></button>
                            <button onClick={() => setActiveTab('revenues')} className={`flex flex-col items-center justify-center w-full ${activeTab === 'revenues' ? 'text-emerald-600' : 'text-gray-400'}`}><ArrowUpCircle size={20} /><span className="text-[9px]">Receitas</span></button>
                            <button onClick={() => setActiveTab('reconcile')} className={`flex flex-col items-center justify-center w-full ${activeTab === 'reconcile' ? 'text-purple-600' : 'text-gray-400'}`}><Scale size={24} strokeWidth={activeTab === 'reconcile' ? 2.5 : 2} /><span className="text-[9px] font-bold">Conciliar</span></button>
                            <button onClick={() => setActiveTab('expenses')} className={`flex flex-col items-center justify-center w-full ${activeTab === 'expenses' ? 'text-red-600' : 'text-gray-400'}`}><ArrowDownCircle size={20} /><span className="text-[9px]">Despesas</span></button>
                            <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center justify-center w-full ${activeTab === 'settings' ? 'text-blue-600' : 'text-gray-400'}`}><Settings size={20} /><span className="text-[9px]">Ajustes</span></button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
