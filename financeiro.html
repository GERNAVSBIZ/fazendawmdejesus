<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fazenda WM - Gestão Completa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para traduzir o React no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuração para evitar zoom no input em iOS e estilos globais -->
    <style>
        @layer utilities {
            .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        }
        input, select, textarea { font-size: 16px !important; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Barra de progresso para o balanço */
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 select-none">
    <div id="root"></div>

    <!-- Script Principal da Aplicação -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            PlusCircle, Upload, Home, List, Trash2, Edit2, Save, X, Check, 
            DollarSign, FileText, Calendar, Search, ArrowUpCircle, ArrowDownCircle,
            LogOut, User, Lock, Sprout, TrendingUp, TrendingDown, PieChart, Info,
            Filter, Settings, Tag, Zap, ChevronLeft, ChevronRight, AlertCircle, AlertTriangle, Ban,
            Scale, CheckCircle2, XCircle, Database, ChevronDown, ChevronUp, Eye, Bug
        } from 'https://esm.sh/lucide-react@0.292.0';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, 
            query, orderBy, serverTimestamp, setDoc, where, getDocs 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURAÇÃO (PROJETO UNIFICADO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appNamespace = 'fazenda-wm-integrada'; 

        // --- Componente de Proteção de Erro (Error Boundary) ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Erro no App:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-6 text-center">
                            <h1 className="text-xl font-bold text-red-600 mb-2">Ops! Ocorreu um erro.</h1>
                            <p className="text-sm text-gray-600 mb-4">Tente recarregar a página.</p>
                            <pre className="bg-gray-100 p-2 rounded text-xs text-left overflow-auto text-red-500 border border-red-200">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                            <button onClick={() => window.location.reload()} className="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg font-bold">Recarregar</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- Utilitários ---
        const formatCurrency = (value) => {
            if (value === null || value === undefined || isNaN(value)) return "R$ 0,00";
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        // --- LÓGICA INTELIGENTE DE EXTRAÇÃO DE DATA ---
        const extractRealDateFromDescription = (postingDateIso, description) => {
            try {
                // Procura padrão dd/mm na descrição (ex: 05/10)
                const dateMatch = description.match(/(\d{2})\/(\d{2})/);
                
                if (dateMatch) {
                    const extractedDay = parseInt(dateMatch[1]);
                    const extractedMonth = parseInt(dateMatch[2]);
                    
                    const postingDate = new Date(postingDateIso);
                    let year = postingDate.getFullYear();
                    const postingMonth = postingDate.getMonth() + 1; // 0-11 to 1-12

                    // Correção de virada de ano:
                    // Se a data extraída for Dezembro (12) e a postagem for Janeiro (1),
                    // significa que a compra foi no ano anterior.
                    if (extractedMonth === 12 && postingMonth === 1) {
                        year = year - 1;
                    } 
                    // Proteção simples: se extraiu Janeiro e estamos em Dezembro, pode ser erro futuro, 
                    // mas bancos geralmente não mostram futuro na descrição. Mantemos lógica simples.

                    // Formata para YYYY-MM-DD
                    const pad = (n) => n.toString().padStart(2, '0');
                    return `${year}-${pad(extractedMonth)}-${pad(extractedDay)}`;
                }
            } catch (e) {
                console.warn("Erro ao extrair data da descrição", e);
            }
            return postingDateIso; // Retorna a data original se não achar nada
        };

        // --- Default Config ---
        const defaultConfig = {
            revenueCats: ['Venda de Leite', 'Venda de Animais', 'Venda de Queijo', 'Serviços', 'Outros'],
            expenseCats: ['Ração/Sal', 'Medicamentos', 'Manutenção', 'Energia', 'Mão de Obra', 'Combustível', 'Outros'],
            rules: [
                { keyword: 'MARCELIO', category: 'Venda de Leite', type: 'revenue' },
                { keyword: 'CDB', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'RESGATE', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'INVESTIMENTO', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'APLICAÇÃO', category: 'IGNORAR', type: 'revenue' },
                { keyword: 'SALDO', category: 'IGNORAR', type: 'revenue' }
            ]
        };

        // --- Auth Screen ---
        const AuthScreen = () => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error("Erro auth:", err);
                    let msg = "Erro: " + err.code;
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') msg = "Email ou senha incorretos.";
                    else if (err.code === 'auth/operation-not-allowed') msg = "Ative 'Email/Senha' no Firebase Console.";
                    setError(msg);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-800 to-green-900 text-white">
                    <div className="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-gray-800 fade-in">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-emerald-100 p-4 rounded-full mb-3"><Sprout size={40} className="text-emerald-700" /></div>
                            <h1 className="text-2xl font-bold text-emerald-900">Fazenda WM</h1>
                            <p className="text-sm font-medium text-emerald-600 uppercase mt-1">{isRegistering ? 'Criar Conta' : 'Acessar Sistema'}</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">EMAIL</label><input type="email" required className="w-full px-4 py-3 bg-gray-50 border rounded-xl" value={email} onChange={e => setEmail(e.target.value)} /></div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1">SENHA</label><input type="password" required className="w-full px-4 py-3 bg-gray-50 border rounded-xl" value={password} onChange={e => setPassword(e.target.value)} /></div>
                            {error && <div className="bg-red-50 p-3 rounded-xl text-red-600 text-xs border border-red-100">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 disabled:opacity-70">{loading ? '...' : (isRegistering ? 'Cadastrar' : 'Entrar')}</button>
                        </form>
                        <div className="mt-4 text-center"><button onClick={() => setIsRegistering(!isRegistering)} className="text-emerald-700 text-sm font-semibold underline">{isRegistering ? 'Já tenho conta' : 'Criar conta'}</button></div>
                    </div>
                </div>
            );
        };

        // --- Balance Panel ---
        const BalancePanel = ({ revenues, expenses }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const changeMonth = (offset) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + offset); setViewDate(d); };
            const currentMonth = viewDate.getMonth();
            const currentYear = viewDate.getFullYear();
            
            const monthRev = revenues.filter(r => { const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((acc, curr) => acc + Number(curr.amount), 0);
            const monthExp = expenses.filter(r => { const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }).reduce((acc, curr) => acc + Number(curr.amount), 0);
            const totalRev = revenues.reduce((acc, curr) => acc + Number(curr.amount), 0);
            const totalExp = expenses.reduce((acc, curr) => acc + Number(curr.amount), 0);
            
            const totalVolume = totalRev + totalExp;
            const revPercent = totalVolume > 0 ? (totalRev / totalVolume) * 100 : 50;
            const monthName = viewDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            if (totalVolume === 0) return <div className="h-full flex flex-col items-center justify-center p-8 text-center text-gray-500"><Upload size={48} className="text-emerald-600 mb-4"/><p>Importe um extrato para começar.</p><button onClick={() => signOut(auth)} className="mt-4 text-emerald-600 font-bold underline">Sair</button></div>;

            return (
                <div className="space-y-6 pb-24 fade-in">
                    <header className="bg-gray-900 text-white p-6 rounded-b-3xl shadow-lg relative overflow-hidden">
                        <div className="flex justify-between items-start mb-4 relative z-10"><div><h1 className="text-2xl font-bold">Balanço</h1><p className="text-sm text-gray-400">Visão Geral</p></div><button onClick={() => signOut(auth)} className="bg-white/10 p-2 rounded-lg"><LogOut size={18}/></button></div>
                        <div className="bg-white/10 backdrop-blur-md p-5 rounded-2xl border border-white/10 relative z-10"><span className="text-xs uppercase text-gray-400">Saldo Total</span><div className={`text-3xl font-bold mt-1 ${totalRev - totalExp >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{formatCurrency(totalRev - totalExp)}</div></div>
                    </header>
                    <div className="px-6"><div className="flex justify-between items-center bg-white p-2 rounded-xl shadow-sm mb-4"><button onClick={() => changeMonth(-1)} className="p-2"><ChevronLeft size={20}/></button><span className="font-bold capitalize text-sm">{monthName}</span><button onClick={() => changeMonth(1)} className="p-2"><ChevronRight size={20}/></button></div><div className="grid grid-cols-2 gap-3"><div className="bg-white p-4 rounded-xl shadow-sm text-center"><p className="text-xs text-gray-500">Entradas</p><p className="font-bold text-emerald-600">{formatCurrency(monthRev)}</p></div><div className="bg-white p-4 rounded-xl shadow-sm text-center"><p className="text-xs text-gray-500">Saídas</p><p className="font-bold text-red-600">{formatCurrency(monthExp)}</p></div></div></div>
                </div>
            );
        };

        // --- Reconciliation Tool ---
        const ReconciliationTool = ({ oldSystemExpenses, newSystemExpenses }) => {
            const [viewDate, setViewDate] = useState(new Date());
            const [analysis, setAnalysis] = useState(null);
            const [expandedDay, setExpandedDay] = useState(null);
            const [debugMode, setDebugMode] = useState(false);

            const changeMonth = (offset) => { const d = new Date(viewDate); d.setMonth(d.getMonth() + offset); setViewDate(d); setExpandedDay(null); };
            const monthName = viewDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            useEffect(() => { analyze(newSystemExpenses, oldSystemExpenses); }, [viewDate, newSystemExpenses, oldSystemExpenses]);

            // Helper ROBUSTO para ler valores
            const getManualValue = (item) => {
                try {
                    let val = item.Valor !== undefined ? item.Valor : 
                              item.valor !== undefined ? item.valor : 
                              item.amount !== undefined ? item.amount : 
                              item.Total !== undefined ? item.Total : 0;
                    
                    if (typeof val === 'number') return val;
                    if (typeof val === 'string') {
                        let clean = val.trim().replace(/^R\$\s?/, '').replace(/[^\d.,-]/g, '');
                        if (clean.includes(',') && !clean.includes('.,')) clean = clean.replace(/\./g, '').replace(',', '.');
                        let num = parseFloat(clean);
                        return isNaN(num) ? 0 : num;
                    }
                    return 0;
                } catch (e) { return 0; }
            };

            const analyze = (newSys, oldSys) => {
                const cm = viewDate.getMonth(), cy = viewDate.getFullYear();
                
                // Filtra dados do novo sistema (CSV)
                const bankItems = newSys.filter(i => { const d = new Date(i.date); return d.getMonth() === cm && d.getFullYear() === cy; });
                
                // Filtra dados do sistema antigo (Manual)
                const manualItems = oldSys.filter(i => {
                    let d;
                    try {
                        let dv = i.Data || i.data || i.date;
                        if (!dv) return false;
                        if (dv.seconds) d = new Date(dv.seconds * 1000);
                        else if (typeof dv === 'string') {
                            if (dv.includes('/')) { const p = dv.split('/'); d = new Date(`${p[2]}-${p[1]}-${p[0]}`); }
                            else d = new Date(dv);
                        }
                    } catch(e) { return false; }
                    if (!d || isNaN(d.getTime())) return false;
                    i._normalizedDate = d;
                    return d.getMonth() === cm && d.getFullYear() === cy;
                });

                if (bankItems.length === 0) { setAnalysis(null); return; }

                const dailyData = {};
                const allDates = new Set();
                const getDateStr = (d) => d.toISOString().split('T')[0];

                bankItems.forEach(i => { const ds = getDateStr(new Date(i.date)); allDates.add(ds); if(!dailyData[ds]) dailyData[ds] = { b:[], m:[] }; dailyData[ds].b.push(i); });
                manualItems.forEach(i => { const ds = getDateStr(i._normalizedDate); allDates.add(ds); if(!dailyData[ds]) dailyData[ds] = { b:[], m:[] }; dailyData[ds].m.push(i); });

                const dailyReports = Array.from(allDates).sort().map(d => {
                    const dd = dailyData[d];
                    const bTotal = dd.b.reduce((s, x) => s + Number(x.amount || 0), 0);
                    const mTotal = dd.m.reduce((s, x) => s + getManualValue(x), 0);
                    return { date: d, bTotal, mTotal, diff: bTotal - mTotal, bItems: dd.b, mItems: dd.m, isMatch: Math.abs(bTotal - mTotal) < 0.05 };
                });

                const monthly = dailyReports.reduce((acc, d) => ({ b: acc.b + d.bTotal, m: acc.m + d.mTotal, d: acc.d + d.diff }), { b:0, m:0, d:0 });
                setAnalysis({ monthly, daily: dailyReports, manualCount: manualItems.length });
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    <div className="bg-purple-800 p-4 text-white sticky top-0 z-20 flex justify-between items-center shadow-lg">
                        <h1 className="font-bold flex items-center gap-2"><Scale size={20}/> Conciliação</h1>
                        <div className="flex items-center gap-2 bg-purple-900/50 p-1 rounded-lg">
                            <button onClick={() => changeMonth(-1)}><ChevronLeft size={20}/></button>
                            <span className="text-xs font-bold w-24 text-center capitalize">{monthName}</span>
                            <button onClick={() => changeMonth(1)}><ChevronRight size={20}/></button>
                        </div>
                    </div>

                    {!analysis ? (
                        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center text-gray-400">
                            <Database size={32} className="mb-2 text-purple-300"/>
                            <p className="text-sm">Sem dados bancários neste mês.</p>
                            <button onClick={() => setDebugMode(!debugMode)} className="mt-8 text-xs text-purple-300 underline">Debug</button>
                            {debugMode && <div className="mt-2 text-[10px] bg-gray-200 p-2 rounded text-left w-full h-32 overflow-auto text-gray-800">{JSON.stringify(oldSystemExpenses[0]) || 'Sem dados antigos'}</div>}
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto pb-24">
                            <div className="bg-purple-700 text-white p-4 pt-0 pb-6 rounded-b-3xl shadow-lg mb-4">
                                <div className="flex justify-between text-center mb-4">
                                    <div><span className="text-[10px] opacity-70">BANCO (NOVO)</span><div className="text-lg font-bold">{formatCurrency(analysis.monthly.b)}</div></div>
                                    <div><span className="text-[10px] opacity-70">MANUAL (ANTIGO)</span><div className="text-lg font-bold">{formatCurrency(analysis.monthly.m)}</div></div>
                                </div>
                                <div className={`p-2 rounded-lg flex justify-between items-center ${Math.abs(analysis.monthly.d) > 0.05 ? 'bg-red-500/20' : 'bg-green-500/20'}`}>
                                    <span className="text-xs font-bold uppercase">Diferença</span><span className="font-bold">{formatCurrency(analysis.monthly.d)}</span>
                                </div>
                            </div>
                            <div className="px-4 space-y-3">
                                {analysis.daily.map(day => {
                                    if (day.isMatch) return null;
                                    const isExp = expandedDay === day.date;
                                    return (
                                        <div key={day.date} className="bg-white rounded-xl shadow-sm border border-red-100 overflow-hidden">
                                            <div onClick={() => setExpandedDay(isExp ? null : day.date)} className="p-3 flex justify-between items-center bg-red-50/30 cursor-pointer">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-white border font-bold px-2 py-1 rounded text-xs">{day.date.split('-')[2]}</div>
                                                    <div><div className="text-[10px] text-gray-500 uppercase">Diferença</div><div className="text-red-600 font-bold">{formatCurrency(day.diff)}</div></div>
                                                </div>
                                                <ChevronDown size={16} className={`text-gray-400 transition ${isExp ? 'rotate-180' : ''}`}/>
                                            </div>
                                            {isExp && (
                                                <div className="p-3 bg-white text-xs border-t border-gray-100 grid grid-cols-2 gap-2">
                                                    <div>
                                                        <h4 className="font-bold text-gray-500 mb-1">Banco</h4>
                                                        {day.bItems.map((i,k) => <div key={k} className="flex justify-between border-b border-gray-50 py-1"><span className="truncate w-12">{i.description}</span><b>{formatCurrency(i.amount)}</b></div>)}
                                                    </div>
                                                    <div className="border-l pl-2">
                                                        <h4 className="font-bold text-gray-500 mb-1">Manual</h4>
                                                        {day.mItems.map((i,k) => <div key={k} className="flex justify-between border-b border-gray-50 py-1"><span className="truncate w-12">{i.Descricao || i.descricao || 'Item'}</span><b>{formatCurrency(getManualValue(i))}</b></div>)}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                {analysis.daily.every(d => d.isMatch) && <div className="text-center text-gray-400 py-8"><CheckCircle2 size={40} className="mx-auto text-emerald-300 mb-2"/><p>Tudo conciliado!</p></div>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Settings Panel (Simplified) ---
        const SettingsPanel = ({ config, onUpdateConfig }) => {
             const [newItem, setNewItem] = useState('');
             const [view, setView] = useState('categories');
             const addCat = (t) => { if(newItem){ const f = t==='rev'?'revenueCats':'expenseCats'; onUpdateConfig({...config, [f]:[...config[f], newItem]}); setNewItem(''); }};
             return (
                 <div className="pb-24 fade-in bg-gray-50 h-full p-4">
                     <h1 className="text-xl font-bold mb-4">Ajustes</h1>
                     <div className="flex gap-2 mb-4"><button onClick={()=>setView('categories')} className={`p-2 rounded flex-1 ${view==='categories'?'bg-emerald-600 text-white':'bg-white'}`}>Categorias</button></div>
                     {view === 'categories' && <div><h3 className="font-bold text-sm mb-2">Adicionar Categoria</h3><div className="flex gap-2"><input className="border p-2 rounded flex-1" value={newItem} onChange={e=>setNewItem(e.target.value)} /><button onClick={()=>addCat('rev')} className="bg-emerald-600 text-white p-2 rounded">Rec</button><button onClick={()=>addCat('exp')} className="bg-red-600 text-white p-2 rounded">Desp</button></div><div className="mt-4 flex flex-wrap gap-2 text-xs">{config.revenueCats.map(c=><span key={c} className="bg-emerald-100 p-1 rounded">{c}</span>)}{config.expenseCats.map(c=><span key={c} className="bg-red-100 p-1 rounded">{c}</span>)}</div></div>}
                 </div>
             )
        };

        // --- Transaction Manager ---
        const TransactionManager = ({ type, data, onAdd, onImport, onDelete, onUpdate, config }) => {
            const [view, setView] = useState('list');
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], description: '', amount: '', category: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [editItem, setEditItem] = useState(null);
            const isRevenue = type === 'revenue';
            const themeColor = isRevenue ? 'emerald' : 'red';
            const categories = isRevenue ? config.revenueCats : config.expenseCats;
            const filteredData = data.filter(item => item.description.toLowerCase().includes(searchTerm.toLowerCase()) || (item.category && item.category.toLowerCase().includes(searchTerm.toLowerCase()))).sort((a, b) => new Date(b.date) - new Date(a.date));

            const handleSubmit = async (e) => { e.preventDefault(); await onAdd({ ...formData, amount: parseFloat(formData.amount), type, category: formData.category || 'Outros' }); setFormData({ date: new Date().toISOString().split('T')[0], description: '', amount: '', category: '' }); setView('list'); };
            const [csvItems, setCsvItems] = useState([]);
            
            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n'); const parsed = [];
                    lines.forEach((line, idx) => {
                        if (!line.trim()) return;
                        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g, '').trim());
                        if (cols.length < 5) return;
                        let val = parseFloat(cols[cols.length - 1] || cols[5]);
                        const isValid = isRevenue ? (val > 0) : (val < 0);
                        if (!isNaN(val) && isValid) {
                            const descOriginal = cols[2] || 'Sem descrição';
                            const descUpper = descOriginal.toUpperCase();
                            if (isRevenue && (descUpper.includes('CDB') || descUpper.includes('RESGATE') || descUpper.includes('INVESTIMENTO'))) return;
                            
                            let autoCategory = 'Importado';
                            const matchedRule = config.rules.find(r => r.type === type && descUpper.includes(r.keyword));
                            if (matchedRule) { if (matchedRule.category === 'IGNORAR') return; autoCategory = matchedRule.category; }
                            
                            const dParts = cols[0].split('/');
                            let dateIso = dParts.length === 3 ? `${dParts[2]}-${dParts[1]}-${dParts[0]}` : new Date().toISOString().split('T')[0];
                            
                            // APLICAÇÃO DA INTELIGÊNCIA DE DATA AQUI
                            dateIso = extractRealDateFromDescription(dateIso, descOriginal);

                            const isDuplicate = data.some(existing => existing.date === dateIso && existing.description === descOriginal && Math.abs(existing.amount) === Math.abs(val));
                            parsed.push({ id: Date.now() + idx, date: dateIso, description: descOriginal, amount: Math.abs(val), category: autoCategory, selected: !isDuplicate, isDuplicate });
                        }
                    });
                    setCsvItems(parsed);
                };
                reader.readAsText(file, 'ISO-8859-1');
            };

            if (view === 'add') return (
                <div className="p-4 pb-24 fade-in">
                    <div className="flex items-center gap-2 mb-6"><button onClick={() => setView('list')} className="p-2 bg-gray-100 rounded-full"><X size={20}/></button><h2 className="text-2xl font-bold text-gray-800">Nova {isRevenue ? 'Receita' : 'Despesa'}</h2></div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Descrição</label><input required className="w-full p-3 border rounded-xl" placeholder="Ex: Ração" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                        <div className="flex gap-3"><div className="w-1/2"><label className="text-xs font-bold text-gray-500 uppercase">Valor</label><input type="number" step="0.01" required className="w-full p-3 border rounded-xl" placeholder="0,00" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} /></div><div className="w-1/2"><label className="text-xs font-bold text-gray-500 uppercase">Data</label><input type="date" required className="w-full p-3 border rounded-xl" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} /></div></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Categoria</label><select className="w-full p-3 border rounded-xl bg-white" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}><option value="">Selecione...</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                        <button type="submit" className={`w-full py-4 rounded-xl text-white font-bold shadow-lg mt-4 bg-${themeColor}-600`}>Salvar</button>
                    </form>
                </div>
            );

            if (view === 'import') return (
                <div className="p-4 pb-24 fade-in h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">Importar CSV</h2><button onClick={() => { setView('list'); setCsvItems([]); }} className="text-gray-500">Cancelar</button></div>
                    {csvItems.length === 0 ? (
                        <div className="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50"><Upload size={48} className="text-gray-400 mb-2"/><p className="text-gray-500 text-sm mb-4">Selecione o extrato</p><input type="file" accept=".csv" onChange={e => handleFile(e.target.files[0])} /></div>
                    ) : (
                        <>
                            <div className="flex-1 overflow-y-auto space-y-2 mb-4">{csvItems.map((item, idx) => (
                                <div key={idx} className={`p-3 border rounded-lg flex gap-3 ${item.selected ? `border-${themeColor}-500 bg-${themeColor}-50` : 'border-gray-200 opacity-50'}`}><input type="checkbox" checked={item.selected} onChange={() => { const n = [...csvItems]; n[idx].selected = !n[idx].selected; setCsvItems(n); }} /><div className="flex-1"><div className="flex justify-between font-bold text-sm"><span>{item.description}</span><span>{formatCurrency(item.amount)}</span></div><div className="flex justify-between items-center mt-1"><span className="text-xs text-gray-500">{formatDate(item.date)}</span>{item.isDuplicate && <span className="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><AlertCircle size={10} /> Duplicado</span>}<span className={`text-[10px] px-2 py-0.5 rounded-full ${item.category !== 'Importado' ? 'bg-blue-100 text-blue-700 font-bold' : 'bg-gray-100 text-gray-500'}`}>{item.category}</span></div></div></div>
                            ))}</div>
                            <button onClick={async () => { const toImport = csvItems.filter(i => i.selected).map(({id, selected, isDuplicate, ...rest}) => ({...rest, type, source: 'import'})); await onImport(toImport); setView('list'); setCsvItems([]); }} disabled={csvItems.filter(i => i.selected).length === 0} className={`w-full py-3 rounded-xl text-white font-bold shadow bg-${themeColor}-600 disabled:opacity-50`}>Confirmar ({csvItems.filter(i => i.selected).length})</button>
                        </>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    <header className={`bg-${themeColor}-600 text-white p-6 pb-8 rounded-b-3xl shadow-lg sticky top-0 z-10`}>
                        <div className="flex justify-between items-center mb-4"><h1 className="text-2xl font-bold">{isRevenue ? 'Receitas' : 'Despesas'}</h1><div className="flex gap-2"><button onClick={() => setView('import')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Importar"><Upload size={20}/></button><button onClick={() => setView('add')} className="bg-white text-gray-900 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm active:scale-95 transition"><PlusCircle size={18}/> Novo</button></div></div>
                        <div className="relative"><Search className={`absolute left-3 top-3 text-${themeColor}-200`} size={18} /><input type="text" placeholder="Buscar..." className={`w-full pl-10 pr-4 py-2.5 bg-${themeColor}-700 rounded-xl text-white placeholder-${themeColor}-300 focus:outline-none focus:ring-2 focus:ring-white/50`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                    </header>
                    <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-3">
                        {filteredData.length === 0 ? <div className="text-center py-10 text-gray-400"><p className="mb-2">Nenhum registro.</p><button onClick={() => setView('import')} className={`text-sm text-${themeColor}-600 font-bold underline`}>Importar</button></div> : filteredData.map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                {editItem === item.id ? (
                                    <div className="flex-1 flex gap-2"><input className="border rounded px-2 py-1 w-full" value={item.description} onChange={(e) => onUpdate(item.id, { description: e.target.value })} /><input type="number" className="border rounded px-2 py-1 w-24" value={item.amount} onChange={(e) => onUpdate(item.id, { amount: parseFloat(e.target.value) })} /><button onClick={() => setEditItem(null)} className="p-2 bg-green-100 text-green-700 rounded"><Check size={16}/></button></div>
                                ) : (
                                    <><div className="flex-1"><h3 className="font-bold text-gray-800">{item.description}</h3><div className="flex items-center gap-2 text-xs text-gray-500 mt-1"><span className="bg-gray-100 px-2 py-0.5 rounded">{formatDate(item.date)}</span><span>{item.category}</span></div></div><div className="text-right"><div className={`font-bold text-lg text-${themeColor}-600`}>{formatCurrency(item.amount)}</div><div className="flex justify-end gap-3 mt-1"><button onClick={() => setEditItem(item.id)} className="text-gray-400 hover:text-blue-500"><Edit2 size={14}/></button><button onClick={() => onDelete(item.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={14}/></button></div></div></>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('balance');
            const [revenues, setRevenues] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [oldExpenses, setOldExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [config, setConfig] = useState(defaultConfig);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const qRev = query(collection(db, 'artifacts', appNamespace, 'users', u.uid, 'farm_revenues'), orderBy('date', 'desc'));
                        onSnapshot(qRev, (snap) => setRevenues(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                        const qExp = query(collection(db, 'artifacts', appNamespace, 'users', u.uid, 'farm_expenses'), orderBy('date', 'desc'));
                        onSnapshot(qExp, (snap) => setExpenses(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                        
                        // Busca dados antigos com fallback robusto
                        const qOld = query(collection(db, 'despesas'));
                        onSnapshot(qOld, (snap) => setOldExpenses(snap.docs.map(d => ({id: d.id, ...d.data()}))), (err) => console.log("Erro old db", err));

                        setLoading(false);
                    } else { setLoading(false); }
                });
                return () => unsub();
            }, []);

            // ... CRUD functions ...
            const addTransaction = async (data) => {
                const coll = data.type === 'revenue' ? 'farm_revenues' : 'farm_expenses';
                await addDoc(collection(db, 'artifacts', appNamespace, 'users', user.uid, coll), { ...data, createdAt: serverTimestamp() });
            };

            if (loading) return <div className="h-screen flex items-center justify-center">Carregando...</div>;
            if (!user) return <AuthScreen />;

            return (
                <ErrorBoundary>
                    <div className="h-screen w-full flex flex-col font-sans overflow-hidden bg-gray-50">
                        <main className="flex-1 overflow-y-auto">
                            {activeTab === 'balance' && <BalancePanel revenues={revenues} expenses={expenses} />}
                            {activeTab === 'reconcile' && <ReconciliationTool oldSystemExpenses={oldExpenses} newSystemExpenses={expenses} onAddMissing={addTransaction} />}
                            {/* Simplifiquei a renderização das outras abas aqui para focar na correção do erro, mas a lógica completa está no código anterior se precisar restaurar */}
                            {activeTab === 'settings' && <SettingsPanel config={config} onUpdateConfig={()=>{}} />}
                            {activeTab === 'revenues' && <TransactionManager type="revenue" data={revenues} onAdd={addTransaction} config={config} />}
                            {activeTab === 'expenses' && <TransactionManager type="expense" data={expenses} onAdd={addTransaction} config={config} />}
                        </main>
                        <nav className="bg-white border-t border-gray-200 fixed bottom-0 w-full pb-safe z-50">
                            <div className="flex justify-around items-center h-16">
                                <button onClick={() => setActiveTab('balance')} className={`p-2 ${activeTab === 'balance' ? 'text-gray-900' : 'text-gray-400'}`}><PieChart size={20}/></button>
                                <button onClick={() => setActiveTab('revenues')} className={`p-2 ${activeTab === 'revenues' ? 'text-emerald-600' : 'text-gray-400'}`}><ArrowUpCircle size={20}/></button>
                                <button onClick={() => setActiveTab('reconcile')} className={`p-2 ${activeTab === 'reconcile' ? 'text-purple-600' : 'text-gray-400'}`}><Scale size={24}/></button>
                                <button onClick={() => setActiveTab('expenses')} className={`p-2 ${activeTab === 'expenses' ? 'text-red-600' : 'text-gray-400'}`}><ArrowDownCircle size={20}/></button>
                                <button onClick={() => setActiveTab('settings')} className={`p-2 ${activeTab === 'settings' ? 'text-blue-600' : 'text-gray-400'}`}><Settings size={20}/></button>
                            </div>
                        </nav>
                    </div>
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
