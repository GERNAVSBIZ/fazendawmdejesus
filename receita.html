<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fazenda WM - Gestão Completa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para traduzir o React no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuração para evitar zoom no input em iOS e estilos globais -->
    <style>
        @layer utilities {
            .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        }
        input, select, textarea { font-size: 16px !important; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Barra de progresso para o balanço */
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 select-none">
    <div id="root"></div>

    <!-- Script Principal da Aplicação -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            PlusCircle, Upload, Home, List, Trash2, Edit2, Save, X, Check, 
            DollarSign, FileText, Calendar, Search, ArrowUpCircle, ArrowDownCircle,
            LogOut, User, Lock, Sprout, TrendingUp, TrendingDown, PieChart, Info,
            Filter, Settings, Tag, Zap, ChevronLeft, ChevronRight
        } from 'https://esm.sh/lucide-react@0.292.0';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, 
            query, orderBy, serverTimestamp, setDoc 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- CONFIGURAÇÃO (PROJETO UNIFICADO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appNamespace = 'fazenda-wm-integrada'; 

        // --- Utilitários ---
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        // --- Default Config ---
        const defaultConfig = {
            revenueCats: ['Venda de Leite', 'Venda de Animais', 'Venda de Queijo', 'Serviços', 'Outros'],
            expenseCats: ['Ração/Sal', 'Medicamentos', 'Manutenção', 'Energia', 'Mão de Obra', 'Combustível', 'Outros'],
            rules: [
                { keyword: 'MARCELIO', category: 'Venda de Leite', type: 'revenue' }
            ]
        };

        // --- Componente: Tela de Login ---
        const AuthScreen = () => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error(err);
                    let msg = "Erro ao autenticar.";
                    if (err.code === 'auth/invalid-credential') msg = "Email ou senha incorretos.";
                    setError(msg);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-emerald-800 to-green-900 text-white">
                    <div className="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-gray-800 fade-in">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-emerald-100 p-4 rounded-full mb-3">
                                <Sprout size={40} className="text-emerald-700" />
                            </div>
                            <h1 className="text-2xl font-bold text-emerald-900">Fazenda WM</h1>
                            <p className="text-sm text-gray-500">Gestão Financeira Integrada</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Email</label>
                                <input type="email" required className="w-full px-4 py-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1 uppercase">Senha</label>
                                <input type="password" required minLength={6} className="w-full px-4 py-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            {error && <div className="text-red-600 text-sm text-center bg-red-50 p-2 rounded">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2 active:scale-95 transition-transform">
                                {loading ? 'Processando...' : (isRegistering ? 'Criar Conta' : 'Acessar')}
                            </button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="w-full text-center mt-6 text-emerald-700 text-sm font-semibold hover:underline">
                            {isRegistering ? 'Já tenho conta' : 'Criar nova conta'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Componente: Painel de Balanço ---
        const BalancePanel = ({ revenues, expenses }) => {
            const [viewDate, setViewDate] = useState(new Date());

            // Cálculos Totais (Acumulado Geral)
            const totalRev = revenues.reduce((acc, curr) => acc + Number(curr.amount), 0);
            const totalExp = expenses.reduce((acc, curr) => acc + Number(curr.amount), 0);
            const balance = totalRev - totalExp;
            
            // Navegação de Datas
            const changeMonth = (offset) => {
                const newDate = new Date(viewDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setViewDate(newDate);
            };

            const currentMonth = viewDate.getMonth();
            const currentYear = viewDate.getFullYear();
            
            // Cálculos do Mês Selecionado
            const monthRev = revenues.filter(r => {
                const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).reduce((acc, curr) => acc + Number(curr.amount), 0);
            
            const monthExp = expenses.filter(r => {
                const d = new Date(r.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).reduce((acc, curr) => acc + Number(curr.amount), 0);

            const monthBalance = monthRev - monthExp;
            const totalVolume = totalRev + totalExp;
            const revPercent = totalVolume > 0 ? (totalRev / totalVolume) * 100 : 50;

            const monthLabel = viewDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            // Capitalizar primeira letra
            const monthLabelFormatted = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);

            if (totalVolume === 0) {
                 return (
                    <div className="h-full flex flex-col items-center justify-center p-8 fade-in text-center">
                        <div className="bg-emerald-100 p-6 rounded-full mb-6">
                            <Upload size={48} className="text-emerald-600" />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Vamos começar?</h2>
                        <p className="text-gray-500 mb-8 max-w-xs">
                            Para iniciar, importe seu extrato bancário nas abas abaixo.
                        </p>
                        <div className="space-y-4 w-full max-w-sm text-sm">
                            <div className="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-3 text-left">
                                <span className="bg-emerald-100 text-emerald-800 font-bold w-6 h-6 flex items-center justify-center rounded-full">1</span>
                                <span>Vá em <b>Receitas</b> e importe o CSV.</span>
                            </div>
                            <div className="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-3 text-left">
                                <span className="bg-red-100 text-red-800 font-bold w-6 h-6 flex items-center justify-center rounded-full">2</span>
                                <span>Vá em <b>Despesas</b> e importe o mesmo CSV.</span>
                            </div>
                        </div>
                        <button onClick={() => signOut(auth)} className="mt-8 text-emerald-600 font-bold text-sm">Sair da Conta</button>
                    </div>
                 );
            }

            return (
                <div className="space-y-6 pb-24 fade-in">
                    <header className="bg-gray-900 text-white p-6 rounded-b-3xl shadow-lg relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-32 bg-emerald-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
                        <div className="flex justify-between items-start mb-4 relative z-10">
                            <div>
                                <h1 className="text-2xl font-bold">Balanço Geral</h1>
                                <p className="text-gray-400 text-sm">Resumo Financeiro</p>
                            </div>
                            <button onClick={() => signOut(auth)} className="bg-white/10 p-2 rounded-lg hover:bg-white/20"><LogOut size={18} /></button>
                        </div>
                        <div className="bg-white/10 backdrop-blur-md p-5 rounded-2xl border border-white/10 relative z-10">
                            <span className="text-gray-400 text-xs uppercase tracking-wider">Saldo Acumulado</span>
                            <div className={`text-4xl font-bold mt-1 ${balance >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {formatCurrency(balance)}
                            </div>
                            <div className="mt-4 flex gap-4">
                                <div className="flex-1">
                                    <div className="flex items-center gap-1 text-emerald-400 text-xs mb-1"><ArrowUpCircle size={12} /> Receitas</div>
                                    <div className="font-semibold text-lg">{formatCurrency(totalRev)}</div>
                                </div>
                                <div className="w-px bg-white/20"></div>
                                <div className="flex-1">
                                    <div className="flex items-center gap-1 text-red-400 text-xs mb-1"><ArrowDownCircle size={12} /> Despesas</div>
                                    <div className="font-semibold text-lg">{formatCurrency(totalExp)}</div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="px-6">
                        <h3 className="text-gray-600 font-bold mb-3 flex items-center gap-2"><PieChart size={18}/> Proporção Global</h3>
                        <div className="h-4 bg-gray-200 rounded-full overflow-hidden flex">
                            <div className="h-full bg-emerald-500 progress-bar" style={{width: `${revPercent}%`}}></div>
                            <div className="h-full bg-red-500 progress-bar" style={{width: `${100 - revPercent}%`}}></div>
                        </div>
                        <div className="flex justify-between text-xs text-gray-500 mt-2 font-medium">
                            <span>{revPercent.toFixed(0)}% Entrada</span>
                            <span>{(100 - revPercent).toFixed(0)}% Saída</span>
                        </div>
                    </div>

                    <div className="px-6">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-gray-600 font-bold flex items-center gap-2"><Calendar size={18}/> Mês de Referência</h3>
                        </div>
                        
                        <div className="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-gray-100 mb-4">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-xl text-gray-600"><ChevronLeft size={20}/></button>
                            <span className="font-bold text-gray-800 text-sm uppercase tracking-wide">{monthLabelFormatted}</span>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-xl text-gray-600"><ChevronRight size={20}/></button>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="bg-emerald-100 w-8 h-8 rounded-full flex items-center justify-center text-emerald-600 mb-2"><TrendingUp size={16} /></div>
                                <p className="text-xs text-gray-500">Entradas</p>
                                <p className="font-bold text-gray-800 text-lg">{formatCurrency(monthRev)}</p>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="bg-red-100 w-8 h-8 rounded-full flex items-center justify-center text-red-600 mb-2"><TrendingDown size={16} /></div>
                                <p className="text-xs text-gray-500">Saídas</p>
                                <p className="font-bold text-gray-800 text-lg">{formatCurrency(monthExp)}</p>
                            </div>
                        </div>
                        <div className={`mt-3 p-3 rounded-xl border flex justify-between items-center ${monthBalance >= 0 ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-red-50 border-red-100 text-red-700'}`}>
                            <span className="text-sm font-semibold">Resultado de {monthLabelFormatted.split(' ')[0]}</span>
                            <span className="font-bold">{formatCurrency(monthBalance)}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente: Painel de Configurações (Ajustes) ---
        const SettingsPanel = ({ config, onUpdateConfig }) => {
            const [view, setView] = useState('categories'); // 'categories' or 'rules'
            const [newItem, setNewItem] = useState('');
            const [newRule, setNewRule] = useState({ keyword: '', category: '', type: 'revenue' });

            const addCategory = (type) => {
                if (!newItem.trim()) return;
                const field = type === 'revenue' ? 'revenueCats' : 'expenseCats';
                const newCats = [...config[field], newItem.trim()];
                onUpdateConfig({ ...config, [field]: newCats });
                setNewItem('');
            };

            const removeCategory = (type, cat) => {
                if(!confirm(`Remover categoria "${cat}"?`)) return;
                const field = type === 'revenue' ? 'revenueCats' : 'expenseCats';
                const newCats = config[field].filter(c => c !== cat);
                onUpdateConfig({ ...config, [field]: newCats });
            };

            const addRule = () => {
                if (!newRule.keyword || !newRule.category) return;
                const updatedRules = [...config.rules, { ...newRule, keyword: newRule.keyword.toUpperCase() }];
                onUpdateConfig({ ...config, rules: updatedRules });
                setNewRule({ ...newRule, keyword: '' });
            };

            const removeRule = (index) => {
                const updatedRules = config.rules.filter((_, i) => i !== index);
                onUpdateConfig({ ...config, rules: updatedRules });
            };

            return (
                <div className="pb-24 fade-in bg-gray-50 min-h-full">
                     <header className="bg-gray-800 text-white p-6 rounded-b-3xl shadow-lg mb-6">
                        <h1 className="text-2xl font-bold flex items-center gap-2"><Settings size={24}/> Ajustes</h1>
                        <p className="text-gray-400 text-sm">Personalize seu sistema</p>
                        <div className="flex mt-6 bg-gray-700/50 p-1 rounded-xl">
                            <button onClick={() => setView('categories')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${view === 'categories' ? 'bg-emerald-500 text-white shadow' : 'text-gray-300'}`}>Categorias</button>
                            <button onClick={() => setView('rules')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${view === 'rules' ? 'bg-emerald-500 text-white shadow' : 'text-gray-300'}`}>Automação</button>
                        </div>
                    </header>

                    {view === 'categories' && (
                        <div className="px-4 space-y-6">
                            {/* Receitas */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-emerald-700 mb-3 flex items-center gap-2"><ArrowUpCircle size={18}/> Categorias de Receita</h3>
                                <div className="flex gap-2 mb-3">
                                    <input type="text" placeholder="Nova Categoria (ex: Aluguel)" className="flex-1 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50 text-sm" value={newItem} onChange={e => setNewItem(e.target.value)} />
                                    <button onClick={() => addCategory('revenue')} className="bg-emerald-600 text-white px-4 rounded-lg font-bold">+</button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {config.revenueCats.map(cat => (
                                        <div key={cat} className="bg-emerald-50 text-emerald-800 text-xs px-3 py-1.5 rounded-full flex items-center gap-2 border border-emerald-100">
                                            {cat}
                                            <button onClick={() => removeCategory('revenue', cat)} className="text-emerald-400 hover:text-red-500"><X size={12}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Despesas */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-red-700 mb-3 flex items-center gap-2"><ArrowDownCircle size={18}/> Categorias de Despesa</h3>
                                <div className="flex gap-2 mb-3">
                                    <input type="text" placeholder="Nova Categoria (ex: Adubo)" className="flex-1 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50 text-sm" value={newItem} onChange={e => setNewItem(e.target.value)} />
                                    <button onClick={() => addCategory('expense')} className="bg-red-600 text-white px-4 rounded-lg font-bold">+</button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {config.expenseCats.map(cat => (
                                        <div key={cat} className="bg-red-50 text-red-800 text-xs px-3 py-1.5 rounded-full flex items-center gap-2 border border-red-100">
                                            {cat}
                                            <button onClick={() => removeCategory('expense', cat)} className="text-red-400 hover:text-red-500"><X size={12}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'rules' && (
                        <div className="px-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                <div className="bg-blue-50 p-3 rounded-lg mb-4 text-xs text-blue-700 border border-blue-100">
                                    <p className="font-bold mb-1 flex items-center gap-1"><Zap size={14}/> Como funciona:</p>
                                    Quando importar um CSV, se a descrição contiver a <b>Palavra Chave</b>, o sistema aplicará a <b>Categoria</b> automaticamente.
                                </div>

                                <div className="space-y-3 mb-6 bg-gray-50 p-3 rounded-xl border border-gray-200">
                                    <h4 className="font-bold text-gray-700 text-sm">Nova Regra</h4>
                                    <div className="flex gap-2">
                                        <select className="bg-white border p-2 rounded-lg text-sm w-1/3" value={newRule.type} onChange={e => setNewRule({...newRule, type: e.target.value, category: ''})}>
                                            <option value="revenue">Receita</option>
                                            <option value="expense">Despesa</option>
                                        </select>
                                        <input type="text" placeholder="Palavra Chave (Ex: DOMINGOS)" className="flex-1 border p-2 rounded-lg text-sm" value={newRule.keyword} onChange={e => setNewRule({...newRule, keyword: e.target.value})} />
                                    </div>
                                    <div className="flex gap-2">
                                        <select className="flex-1 bg-white border p-2 rounded-lg text-sm" value={newRule.category} onChange={e => setNewRule({...newRule, category: e.target.value})}>
                                            <option value="">Escolha a Categoria...</option>
                                            {(newRule.type === 'revenue' ? config.revenueCats : config.expenseCats).map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <button onClick={addRule} className="bg-gray-800 text-white px-4 rounded-lg font-bold text-sm">Adicionar</button>
                                    </div>
                                </div>

                                <h4 className="font-bold text-gray-700 text-sm mb-3">Regras Ativas</h4>
                                <div className="space-y-2">
                                    {config.rules.length === 0 && <p className="text-gray-400 text-center text-sm py-4">Nenhuma regra criada.</p>}
                                    {config.rules.map((rule, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-3 border rounded-lg bg-gray-50 text-sm">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className={`w-2 h-2 rounded-full ${rule.type === 'revenue' ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                                    <span className="font-bold text-gray-800">"{rule.keyword}"</span>
                                                </div>
                                                <div className="text-gray-500 text-xs mt-0.5">vira <span className="font-medium text-gray-700">{rule.category}</span></div>
                                            </div>
                                            <button onClick={() => removeRule(idx)} className="text-red-400 hover:text-red-600"><Trash2 size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Componente: Lista e Ações ---
        const TransactionManager = ({ type, data, onAdd, onImport, onDelete, onUpdate, config }) => {
            const [view, setView] = useState('list');
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], description: '', amount: '', category: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [editItem, setEditItem] = useState(null);

            const isRevenue = type === 'revenue';
            const themeColor = isRevenue ? 'emerald' : 'red';
            // Usando categorias do Config
            const categories = isRevenue ? config.revenueCats : config.expenseCats;

            const filteredData = data.filter(item => 
                item.description.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (item.category && item.category.toLowerCase().includes(searchTerm.toLowerCase()))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            const handleSubmit = async (e) => {
                e.preventDefault();
                await onAdd({ ...formData, amount: parseFloat(formData.amount), type, category: formData.category || 'Outros' });
                setFormData({ date: new Date().toISOString().split('T')[0], description: '', amount: '', category: '' });
                setView('list');
            };

            // Lógica de Importação com Filtro
            const [csvItems, setCsvItems] = useState([]);
            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const parsed = [];
                    lines.forEach((line, idx) => {
                        if (!line.trim()) return;
                        const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g, '').trim()); 
                        if (cols.length < 5) return;
                        
                        let valStr = cols[cols.length - 1] || cols[5];
                        let val = parseFloat(valStr);
                        const isValid = isRevenue ? (val > 0) : (val < 0);
                        
                        if (!isNaN(val) && isValid) {
                            const descOriginal = cols[2] || 'Sem descrição';
                            const descUpper = descOriginal.toUpperCase();

                            // --- REGRA 1: EXCLUSÃO DE INVESTIMENTOS (Só Receitas) ---
                            if (isRevenue) {
                                if (descUpper.includes('CDB') || 
                                    descUpper.includes('RESGATE') || 
                                    descUpper.includes('INVESTIMENTO') ||
                                    descUpper.includes('APLICAÇÃO')) {
                                    return; // Pula este item
                                }
                            }

                            // --- REGRA 2: CATEGORIZAÇÃO AUTOMÁTICA (DINÂMICA) ---
                            let autoCategory = 'Importado';
                            const matchedRule = config.rules.find(r => r.type === type && descUpper.includes(r.keyword));
                            if (matchedRule) {
                                autoCategory = matchedRule.category;
                            }

                            const dParts = cols[0].split('/');
                            const dateIso = dParts.length === 3 ? `${dParts[2]}-${dParts[1]}-${dParts[0]}` : new Date().toISOString().split('T')[0];
                            
                            parsed.push({
                                id: Date.now() + idx,
                                date: dateIso,
                                description: descOriginal,
                                amount: Math.abs(val),
                                category: autoCategory,
                                selected: true
                            });
                        }
                    });
                    setCsvItems(parsed);
                };
                reader.readAsText(file);
            };

            if (view === 'add') {
                return (
                    <div className="p-4 pb-24 fade-in">
                        <div className="flex items-center gap-2 mb-6">
                            <button onClick={() => setView('list')} className="p-2 bg-gray-100 rounded-full"><X size={20}/></button>
                            <h2 className="text-2xl font-bold text-gray-800">Nova {isRevenue ? 'Receita' : 'Despesa'}</h2>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Descrição</label>
                                <input required className="w-full p-3 border rounded-xl" placeholder="Ex: Ração" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
                            </div>
                            <div className="flex gap-3">
                                <div className="w-1/2">
                                    <label className="text-xs font-bold text-gray-500 uppercase">Valor</label>
                                    <input type="number" step="0.01" required className="w-full p-3 border rounded-xl" placeholder="0,00" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} />
                                </div>
                                <div className="w-1/2">
                                    <label className="text-xs font-bold text-gray-500 uppercase">Data</label>
                                    <input type="date" required className="w-full p-3 border rounded-xl" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Categoria</label>
                                <select className="w-full p-3 border rounded-xl bg-white" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>
                                    <option value="">Selecione...</option>
                                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <button type="submit" className={`w-full py-4 rounded-xl text-white font-bold shadow-lg mt-4 bg-${themeColor}-600`}>Salvar</button>
                        </form>
                    </div>
                );
            }

            if (view === 'import') {
                return (
                    <div className="p-4 pb-24 fade-in h-full flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Importar CSV</h2>
                            <button onClick={() => { setView('list'); setCsvItems([]); }} className="text-gray-500">Cancelar</button>
                        </div>
                        
                        {csvItems.length === 0 ? (
                            <div className="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50">
                                <Upload size={48} className="text-gray-400 mb-2"/>
                                <p className="text-gray-500 text-sm mb-4">Selecione o extrato bancário</p>
                                <input type="file" accept=".csv" onChange={e => handleFile(e.target.files[0])} />
                                <div className="bg-blue-50 p-4 rounded-lg mt-6 max-w-xs text-left space-y-2">
                                    <p className="text-xs text-blue-800 font-bold flex items-center gap-1"><Filter size={14}/> Filtros Ativos:</p>
                                    {isRevenue && (
                                        <p className="text-[10px] text-blue-600 leading-tight">
                                            • Ignora CDB, Resgate e Investimentos.
                                        </p>
                                    )}
                                    <p className="text-[10px] text-blue-600 leading-tight">
                                        • Aplica suas <b>{config.rules.filter(r => r.type === type).length} regras</b> de automação.
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <>
                                <div className="flex-1 overflow-y-auto space-y-2 mb-4">
                                    {csvItems.map((item, idx) => (
                                        <div key={idx} className={`p-3 border rounded-lg flex gap-3 ${item.selected ? `border-${themeColor}-500 bg-${themeColor}-50` : 'border-gray-200 opacity-50'}`}>
                                            <input type="checkbox" checked={item.selected} onChange={() => {
                                                const newItems = [...csvItems];
                                                newItems[idx].selected = !newItems[idx].selected;
                                                setCsvItems(newItems);
                                            }} />
                                            <div className="flex-1">
                                                <div className="flex justify-between font-bold text-sm">
                                                    <span>{item.description}</span>
                                                    <span>{formatCurrency(item.amount)}</span>
                                                </div>
                                                <div className="flex justify-between items-center mt-1">
                                                    <span className="text-xs text-gray-500">{formatDate(item.date)}</span>
                                                    <span className={`text-[10px] px-2 py-0.5 rounded-full ${item.category !== 'Importado' ? 'bg-blue-100 text-blue-700 font-bold' : 'bg-gray-100 text-gray-500'}`}>
                                                        {item.category}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button 
                                    onClick={async () => {
                                        const toImport = csvItems.filter(i => i.selected).map(({id, selected, ...rest}) => ({...rest, type, source: 'import'}));
                                        await onImport(toImport);
                                        setView('list');
                                        setCsvItems([]);
                                    }}
                                    disabled={csvItems.filter(i => i.selected).length === 0}
                                    className={`w-full py-3 rounded-xl text-white font-bold shadow bg-${themeColor}-600 disabled:opacity-50`}
                                >
                                    Confirmar Importação ({csvItems.filter(i => i.selected).length})
                                </button>
                            </>
                        )}
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    <header className={`bg-${themeColor}-600 text-white p-6 pb-8 rounded-b-3xl shadow-lg sticky top-0 z-10`}>
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-2xl font-bold">{isRevenue ? 'Receitas' : 'Despesas'}</h1>
                            <div className="flex gap-2">
                                <button onClick={() => setView('import')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Importar CSV"><Upload size={20}/></button>
                                <button onClick={() => setView('add')} className="bg-white text-gray-900 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm active:scale-95 transition"><PlusCircle size={18}/> Novo</button>
                            </div>
                        </div>
                        <div className="relative">
                            <Search className={`absolute left-3 top-3 text-${themeColor}-200`} size={18} />
                            <input type="text" placeholder="Buscar..." className={`w-full pl-10 pr-4 py-2.5 bg-${themeColor}-700 rounded-xl text-white placeholder-${themeColor}-300 focus:outline-none focus:ring-2 focus:ring-white/50`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto p-4 pb-24 space-y-3">
                        {filteredData.length === 0 ? (
                            <div className="text-center py-10 text-gray-400">
                                <p className="mb-2">Nenhum registro.</p>
                                <button onClick={() => setView('import')} className={`text-sm text-${themeColor}-600 font-bold underline`}>Importar Extrato Bancário</button>
                            </div>
                        ) : (
                            filteredData.map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                    {editItem === item.id ? (
                                        <div className="flex-1 flex gap-2">
                                            <input className="border rounded px-2 py-1 w-full" value={item.description} onChange={(e) => onUpdate(item.id, { description: e.target.value })} />
                                            <input type="number" className="border rounded px-2 py-1 w-24" value={item.amount} onChange={(e) => onUpdate(item.id, { amount: parseFloat(e.target.value) })} />
                                            <button onClick={() => setEditItem(null)} className="p-2 bg-green-100 text-green-700 rounded"><Check size={16}/></button>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex-1">
                                                <h3 className="font-bold text-gray-800">{item.description}</h3>
                                                <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                                    <span className="bg-gray-100 px-2 py-0.5 rounded">{formatDate(item.date)}</span>
                                                    <span>{item.category}</span>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className={`font-bold text-lg text-${themeColor}-600`}>{formatCurrency(item.amount)}</div>
                                                <div className="flex justify-end gap-3 mt-1">
                                                    <button onClick={() => setEditItem(item.id)} className="text-gray-400 hover:text-blue-500"><Edit2 size={14}/></button>
                                                    <button onClick={() => onDelete(item.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={14}/></button>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('balance');
            const [revenues, setRevenues] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [config, setConfig] = useState(defaultConfig);

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const qRev = query(collection(db, 'artifacts', appNamespace, 'users', u.uid, 'farm_revenues'), orderBy('date', 'desc'));
                        onSnapshot(qRev, (snap) => setRevenues(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                        const qExp = query(collection(db, 'artifacts', appNamespace, 'users', u.uid, 'farm_expenses'), orderBy('date', 'desc'));
                        onSnapshot(qExp, (snap) => setExpenses(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                        
                        // Carregar Configurações do Firestore
                        onSnapshot(doc(db, 'artifacts', appNamespace, 'users', u.uid, 'config', 'main'), (snap) => {
                            if (snap.exists()) {
                                setConfig(snap.data());
                            } else {
                                // Criar config inicial se não existir
                                setDoc(doc(db, 'artifacts', appNamespace, 'users', u.uid, 'config', 'main'), defaultConfig);
                            }
                        });

                        setLoading(false);
                    } else {
                        setRevenues([]);
                        setExpenses([]);
                        setLoading(false);
                    }
                });
                return () => unsub();
            }, []);

            const addTransaction = async (data) => {
                const collName = data.type === 'revenue' ? 'farm_revenues' : 'farm_expenses';
                await addDoc(collection(db, 'artifacts', appNamespace, 'users', user.uid, collName), { ...data, createdAt: serverTimestamp() });
            };

            const addBulk = async (items) => {
                const batchPromises = items.map(item => {
                    const collName = item.type === 'revenue' ? 'farm_revenues' : 'farm_expenses';
                    return addDoc(collection(db, 'artifacts', appNamespace, 'users', user.uid, collName), { ...item, createdAt: serverTimestamp() });
                });
                await Promise.all(batchPromises);
            };

            const deleteTransaction = async (id, type) => {
                if(!confirm('Tem certeza?')) return;
                const collName = type === 'revenue' ? 'farm_revenues' : 'farm_expenses';
                await deleteDoc(doc(db, 'artifacts', appNamespace, 'users', user.uid, collName, id));
            };

            const updateTransaction = async (id, data, type) => {
                const collName = type === 'revenue' ? 'farm_revenues' : 'farm_expenses';
                await updateDoc(doc(db, 'artifacts', appNamespace, 'users', user.uid, collName, id), data);
            };

            const updateConfig = async (newConfig) => {
                setConfig(newConfig);
                await setDoc(doc(db, 'artifacts', appNamespace, 'users', user.uid, 'config', 'main'), newConfig);
            };

            if (loading) return <div className="h-screen w-full flex items-center justify-center text-emerald-800 font-bold bg-emerald-50">Carregando Sistema...</div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="h-screen w-full flex flex-col font-sans overflow-hidden bg-gray-50">
                    <main className="flex-1 overflow-y-auto">
                        {activeTab === 'balance' && <BalancePanel revenues={revenues} expenses={expenses} />}
                        {activeTab === 'revenues' && <TransactionManager type="revenue" data={revenues} onAdd={addTransaction} onImport={addBulk} onDelete={(id) => deleteTransaction(id, 'revenue')} onUpdate={(id, data) => updateTransaction(id, data, 'revenue')} config={config} />}
                        {activeTab === 'expenses' && <TransactionManager type="expense" data={expenses} onAdd={addTransaction} onImport={addBulk} onDelete={(id) => deleteTransaction(id, 'expense')} onUpdate={(id, data) => updateTransaction(id, data, 'expense')} config={config} />}
                        {activeTab === 'settings' && <SettingsPanel config={config} onUpdateConfig={updateConfig} />}
                    </main>
                    <nav className="bg-white border-t border-gray-200 fixed bottom-0 w-full pb-safe z-50">
                        <div className="flex justify-around items-center h-16">
                            <button onClick={() => setActiveTab('balance')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === 'balance' ? 'text-gray-900' : 'text-gray-400'}`}>
                                <PieChart size={22} strokeWidth={activeTab === 'balance' ? 2.5 : 2} />
                                <span className="text-[10px] font-medium">Balanço</span>
                            </button>
                            <button onClick={() => setActiveTab('revenues')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === 'revenues' ? 'text-emerald-600' : 'text-gray-400'}`}>
                                <ArrowUpCircle size={22} strokeWidth={activeTab === 'revenues' ? 2.5 : 2} />
                                <span className="text-[10px] font-medium">Receitas</span>
                            </button>
                            <button onClick={() => setActiveTab('expenses')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === 'expenses' ? 'text-red-600' : 'text-gray-400'}`}>
                                <ArrowDownCircle size={22} strokeWidth={activeTab === 'expenses' ? 2.5 : 2} />
                                <span className="text-[10px] font-medium">Despesas</span>
                            </button>
                            <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${activeTab === 'settings' ? 'text-blue-600' : 'text-gray-400'}`}>
                                <Settings size={22} strokeWidth={activeTab === 'settings' ? 2.5 : 2} />
                                <span className="text-[10px] font-medium">Ajustes</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
