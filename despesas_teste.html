<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Despesas WM - Mobile</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        /* Esconde scrollbar mas permite scroll */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Safe Area para iPhones novos */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURAÇÃO FIREBASE (Do seu arquivo original) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- CONSTANTES ---
        const CATEGORIAS = {
            "Pecuária": ["Alimentação", "Medicamentos", "Sanidade", "Reprodução"],
            "Agricultura": ["Insumos", "Fertilizantes", "Sementes", "Mão de Obra"],
            "Infraestrutura": ["Manutenção Predial", "Equipamentos", "Veículos", "Ferramentas"],
            "Administrativo": ["Impostos", "Serviços", "Salários"],
            "Outros": ["Diversos"]
        };

        // --- COMPONENTES UI ---

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-4 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, variant = 'primary', className = "", type = "button" }) => {
            const baseClass = "flex items-center justify-center font-medium rounded-lg px-4 py-3 w-full transition-colors active:scale-95";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md shadow-blue-200",
                danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100",
                ghost: "bg-transparent text-gray-600 hover:bg-gray-50"
            };
            return (
                <button type={type} onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        // --- COMPONENTE: LOGIN ---
        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50">
                <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-200">
                    <Icon name="tractor" className="text-white" size={32} />
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">Fazenda WM</h1>
                <p className="text-gray-500 mb-8 text-center">Gestão financeira simplificada para o dia a dia.</p>
                <Button onClick={onLogin}>
                    <Icon name="log-in" className="mr-2" size={20} /> Entrar com Google
                </Button>
            </div>
        );

        // --- COMPONENTE: LISTA DE DESPESAS (HOME) ---
        const ExpenseList = ({ expenses, onDelete }) => {
            const [filter, setFilter] = useState('');

            const filtered = useMemo(() => {
                if (!filter) return expenses.slice(0, 50); // Limita a 50 p/ performance
                const lower = filter.toLowerCase();
                return expenses.filter(e => 
                    e.Descrição?.toLowerCase().includes(lower) || 
                    e.Categoria?.toLowerCase().includes(lower)
                );
            }, [expenses, filter]);

            return (
                <div className="pb-24 pt-4 px-4 space-y-4">
                    <div className="sticky top-0 bg-gray-50/95 backdrop-blur z-10 py-2">
                        <div className="relative">
                            <Icon name="search" className="absolute left-3 top-3 text-gray-400" size={20} />
                            <input 
                                type="text" 
                                placeholder="Buscar despesa..." 
                                className="w-full pl-10 pr-4 py-3 rounded-xl border-none bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                value={filter}
                                onChange={(e) => setFilter(e.target.value)}
                            />
                        </div>
                    </div>

                    <div className="space-y-3">
                        {filtered.length === 0 ? (
                            <div className="text-center py-10 text-gray-400">
                                <Icon name="inbox" className="mx-auto mb-2 opacity-50" />
                                <p>Nenhuma despesa encontrada.</p>
                            </div>
                        ) : (
                            filtered.map(item => (
                                <Card key={item.docId} className="flex justify-between items-center active:bg-gray-50">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">
                                                {item.Categoria}
                                            </span>
                                            <span className="text-xs text-gray-400">
                                                {new Date(item.Data).toLocaleDateString('pt-BR')}
                                            </span>
                                        </div>
                                        <h3 className="font-semibold text-gray-800">{item.Descrição}</h3>
                                        <p className="text-sm text-gray-500">{item['Sub Categoria']}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-gray-900 text-lg">
                                            {item.Total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                        </p>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); if(confirm('Excluir?')) onDelete(item.docId); }}
                                            className="text-red-400 p-2 -mr-2"
                                        >
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>
                                </Card>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: NOVA DESPESA ---
        const AddExpense = ({ onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                Data: new Date().toISOString().split('T')[0],
                Categoria: '',
                SubCategoria: '',
                Descrição: '',
                Quantidade: 1,
                PrecoUnitario: '',
                Total: 0
            });
            const [loading, setLoading] = useState(false);

            // Atualiza total automático
            useEffect(() => {
                const total = (parseFloat(formData.Quantidade) || 0) * (parseFloat(formData.PrecoUnitario) || 0);
                setFormData(prev => ({ ...prev, Total: total }));
            }, [formData.Quantidade, formData.PrecoUnitario]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await onSave(formData);
                } catch (error) {
                    alert("Erro: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white pb-24">
                    <div className="sticky top-0 bg-white border-b px-4 py-4 flex items-center justify-between z-20">
                        <button onClick={onCancel} className="text-gray-500"><Icon name="x" /></button>
                        <h2 className="font-bold text-lg">Nova Despesa</h2>
                        <div className="w-6"></div> {/* Spacer */}
                    </div>

                    <form onSubmit={handleSubmit} className="p-4 space-y-5">
                        {/* Valor Grande */}
                        <div className="bg-gray-50 p-4 rounded-xl text-center">
                            <label className="text-xs text-gray-500 uppercase tracking-wide">Valor Total</label>
                            <div className="flex items-center justify-center text-3xl font-bold text-gray-900 mt-1">
                                <span className="text-lg mr-1">R$</span>
                                {formData.Total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                            </div>
                        </div>

                        <div>
                            <label className="label-text">O que foi comprado? *</label>
                            <input required type="text" className="input-field" placeholder="Ex: Ração, Gasolina..." 
                                value={formData.Descrição} 
                                onChange={e => setFormData({...formData, Descrição: e.target.value})} />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="label-text">Categoria *</label>
                                <select required className="input-field"
                                    value={formData.Categoria}
                                    onChange={e => setFormData({...formData, Categoria: e.target.value, SubCategoria: ''})}>
                                    <option value="">Selecione</option>
                                    {Object.keys(CATEGORIAS).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="label-text">Sub *</label>
                                <select required className="input-field" disabled={!formData.Categoria}
                                    value={formData.SubCategoria}
                                    onChange={e => setFormData({...formData, SubCategoria: e.target.value})}>
                                    <option value="">Selecione</option>
                                    {formData.Categoria && CATEGORIAS[formData.Categoria].map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                             <div>
                                <label className="label-text">Qtd</label>
                                <input type="number" step="any" className="input-field text-center" 
                                    value={formData.Quantidade}
                                    onChange={e => setFormData({...formData, Quantidade: e.target.value})} />
                            </div>
                            <div>
                                <label className="label-text">Preço Unit.</label>
                                <input required type="number" step="any" className="input-field" placeholder="0,00"
                                    value={formData.PrecoUnitario}
                                    onChange={e => setFormData({...formData, PrecoUnitario: e.target.value})} />
                            </div>
                        </div>

                        <div>
                            <label className="label-text">Data</label>
                            <input type="date" className="input-field" 
                                value={formData.Data}
                                onChange={e => setFormData({...formData, Data: e.target.value})} />
                        </div>

                        <div className="pt-4">
                            <Button type="submit" variant="primary" disabled={loading}>
                                {loading ? 'Salvando...' : 'Salvar Despesa'}
                            </Button>
                        </div>
                    </form>
                </div>
            );
        };

        // --- COMPONENTE: DASHBOARD ---
        const Dashboard = ({ expenses }) => {
            const chartRef = useRef(null);
            
            // Cálculos
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthExpenses = expenses.filter(e => {
                const d = new Date(e.Data);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            
            const totalMonth = monthExpenses.reduce((sum, e) => sum + e.Total, 0);

            // Preparar dados do gráfico
            useEffect(() => {
                if (!chartRef.current) return;
                
                const cats = {};
                monthExpenses.forEach(e => {
                    cats[e.Categoria] = (cats[e.Categoria] || 0) + e.Total;
                });

                const ctx = chartRef.current.getContext('2d');
                
                // Destruir anterior se existir
                if (window.myChart) window.myChart.destroy();

                window.myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(cats),
                        datasets: [{
                            data: Object.values(cats),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '70%',
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }, [expenses]);

            return (
                <div className="pb-24 pt-6 px-4 space-y-6">
                    <h2 className="text-xl font-bold text-gray-800">Visão Geral</h2>
                    
                    <Card className="bg-gradient-to-br from-blue-600 to-blue-800 text-white border-none">
                        <p className="text-blue-100 text-sm font-medium mb-1">Total este Mês</p>
                        <h3 className="text-3xl font-bold">
                            {totalMonth.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                        </h3>
                        <div className="mt-4 flex items-center text-xs text-blue-200">
                            <Icon name="calendar" size={14} className="mr-1" />
                            {new Date().toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}
                        </div>
                    </Card>

                    <Card>
                        <h4 className="font-semibold mb-4 text-gray-700">Por Categoria (Mês)</h4>
                        <div className="h-64">
                            <canvas ref={chartRef}></canvas>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL (APP) ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); // 'list', 'add', 'dashboard'
            const [expenses, setExpenses] = useState([]);
            const [loadingData, setLoadingData] = useState(false);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) loadData();
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                lucide.createIcons();
            }, [view, user]);

            const loadData = async () => {
                setLoadingData(true);
                try {
                    const snap = await db.collection("despesas").orderBy("Data", "desc").limit(100).get();
                    const data = snap.docs.map(doc => {
                        const d = doc.data();
                        // Conversão de dados legados do seu sistema original
                        let dateObj = new Date();
                        if (typeof d.Data === 'string' && d.Data.includes('-')) dateObj = new Date(d.Data + 'T00:00:00');
                        
                        // Parse Total
                        let total = d.Total;
                        if (typeof total === 'string') {
                            total = parseFloat(total.replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
                        }

                        return { docId: doc.id, ...d, Data: dateObj.toISOString(), Total: total };
                    });
                    setExpenses(data);
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoadingData(false);
                }
            };

            const handleLogin = () => auth.signInWithPopup(provider);
            const handleLogout = () => auth.signOut();

            const handleSaveExpense = async (data) => {
                const payload = {
                    ...data,
                    "Sub Categoria": data.SubCategoria, // Mantendo compatibilidade com nome antigo
                    Total: parseFloat(data.Total),
                    Quantidade: parseFloat(data.Quantidade),
                    Timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                delete payload.SubCategoria;

                await db.collection("despesas").add(payload);
                await loadData(); // Recarrega
                setView('list');
            };

            const handleDelete = async (id) => {
                await db.collection("despesas").doc(id).delete();
                setExpenses(prev => prev.filter(e => e.docId !== id));
            };

            if (!user) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="max-w-md mx-auto bg-gray-50 min-h-screen relative shadow-2xl">
                    
                    {/* Renderização Condicional das Telas */}
                    {view === 'list' && <ExpenseList expenses={expenses} onDelete={handleDelete} />}
                    {view === 'dashboard' && <Dashboard expenses={expenses} />}
                    {view === 'add' && <AddExpense onSave={handleSaveExpense} onCancel={() => setView('list')} />}

                    {/* Bottom Navigation (Só aparece se não estiver adicionando) */}
                    {view !== 'add' && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe z-30 max-w-md mx-auto">
                            <div className="flex justify-around items-center h-16">
                                <button onClick={() => setView('list')} className={`flex flex-col items-center justify-center w-full h-full ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}>
                                    <Icon name="list" size={24} />
                                    <span className="text-[10px] font-medium mt-1">Extrato</span>
                                </button>

                                <div className="relative -top-5">
                                    <button onClick={() => setView('add')} className="bg-blue-600 text-white rounded-full p-4 shadow-lg shadow-blue-300 hover:scale-105 transition-transform">
                                        <Icon name="plus" size={28} />
                                    </button>
                                </div>

                                <button onClick={() => setView('dashboard')} className={`flex flex-col items-center justify-center w-full h-full ${view === 'dashboard' ? 'text-blue-600' : 'text-gray-400'}`}>
                                    <Icon name="pie-chart" size={24} />
                                    <span className="text-[10px] font-medium mt-1">Visão</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <style>
        /* Utilitários Extras Tailwind via CSS puro para componentes dinâmicos */
        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 16px; /* Evita zoom no iPhone */
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            background-color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .label-text {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
    </style>
</body>
</html>
