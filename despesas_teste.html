<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Despesas WM - Mobile</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- UTILITÁRIOS ---
        const parseDate = (dateVal) => {
            if (!dateVal) return new Date();
            if (dateVal && typeof dateVal.toDate === 'function') return dateVal.toDate();
            if (typeof dateVal === 'string') {
                if (dateVal.includes('/')) {
                    const parts = dateVal.split('/');
                    if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0], 12, 0, 0);
                }
                if (dateVal.includes('-')) return new Date(dateVal + 'T12:00:00');
            }
            return new Date();
        };

        const formatMoney = (val) => {
            if (typeof val === 'number') return val;
            if (typeof val === 'string') {
                return parseFloat(val.replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
            }
            return 0;
        };

        const CATEGORIAS = {
            "Pecuária": ["Alimentação", "Medicamentos", "Sanidade", "Reprodução"],
            "Agricultura": ["Insumos", "Fertilizantes", "Sementes", "Mão de Obra"],
            "Infraestrutura": ["Manutenção Predial", "Equipamentos", "Veículos", "Ferramentas"],
            "Administrativo": ["Impostos", "Serviços", "Salários"],
            "Outros": ["Diversos"]
        };

        // --- COMPONENTES UI ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Card = ({ item, onDelete }) => {
            const getCategoryColor = (cat) => {
                const map = { 'Pecuária': 'border-green-500', 'Agricultura': 'border-yellow-500', 'Infraestrutura': 'border-gray-500', 'Administrativo': 'border-blue-500', 'Outros': 'border-purple-500' };
                return map[cat] || 'border-gray-200';
            };

            return (
                <div className={`bg-white rounded-xl shadow-sm border-l-4 p-4 mb-3 ${getCategoryColor(item.Categoria)} flex justify-between items-start`}>
                    <div className="flex-1 pr-2">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="text-xs font-bold text-gray-500 uppercase tracking-wide flex items-center gap-1">
                                <Icon name="calendar" size={12} />
                                {item.dateObj.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'})}
                            </span>
                            <span className="text-[10px] bg-gray-100 px-2 py-0.5 rounded-full text-gray-600 border border-gray-200">
                                {item.Categoria}
                            </span>
                        </div>
                        <h3 className="font-bold text-gray-800 text-base leading-tight">{item.Descrição || "Sem descrição"}</h3>
                        <p className="text-xs text-gray-500 mt-1">{item['Sub Categoria']} {item.Observações ? `• ${item.Observações}` : ''}</p>
                    </div>
                    <div className="flex flex-col items-end justify-between h-full gap-2">
                        <span className="font-bold text-gray-900 text-lg whitespace-nowrap">
                            {item.rawTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                        </span>
                        {onDelete && (
                            <button onClick={() => { if(confirm('Apagar registro?')) onDelete(item.docId); }} className="text-red-400 p-2 -mr-2">
                                <Icon name="trash-2" size={18} />
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- TELA 1: LISTA (Extrato) ---
        const ExpenseList = ({ expenses, onDelete }) => {
            const filtered = useMemo(() => expenses.slice(0, 50), [expenses]); 

            return (
                <div className="pb-24 pt-4 px-3">
                    <h2 className="text-xl font-bold text-gray-800 mb-4 px-1">Últimos Lançamentos</h2>
                    {filtered.length === 0 ? (
                        <div className="text-center py-12 opacity-50"><p>Carregando ou sem dados...</p></div>
                    ) : (
                        filtered.map(item => <Card key={item.docId} item={item} onDelete={onDelete} />)
                    )}
                </div>
            );
        };

        // --- TELA 2: NOVO REGISTRO (Corrigido) ---
        const AddExpense = ({ onSave }) => {
            const [formData, setFormData] = useState({
                Data: new Date().toISOString().split('T')[0],
                Categoria: '', SubCategoria: '', Descrição: '', Quantidade: 1, PrecoUnitario: '', Total: 0, Observações: ''
            });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const q = parseFloat(formData.Quantidade) || 0;
                const p = parseFloat(formData.PrecoUnitario) || 0;
                setFormData(prev => ({ ...prev, Total: q * p }));
            }, [formData.Quantidade, formData.PrecoUnitario]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                // Chama o onSave do pai e não faz mais nada depois, 
                // pois o componente pai vai desmontar este componente (trocar de tela)
                try {
                    await onSave(formData);
                } catch (err) {
                    console.error(err);
                    setLoading(false); // Só destrava se der erro
                    alert("Erro ao salvar: " + err.message);
                }
            };

            const inputClass = "w-full p-3 bg-gray-50 rounded-lg border border-gray-200 focus:ring-2 focus:ring-green-500 outline-none transition-all text-base font-medium text-gray-800";
            const labelClass = "block text-xs font-bold text-gray-500 uppercase mb-1 ml-1";

            return (
                <div className="pb-24 pt-4 px-4 bg-white min-h-screen">
                    <h2 className="text-xl font-bold text-gray-800 mb-6">Novo Registro</h2>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        
                        {/* Data e Descrição: Um abaixo do outro (Stack) */}
                        <div>
                            <label className={labelClass}>Data</label>
                            <input type="date" required className={inputClass} 
                                value={formData.Data} onChange={e => setFormData({...formData, Data: e.target.value})} />
                        </div>
                        
                        <div>
                            <label className={labelClass}>Descrição</label>
                            <input type="text" required placeholder="O que foi comprado?" className={inputClass}
                                value={formData.Descrição} onChange={e => setFormData({...formData, Descrição: e.target.value})} />
                        </div>

                        {/* Categoria e Sub */}
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className={labelClass}>Categoria</label>
                                <select required className={inputClass}
                                    value={formData.Categoria} onChange={e => setFormData({...formData, Categoria: e.target.value, SubCategoria: ''})}>
                                    <option value="">Selecione</option>
                                    {Object.keys(CATEGORIAS).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className={labelClass}>Sub</label>
                                <select required disabled={!formData.Categoria} className={`${inputClass} disabled:opacity-50`}
                                    value={formData.SubCategoria} onChange={e => setFormData({...formData, SubCategoria: e.target.value})}>
                                    <option value="">...</option>
                                    {formData.Categoria && CATEGORIAS[formData.Categoria].map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* Qtd e Preço */}
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className={labelClass}>Qtd</label>
                                <input type="number" step="any" className={`${inputClass} text-center`}
                                    value={formData.Quantidade} onChange={e => setFormData({...formData, Quantidade: e.target.value})} />
                            </div>
                            <div>
                                <label className={labelClass}>Preço Unit. (R$)</label>
                                <input type="number" step="any" required placeholder="0,00" className={inputClass}
                                    value={formData.PrecoUnitario} onChange={e => setFormData({...formData, PrecoUnitario: e.target.value})} />
                            </div>
                        </div>

                        {/* Total */}
                        <div className="bg-green-50 rounded-lg p-3 flex justify-between items-center border border-green-100">
                            <span className="text-green-700 font-bold text-sm uppercase">Total</span>
                            <span className="text-xl font-bold text-green-800">
                                {formData.Total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                            </span>
                        </div>

                        {/* Observações */}
                        <div>
                            <label className={labelClass}>Observações (Opcional)</label>
                            <textarea rows="2" className={inputClass} placeholder="Detalhes extras..."
                                value={formData.Observações} onChange={e => setFormData({...formData, Observações: e.target.value})}></textarea>
                        </div>

                        <button disabled={loading} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-transform active:scale-95 mt-4 flex justify-center items-center gap-2">
                            {loading ? 'Salvando...' : <><Icon name="check" size={20} /> Salvar Registro</>}
                        </button>
                    </form>
                </div>
            );
        };

        // --- TELA 3: BUSCA AVANÇADA ---
        const AdvancedSearch = ({ expenses, onDelete }) => {
            const [filters, setFilters] = useState({ start: '', end: '', cat: '', term: '' });
            
            const results = useMemo(() => {
                return expenses.filter(e => {
                    const d = new Date(e.Data);
                    const start = filters.start ? new Date(filters.start) : null;
                    const end = filters.end ? new Date(filters.end) : null;
                    if (start) start.setHours(0,0,0,0);
                    if (end) end.setHours(23,59,59,999);
                    const current = e.dateObj; 

                    if (start && current < start) return false;
                    if (end && current > end) return false;
                    if (filters.cat && e.Categoria !== filters.cat) return false;
                    if (filters.term) {
                        const t = filters.term.toLowerCase();
                        if (!e.Descrição?.toLowerCase().includes(t) && !e['Sub Categoria']?.toLowerCase().includes(t)) return false;
                    }
                    return true;
                });
            }, [expenses, filters]);

            const totalSum = results.reduce((acc, curr) => acc + curr.rawTotal, 0);
            const inputClass = "w-full p-2 bg-white rounded border border-gray-300 text-sm";

            return (
                <div className="pb-24 pt-4 px-4 bg-gray-50 min-h-screen">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">Busca Avançada</h2>
                    
                    <div className="bg-white p-4 rounded-xl shadow-sm mb-4 space-y-3">
                        <div className="flex gap-2">
                            <div className="w-1/2">
                                <label className="text-xs text-gray-500 font-bold block mb-1">Início</label>
                                <input type="date" className={inputClass} value={filters.start} onChange={e=>setFilters({...filters, start: e.target.value})} />
                            </div>
                            <div className="w-1/2">
                                <label className="text-xs text-gray-500 font-bold block mb-1">Fim</label>
                                <input type="date" className={inputClass} value={filters.end} onChange={e=>setFilters({...filters, end: e.target.value})} />
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <div className="w-1/2">
                                <label className="text-xs text-gray-500 font-bold block mb-1">Categoria</label>
                                <select className={inputClass} value={filters.cat} onChange={e=>setFilters({...filters, cat: e.target.value})}>
                                    <option value="">Todas</option>
                                    {Object.keys(CATEGORIAS).map(c=><option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div className="w-1/2">
                                <label className="text-xs text-gray-500 font-bold block mb-1">Termo</label>
                                <input type="text" placeholder="Buscar..." className={inputClass} value={filters.term} onChange={e=>setFilters({...filters, term: e.target.value})} />
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-between items-center mb-4 px-2">
                        <span className="text-sm text-gray-500">{results.length} resultados</span>
                        <span className="font-bold text-green-600 text-lg">{totalSum.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</span>
                    </div>

                    <div>
                        {results.map(item => <Card key={item.docId} item={item} onDelete={onDelete} />)}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); 
            const [expenses, setExpenses] = useState([]);
            
            useEffect(() => {
                auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) loadData();
                });
            }, []);

            const loadData = async () => {
                try {
                    const snapshot = await db.collection("despesas").get();
                    const processed = snapshot.docs.map(doc => {
                        const d = doc.data();
                        return { docId: doc.id, ...d, dateObj: parseDate(d.Data), rawTotal: formatMoney(d.Total) };
                    });
                    processed.sort((a, b) => b.dateObj - a.dateObj);
                    setExpenses(processed);
                } catch (error) { console.error(error); }
            };

            const handleSave = async (data) => {
                const payload = {
                    "Data": data.Data,
                    "Categoria": data.Categoria,
                    "Sub Categoria": data.SubCategoria,
                    "Descrição": data.Descrição,
                    "Quantidade": parseFloat(data.Quantidade),
                    "Preço Unitário": parseFloat(data.PrecoUnitario),
                    "Total": parseFloat(data.Total),
                    "Observações": data.Observações,
                    "Timestamp": firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection("despesas").add(payload);
                await loadData(); // Recarrega os dados
                alert('Salvo com sucesso!');
                setView('list'); // Retorna para a tela de extrato (Resolve a tela branca)
            };

            const handleDelete = async (id) => {
                await db.collection("despesas").doc(id).delete();
                setExpenses(prev => prev.filter(e => e.docId !== id));
            };

            if (!user) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-100">
                    <h1 className="text-2xl font-bold mb-8">Fazenda WM</h1>
                    <button onClick={() => auth.signInWithPopup(provider)} className="bg-white px-6 py-3 rounded shadow font-bold text-gray-700 flex items-center gap-2">
                        <Icon name="log-in" /> Entrar com Google
                    </button>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-100 relative shadow-2xl overflow-hidden">
                    
                    {/* Área de Conteúdo */}
                    {view === 'list' && <ExpenseList expenses={expenses} onDelete={handleDelete} />}
                    {view === 'add' && <AddExpense onSave={handleSave} />}
                    {view === 'search' && <AdvancedSearch expenses={expenses} onDelete={handleDelete} />}

                    {/* Menu Inferior Fixo */}
                    <nav className="fixed bottom-0 w-full max-w-md bg-white border-t flex justify-around items-center h-16 pb-safe z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                        <button onClick={() => setView('list')} className={`flex flex-col items-center w-full transition-colors ${view === 'list' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <Icon name="list" size={24} />
                            <span className="text-[10px] mt-1 font-medium">Extrato</span>
                        </button>
                        
                        <div className="relative -top-6">
                            <button onClick={() => setView('add')} className={`text-white p-4 rounded-full shadow-lg transition-transform active:scale-90 ${view === 'add' ? 'bg-blue-700 ring-4 ring-blue-100' : 'bg-blue-600'}`}>
                                <Icon name="plus" size={32} />
                            </button>
                        </div>

                        <button onClick={() => setView('search')} className={`flex flex-col items-center w-full transition-colors ${view === 'search' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <Icon name="search" size={24} />
                            <span className="text-[10px] mt-1 font-medium">Busca</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
