<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despesas WM - React</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React e ReactDOM (Versão 17 é mais estável para Single File via CDN) -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Chart.js (Nativo, super estável) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 5. Firebase v8 (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">
    
    <!-- Fallback de Carregamento (Se o React falhar, isso fica na tela) -->
    <div id="root" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Carregando sistema...</p>
        </div>
    </div>

    <!-- CÓDIGO REACT -->
    <script type="text/babel">
        // Globais do React
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ÍCONES SVG (Inline para evitar erros de importação) ---
        const Icons = {
            DollarSign: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
            LogOut: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
            LayoutDashboard: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            FileText: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            AlertCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
            Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Edit2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            CheckCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Calendar: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Filter: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        };

        // --- FIREBASE CONFIG ---
        const getFirebaseConfig = () => {
             if (typeof __firebase_config !== 'undefined') {
                return JSON.parse(__firebase_config);
            }
            return { apiKey: "API_KEY_AQUI", authDomain: "demo.firebaseapp.com", projectId: "demo" };
        };

        const firebaseConfig = getFirebaseConfig();
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch(e) { console.error("Firebase Init Error:", e); }
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';

        // --- CONSTANTES ---
        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        const parseDate = (dStr) => {
            if(!dStr) return new Date();
            if(dStr.match(/^\d{4}-\d{2}-\d{2}$/)) return new Date(dStr+'T00:00:00');
            const p = dStr.split('/');
            return p.length===3 ? new Date(p[2], p[1]-1, p[0]) : new Date();
        };

        const CATEGORIAS_PADRAO = {
            "Pecuária": ["Alimentação", "Medicamentos", "Sanidade", "Reprodução"],
            "Agricultura": ["Insumos", "Fertilizantes", "Sementes", "Mão de Obra"],
            "Infraestrutura": ["Manutenção Predial", "Equipamentos", "Veículos", "Ferramentas"],
            "Administrativo": ["Impostos", "Serviços", "Salários"],
            "Outros": ["Diversos"]
        };
        const MESES = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        // --- COMPONENTE DE GRÁFICO (Chart.js Wrapper) ---
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                
                // Destrói gráfico anterior
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // Cria novo gráfico
                chartRef.current = new Chart(canvasRef.current, {
                    type: type,
                    data: data,
                    options: {
                        ...options,
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [data, type, options]);

            return <div className="relative w-full h-64"><canvas ref={canvasRef}></canvas></div>;
        };

        // --- COMPONENTE MODAL ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 fade-in">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-white">{title}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-red-500">
                                <Icons.X size={24} />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [expenses, setExpenses] = useState([]);
            const [extrato, setExtrato] = useState([]);
            
            // Filtros
            const [filterYear, setFilterYear] = useState(new Date().getFullYear().toString());
            const [filterMonth, setFilterMonth] = useState('all');
            const [filterCategory, setFilterCategory] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');

            // Form
            const [isFormOpen, setIsFormOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [conciliatingId, setConciliatingId] = useState(null);
            const [formData, setFormData] = useState({
                Data: new Date().toISOString().split('T')[0], Categoria: '', SubCategoria: '',
                Tipo: '', Descricao: '', Quantidade: 1, PrecoUnitario: 0, Total: 0, Observacoes: ''
            });

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if(u) loadData(u);
                });
                return () => unsubscribe();
            }, []);

            const loadData = (currentUser) => {
                const basePath = `artifacts/${appId}/users/${currentUser.uid}`;
                
                db.collection(basePath + '/despesas').onSnapshot(snap => {
                    const d = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    d.sort((a,b) => new Date(b.Data) - new Date(a.Data));
                    setExpenses(d);
                });

                db.collection(basePath + '/extrato_bancario')
                  .where('conciliado', '==', false)
                  .onSnapshot(snap => {
                    const d = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    setExtrato(d);
                });
            };

            // Filtragem
            const filteredExpenses = useMemo(() => {
                return expenses.filter(exp => {
                    const d = parseDate(exp.Data);
                    const ym = filterYear === 'all' || d.getFullYear().toString() === filterYear;
                    const mm = filterMonth === 'all' || d.getMonth().toString() === filterMonth;
                    const cm = filterCategory === 'all' || exp.Categoria === filterCategory;
                    const term = searchTerm.toLowerCase();
                    const sm = !term || (exp.Descricao||'').toLowerCase().includes(term) || (exp.Categoria||'').toLowerCase().includes(term);
                    return ym && mm && cm && sm;
                });
            }, [expenses, filterYear, filterMonth, filterCategory, searchTerm]);

            const totalFiltered = filteredExpenses.reduce((acc, curr) => acc + (curr.Total || 0), 0);

            // Dados para Gráficos
            const chartDataCategory = useMemo(() => {
                const agg = {};
                filteredExpenses.forEach(e => agg[e.Categoria] = (agg[e.Categoria]||0) + e.Total);
                return {
                    labels: Object.keys(agg),
                    datasets: [{
                        data: Object.values(agg),
                        backgroundColor: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1']
                    }]
                };
            }, [filteredExpenses]);

            const chartDataMonthly = useMemo(() => {
                const data = new Array(12).fill(0);
                filteredExpenses.forEach(e => {
                    const d = parseDate(e.Data);
                    if (filterYear !== 'all' && d.getFullYear().toString() !== filterYear) return;
                    data[d.getMonth()] += e.Total;
                });
                return {
                    labels: MESES.map(m => m.substring(0,3)),
                    datasets: [{
                        label: 'Total Mensal',
                        data: data,
                        backgroundColor: '#3B82F6',
                        borderRadius: 4
                    }]
                };
            }, [filteredExpenses, filterYear]);

            // Handlers
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                let newFormData = { ...formData, [name]: value };
                if (name === 'Quantidade' || name === 'PrecoUnitario') {
                    const qtd = name === 'Quantidade' ? parseFloat(value) : parseFloat(formData.Quantidade);
                    const pu = name === 'PrecoUnitario' ? parseFloat(value) : parseFloat(formData.PrecoUnitario);
                    newFormData.Total = (qtd || 0) * (pu || 0);
                }
                if (name === 'Categoria') newFormData.SubCategoria = '';
                setFormData(newFormData);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                const basePath = `artifacts/${appId}/users/${user.uid}`;
                const payload = { ...formData, Quantidade: parseFloat(formData.Quantidade), PrecoUnitario: parseFloat(formData.PrecoUnitario), Total: parseFloat(formData.Total), updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                
                try {
                    if (editingId) {
                        await db.collection(basePath + '/despesas').doc(editingId).update(payload);
                    } else if (conciliatingId) {
                        const batch = db.batch();
                        batch.set(db.collection(basePath + '/despesas').doc(), { ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        batch.update(db.collection(basePath + '/extrato_bancario').doc(conciliatingId), { conciliado: true });
                        await batch.commit();
                    } else {
                        await db.collection(basePath + '/despesas').add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                    setIsFormOpen(false); resetForm();
                } catch(err) { alert("Erro: " + err.message); }
            };

            const handleDelete = async (id) => {
                if(confirm("Excluir?")) await db.collection(`artifacts/${appId}/users/${user.uid}/despesas`).doc(id).delete();
            };
             const handleDeleteExtrato = async (id) => {
                if(confirm("Ignorar?")) await db.collection(`artifacts/${appId}/users/${user.uid}/extrato_bancario`).doc(id).delete();
            };

            const resetForm = () => {
                setEditingId(null); setConciliatingId(null);
                setFormData({ Data: new Date().toISOString().split('T')[0], Categoria: '', SubCategoria: '', Tipo: '', Descricao: '', Quantidade: 1, PrecoUnitario: 0, Total: 0, Observacoes: '' });
            };
             const openEdit = (exp) => {
                setEditingId(exp.id);
                setFormData({ ...exp, Data: exp.Data.includes('T') ? exp.Data.split('T')[0] : exp.Data });
                setIsFormOpen(true);
            };

            const openConciliate = (item) => {
                setConciliatingId(item.id);
                const val = Math.abs(parseFloat(item.Valor));
                let dateVal = new Date().toISOString().split('T')[0];
                if (item.Data) {
                    const parts = item.Data.split('/');
                    if (parts.length === 3) dateVal = `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                setFormData({
                    Data: dateVal, Categoria: '', SubCategoria: '', Tipo: 'Extrato',
                    Descricao: item.Detalhes || item.Lancamento,
                    Quantidade: 1, PrecoUnitario: val, Total: val,
                    Observacoes: `Conciliado documento: ${item.docId || 'N/A'}`
                });
                setIsFormOpen(true);
            };

             // CSV Handlers (Simplificados para garantir funcionamento)
            const handleExpenseCSV = (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = async (ev) => {
                    const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim());
                    const hIdx = lines.findIndex(l => l.toLowerCase().includes('data'));
                    if(hIdx === -1) { alert("CSV inválido"); return; }
                    const headers = lines[hIdx].split(';').map(h=>h.trim());
                    const batch = db.batch(); let c=0;
                    lines.slice(hIdx+1).forEach(row => {
                         const cols = row.split(';'); if(cols.length<2) return;
                         const o={}; headers.forEach((h,i)=>o[h]=cols[i]?.replace(/"/g,'')||'');
                         const val = parseFloat((o['Total']||'0').replace(/\./g,'').replace(',','.'));
                         const dp = (o['Data']||'').split('/');
                         const iso = dp.length===3 ? `${dp[2]}-${dp[1]}-${dp[0]}` : new Date().toISOString().split('T')[0];
                         const ref = db.collection(`artifacts/${appId}/users/${user.uid}/despesas`).doc();
                         batch.set(ref, {
                            Data: iso, Categoria: o['Categoria']||'Outros', SubCategoria: o['Sub Categoria']||'',
                            Tipo: o['Tipo']||'', Descricao: o['Descrição']||'', Quantidade: 1,
                            PrecoUnitario: val, Total: val, Observacoes: o['Observações']||'', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                         });
                         c++;
                    });
                    if(c>0) await batch.commit();
                };
                r.readAsText(file, 'ISO-8859-1');
            };

            const handleExtratoCSV = (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = async (ev) => {
                    const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim());
                    if(lines.length===0) return;
                    const sep = lines[0].includes(';') ? ';' : ',';
                    let hIdx=-1, headers=[];
                    for(let i=0;i<Math.min(lines.length,20);i++) {
                        if(lines[i].toLowerCase().includes('data') && lines[i].toLowerCase().includes('valor')) {
                            hIdx=i; headers=lines[i].split(sep).map(h=>h.replace(/"/g,'').trim().toLowerCase()); break;
                        }
                    }
                    if(hIdx===-1) return alert("Erro colunas extrato");
                    const iData = headers.findIndex(h=>h.includes('data'));
                    const iVal = headers.findIndex(h=>h.includes('valor'));
                    const iDesc = headers.findIndex(h=>h.includes('histórico')||h.includes('descrição')||h.includes('lançamento'));
                    
                    const batch = db.batch(); let c=0;
                    lines.slice(hIdx+1).forEach(l => {
                        const cols = l.split(sep).map(v=>v.replace(/"/g,'').trim());
                        if(cols.length <= Math.max(iData, iVal)) return;
                        let val = cols[iVal].includes(',') ? parseFloat(cols[iVal].replace('.','').replace(',','.')) : parseFloat(cols[iVal]);
                        if(val<0) {
                             const ref = db.collection(`artifacts/${appId}/users/${user.uid}/extrato_bancario`).doc();
                             batch.set(ref, {
                                Data: cols[iData], Valor: val, Lancamento: iDesc!==-1?cols[iDesc]:'', conciliado: false
                             });
                             c++;
                        }
                    });
                    if(c>0) await batch.commit();
                };
                r.readAsText(file, 'ISO-8859-1');
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                            <div className="bg-blue-100 dark:bg-blue-900/30 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icons.DollarSign className="w-10 h-10 text-blue-600 dark:text-blue-400" />
                            </div>
                            <h1 className="text-3xl font-bold mb-2 text-gray-800 dark:text-white">Despesas WM</h1>
                            <button onClick={() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg flex items-center justify-center gap-2 mt-4">
                                Entrar com Google
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="pb-24 fade-in">
                    <header className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
                        <div className="container mx-auto px-4 h-16 flex justify-between items-center">
                             <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-2 rounded-lg"><Icons.DollarSign className="w-5 h-5 text-white" /></div>
                                <h1 className="text-xl font-bold hidden sm:block text-gray-800 dark:text-white">Despesas WM</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-sm font-medium hidden sm:block text-gray-700 dark:text-gray-200">Olá, {user.displayName?.split(' ')[0]}</span>
                                <img src={user.photoURL} className="w-8 h-8 rounded-full border-2 border-blue-500" />
                                <button onClick={() => auth.signOut()} className="text-red-500"><Icons.LogOut size={20}/></button>
                            </div>
                        </div>
                         <div className="container mx-auto px-4 flex gap-6 overflow-x-auto no-scrollbar border-b border-gray-200 dark:border-gray-700">
                             <button onClick={()=>setActiveTab('dashboard')} className={`py-3 px-2 border-b-2 font-medium flex gap-2 ${activeTab==='dashboard'?'border-blue-500 text-blue-600':'border-transparent text-gray-500'}`}><Icons.LayoutDashboard size={18}/> Dashboard</button>
                             <button onClick={()=>setActiveTab('expenses')} className={`py-3 px-2 border-b-2 font-medium flex gap-2 ${activeTab==='expenses'?'border-blue-500 text-blue-600':'border-transparent text-gray-500'}`}><Icons.FileText size={18}/> Lançamentos</button>
                             <button onClick={()=>setActiveTab('conciliation')} className={`py-3 px-2 border-b-2 font-medium flex gap-2 ${activeTab==='conciliation'?'border-blue-500 text-blue-600':'border-transparent text-gray-500'}`}><Icons.AlertCircle size={18}/> Conciliação {extrato.length>0 && <span className="bg-red-500 text-white text-[10px] px-1.5 rounded-full">{extrato.length}</span>}</button>
                         </div>
                    </header>

                    {/* FAB */}
                    <button onClick={() => { resetForm(); setIsFormOpen(true); }} className="fixed bottom-6 right-6 z-50 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-xl md:hidden"><Icons.Plus size={24} /></button>

                    <main className="container mx-auto p-4 md:p-6">
                         {/* Filtros */}
                         {(activeTab === 'dashboard' || activeTab === 'expenses') && (
                            <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icons.Calendar size={16}/></span><select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg"><option value="all">Todos os Anos</option>{[2023, 2024, 2025, 2026].map(y => <option key={y} value={y}>{y}</option>)}</select></div>
                                <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icons.Filter size={16}/></span><select value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg"><option value="all">Todos os Meses</option>{MESES.map((m, i) => <option key={i} value={i}>{m}</option>)}</select></div>
                                <div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icons.Search size={16}/></span><input type="text" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg" /></div>
                                {activeTab === 'expenses' && <button onClick={() => { resetForm(); setIsFormOpen(true); }} className="hidden md:flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg"><Icons.Plus size={18} /> Nova Despesa</button>}
                            </div>
                         )}

                         {/* DASHBOARD */}
                         {activeTab === 'dashboard' && (
                             <div className="space-y-6">
                                 <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                     <div className="bg-blue-600 rounded-xl p-6 text-white shadow-lg"><p className="text-blue-100 text-sm">Total Filtrado</p><h3 className="text-3xl font-bold">{formatCurrency(totalFiltered)}</h3></div>
                                     <div className="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700"><p className="text-gray-500 text-sm">Maior Despesa</p><h3 className="text-2xl font-bold dark:text-white">{formatCurrency(Math.max(...filteredExpenses.map(e => e.Total), 0))}</h3></div>
                                     <div className="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-gray-700"><p className="text-gray-500 text-sm">Lançamentos</p><h3 className="text-2xl font-bold dark:text-white">{filteredExpenses.length}</h3></div>
                                 </div>
                                 <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                     <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><h3 className="text-lg font-bold mb-4 dark:text-white">Por Categoria</h3><ChartComponent type="doughnut" data={chartDataCategory} /></div>
                                     <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm"><h3 className="text-lg font-bold mb-4 dark:text-white">Evolução Mensal</h3><ChartComponent type="bar" data={chartDataMonthly} /></div>
                                 </div>
                             </div>
                         )}

                         {/* EXPENSES */}
                         {activeTab === 'expenses' && (
                             <div className="space-y-4">
                                 <div className="flex gap-3 mb-4"><label className="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg cursor-pointer text-sm font-medium"><Icons.Upload size={16} /> Importar CSV<input type="file" className="hidden" accept=".csv" onChange={handleExpenseCSV} /></label></div>
                                 <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                                     <div className="hidden md:grid grid-cols-12 gap-4 p-4 bg-gray-50 dark:bg-gray-700 text-xs font-semibold text-gray-500 uppercase">
                                         <div className="col-span-2">Data</div><div className="col-span-3">Descrição</div><div className="col-span-2">Categoria</div><div className="col-span-2 text-right">Valor</div><div className="col-span-3 text-right">Ações</div>
                                     </div>
                                     <div className="divide-y divide-gray-100 dark:divide-gray-700">
                                         {filteredExpenses.map(e => (
                                             <div key={e.id} className="group hover:bg-gray-50 dark:hover:bg-gray-700 p-4 grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                                                 <div className="col-span-12 md:col-span-2 text-gray-600 dark:text-gray-300 flex justify-between md:block"><span className="md:hidden font-bold">Data:</span>{parseDate(e.Data).toLocaleDateString('pt-BR')}</div>
                                                 <div className="col-span-12 md:col-span-3 font-medium dark:text-white truncate">{e.Descricao}</div>
                                                 <div className="col-span-6 md:col-span-2 text-xs"><span className="bg-blue-50 text-blue-600 px-2 py-1 rounded-full">{e.Categoria}</span></div>
                                                 <div className="col-span-6 md:col-span-2 text-right font-bold dark:text-white">{formatCurrency(e.Total)}</div>
                                                 <div className="col-span-12 md:col-span-3 flex justify-end gap-2">
                                                     <button onClick={()=>openEdit(e)} className="p-1.5 text-blue-600"><Icons.Edit2 size={16}/></button>
                                                     <button onClick={()=>handleDelete(e.id)} className="p-1.5 text-red-600"><Icons.Trash2 size={16}/></button>
                                                 </div>
                                             </div>
                                         ))}
                                     </div>
                                 </div>
                             </div>
                         )}

                         {/* CONCILIATION */}
                         {activeTab === 'conciliation' && (
                             <div className="space-y-6">
                                 <div className="bg-orange-50 p-4 rounded-xl flex justify-between items-center"><h3 className="text-lg font-bold text-orange-800">Itens Pendentes</h3><label className="flex items-center gap-2 px-4 py-2 bg-white border rounded-lg cursor-pointer text-sm font-bold"><Icons.Upload size={16} /> Upload Extrato<input type="file" className="hidden" accept=".csv" onChange={handleExtratoCSV} /></label></div>
                                 <div className="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                                     {extrato.map(item => (
                                         <div key={item.id} className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700">
                                             <div className="flex justify-between mb-2"><span className="text-xs text-gray-500">{item.Data}</span><span className="font-bold text-red-600">{formatCurrency(Math.abs(item.Valor))}</span></div>
                                             <p className="text-sm font-medium mb-4 dark:text-white">{item.Detalhes || item.Lancamento}</p>
                                             <div className="flex gap-2"><button onClick={()=>openConciliate(item)} className="flex-1 bg-green-600 text-white text-xs font-bold py-2 rounded-lg flex justify-center gap-1"><Icons.CheckCircle size={14}/> Conciliar</button><button onClick={()=>handleDeleteExtrato(item.id)} className="px-3 bg-gray-100 text-gray-600 rounded-lg"><Icons.Trash2 size={16}/></button></div>
                                         </div>
                                     ))}
                                     {extrato.length === 0 && <div className="col-span-full text-center py-12 text-gray-400">Nenhum item pendente.</div>}
                                 </div>
                             </div>
                         )}
                    </main>

                    {/* MODAL */}
                    <Modal isOpen={isFormOpen} onClose={()=>setIsFormOpen(false)} title={editingId ? "Editar" : "Nova Despesa"}>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="block text-sm mb-1 dark:text-white">Data</label><input type="date" name="Data" required value={formData.Data} onChange={handleInputChange} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"/></div>
                            <div><label className="block text-sm mb-1 dark:text-white">Total</label><input type="number" step="0.01" name="Total" required value={formData.Total} readOnly className="w-full p-2 border rounded bg-gray-100 dark:bg-gray-600 dark:text-white"/></div>
                            <div className="col-span-2"><label className="block text-sm mb-1 dark:text-white">Descrição</label><input type="text" name="Descricao" required value={formData.Descricao} onChange={handleInputChange} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"/></div>
                            <div><label className="block text-sm mb-1 dark:text-white">Categoria</label><select name="Categoria" required value={formData.Categoria} onChange={handleInputChange} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Selecione</option>{Object.keys(CATEGORIAS_PADRAO).map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                            <div><label className="block text-sm mb-1 dark:text-white">Sub Categoria</label><select name="SubCategoria" required value={formData.SubCategoria} onChange={handleInputChange} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Selecione</option>{formData.Categoria && CATEGORIAS_PADRAO[formData.Categoria]?.map(s=><option key={s} value={s}>{s}</option>)}</select></div>
                            <div><label className="block text-sm mb-1 dark:text-white">Qtd</label><input type="number" step="any" name="Quantidade" value={formData.Quantidade} onChange={handleInputChange} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"/></div>
                            <div><label className="block text-sm mb-1 dark:text-white">Preço Unit</label><input type="number" step="any" name="PrecoUnitario" value={formData.PrecoUnitario} onChange={handleInputChange} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"/></div>
                            <div className="col-span-2 pt-4"><button type="submit" className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">{editingId ? 'Salvar' : 'Registrar'}</button></div>
                        </form>
                    </Modal>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
