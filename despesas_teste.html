<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Despesas WM - Mobile</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- UTILITÁRIOS DE TRATAMENTO DE DADOS (CRUCIAIS) ---
        
        // Função robusta para interpretar datas de formatos variados (dd/mm/yyyy ou yyyy-mm-dd)
        const parseDate = (dateVal) => {
            if (!dateVal) return new Date();
            // Se já for objeto Timestamp do Firestore
            if (dateVal && typeof dateVal.toDate === 'function') return dateVal.toDate();
            // Se for string
            if (typeof dateVal === 'string') {
                // Tenta formato BR: dd/mm/yyyy
                if (dateVal.includes('/')) {
                    const parts = dateVal.split('/');
                    if (parts.length === 3) {
                        // Mês em JS começa em 0
                        return new Date(parts[2], parts[1] - 1, parts[0], 12, 0, 0);
                    }
                }
                // Tenta formato ISO: yyyy-mm-dd
                if (dateVal.includes('-')) {
                    // Adicionamos T12:00:00 para evitar problemas de fuso horário voltando 1 dia
                    return new Date(dateVal + 'T12:00:00');
                }
            }
            return new Date(); // Fallback
        };

        const formatMoney = (val) => {
            if (typeof val === 'number') return val;
            if (typeof val === 'string') {
                return parseFloat(val.replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
            }
            return 0;
        };

        const CATEGORIAS = {
            "Pecuária": ["Alimentação", "Medicamentos", "Sanidade", "Reprodução"],
            "Agricultura": ["Insumos", "Fertilizantes", "Sementes", "Mão de Obra"],
            "Infraestrutura": ["Manutenção Predial", "Equipamentos", "Veículos", "Ferramentas"],
            "Administrativo": ["Impostos", "Serviços", "Salários"],
            "Outros": ["Diversos"]
        };

        // --- COMPONENTES UI ---

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border-l-4 p-4 ${className}`}>
                {children}
            </div>
        );

        // --- TELA DE LOGIN ---
        const LoginScreen = ({ onLogin }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-100">
                <div className="w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mb-6 shadow-xl">
                    <Icon name="sprout" className="text-white" size={40} />
                </div>
                <h1 className="text-2xl font-bold text-gray-800">Fazenda WM</h1>
                <p className="text-gray-500 mb-8">Gestão Financeira</p>
                <button onClick={onLogin} className="bg-white text-gray-700 font-medium py-3 px-6 rounded-lg shadow flex items-center gap-3 active:scale-95 transition-transform">
                    <Icon name="log-in" size={20} /> Entrar com Google
                </button>
            </div>
        );

        // --- TELA: LISTA DE DESPESAS ---
        const ExpenseList = ({ expenses, onDelete }) => {
            const [filter, setFilter] = useState('');

            // Filtro local
            const filtered = useMemo(() => {
                let data = expenses;
                if (filter) {
                    const lower = filter.toLowerCase();
                    data = data.filter(e => 
                        (e.Descrição && e.Descrição.toLowerCase().includes(lower)) || 
                        (e.Categoria && e.Categoria.toLowerCase().includes(lower))
                    );
                }
                return data.slice(0, 100); // Mostra os 100 mais recentes após filtro
            }, [expenses, filter]);

            // Mapeamento de cores por categoria para facilitar leitura
            const getCategoryColor = (cat) => {
                const map = {
                    'Pecuária': 'border-green-500',
                    'Agricultura': 'border-yellow-500',
                    'Infraestrutura': 'border-gray-500',
                    'Administrativo': 'border-blue-500',
                    'Outros': 'border-purple-500'
                };
                return map[cat] || 'border-gray-200';
            };

            return (
                <div className="pb-24 pt-2 px-3 space-y-3">
                    {/* Barra de Busca Fixa */}
                    <div className="sticky top-0 pt-2 pb-2 bg-gray-100/95 backdrop-blur z-10">
                        <div className="relative shadow-sm">
                            <Icon name="search" className="absolute left-3 top-3.5 text-gray-400" size={18} />
                            <input 
                                type="text" 
                                placeholder="Buscar (ex: Vaqueiro, Ração)..." 
                                className="w-full pl-10 pr-4 py-3 rounded-lg border-none bg-white text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-green-500 outline-none"
                                value={filter}
                                onChange={(e) => setFilter(e.target.value)}
                            />
                        </div>
                    </div>

                    {filtered.length === 0 ? (
                        <div className="text-center py-12 opacity-50">
                            <Icon name="list-x" size={48} className="mx-auto mb-2" />
                            <p>Nenhum registro encontrado.</p>
                        </div>
                    ) : (
                        filtered.map(item => (
                            <Card key={item.docId} className={`${getCategoryColor(item.Categoria)} flex justify-between items-start`}>
                                <div className="flex-1 pr-2">
                                    <div className="flex items-center gap-2 mb-1">
                                        {/* Data formatada corretamente */}
                                        <span className="text-xs font-bold text-gray-500 uppercase tracking-wide flex items-center gap-1">
                                            <Icon name="calendar" size={12} />
                                            {item.dateObj.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'})}
                                        </span>
                                        <span className="text-[10px] bg-gray-100 px-2 py-0.5 rounded-full text-gray-600 border border-gray-200">
                                            {item.Categoria}
                                        </span>
                                    </div>
                                    
                                    {/* Descrição em Destaque */}
                                    <h3 className="font-bold text-gray-800 text-base leading-tight">
                                        {item.Descrição || "Sem descrição"}
                                    </h3>
                                    
                                    {/* Subcategoria secundária */}
                                    <p className="text-sm text-gray-500 mt-0.5">
                                        {item['Sub Categoria'] || '-'}
                                    </p>
                                </div>

                                <div className="flex flex-col items-end justify-between h-full gap-2">
                                    <span className="font-bold text-gray-900 text-lg whitespace-nowrap">
                                        {item.rawTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                                    </span>
                                    <button 
                                        onClick={() => { if(confirm('Tem certeza que deseja apagar?')) onDelete(item.docId); }}
                                        className="text-red-400 p-2 hover:bg-red-50 rounded-full -mr-2"
                                    >
                                        <Icon name="trash-2" size={18} />
                                    </button>
                                </div>
                            </Card>
                        ))
                    )}
                </div>
            );
        };

        // --- TELA: NOVA DESPESA ---
        const AddExpense = ({ onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                Data: new Date().toISOString().split('T')[0],
                Categoria: '',
                SubCategoria: '',
                Descrição: '',
                Quantidade: 1,
                PrecoUnitario: '',
                Total: 0
            });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const q = parseFloat(formData.Quantidade) || 0;
                const p = parseFloat(formData.PrecoUnitario) || 0;
                setFormData(prev => ({ ...prev, Total: q * p }));
            }, [formData.Quantidade, formData.PrecoUnitario]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                await onSave(formData);
                setLoading(false);
            };

            return (
                <div className="bg-white min-h-screen pb-safe">
                    <div className="flex items-center justify-between p-4 border-b sticky top-0 bg-white z-20">
                        <button onClick={onCancel} className="text-gray-500"><Icon name="x" size={24}/></button>
                        <h2 className="font-bold text-lg">Nova Despesa</h2>
                        <div className="w-6"></div>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="p-5 space-y-5">
                         <div className="bg-green-50 p-4 rounded-xl text-center border border-green-100">
                            <label className="text-xs text-green-700 font-bold uppercase">Total Estimado</label>
                            <div className="text-3xl font-bold text-green-800 mt-1">
                                {formData.Total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Data</label>
                            <input type="date" required className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-green-500 outline-none"
                                value={formData.Data} onChange={e => setFormData({...formData, Data: e.target.value})} />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                            <input type="text" required placeholder="O que foi pago?" className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-green-500 outline-none"
                                value={formData.Descrição} onChange={e => setFormData({...formData, Descrição: e.target.value})} />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                <select required className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-green-500 outline-none"
                                    value={formData.Categoria} onChange={e => setFormData({...formData, Categoria: e.target.value, SubCategoria: ''})}>
                                    <option value="">Selecione</option>
                                    {Object.keys(CATEGORIAS).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Sub Categoria</label>
                                <select required disabled={!formData.Categoria} className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-green-500 outline-none disabled:opacity-50"
                                    value={formData.SubCategoria} onChange={e => setFormData({...formData, SubCategoria: e.target.value})}>
                                    <option value="">Selecione</option>
                                    {formData.Categoria && CATEGORIAS[formData.Categoria].map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
                                <input type="number" step="any" className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-green-500 outline-none"
                                    value={formData.Quantidade} onChange={e => setFormData({...formData, Quantidade: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Valor Unit. (R$)</label>
                                <input type="number" step="any" required className="w-full p-3 bg-gray-50 rounded-lg border focus:ring-2 focus:ring-green-500 outline-none"
                                    value={formData.PrecoUnitario} onChange={e => setFormData({...formData, PrecoUnitario: e.target.value})} />
                            </div>
                        </div>

                        <button disabled={loading} className="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700 transition-colors">
                            {loading ? 'Salvando...' : 'Confirmar Lançamento'}
                        </button>
                    </form>
                </div>
            );
        };

        // --- DASHBOARD SIMPLES ---
        const Dashboard = ({ expenses }) => {
            const chartRef = useRef(null);
            
            useEffect(() => {
                if (!chartRef.current || !expenses.length) return;
                
                // Agrupar por categoria (Todos os dados carregados)
                const cats = {};
                expenses.forEach(e => {
                    cats[e.Categoria] = (cats[e.Categoria] || 0) + e.rawTotal;
                });

                if (window.myChart) window.myChart.destroy();

                window.myChart = new Chart(chartRef.current.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(cats),
                        datasets: [{
                            data: Object.values(cats),
                            backgroundColor: ['#22c55e', '#eab308', '#64748b', '#3b82f6', '#a855f7'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }, [expenses]);

            const totalGeral = expenses.reduce((acc, curr) => acc + curr.rawTotal, 0);

            return (
                <div className="pb-24 pt-6 px-4 space-y-6">
                    <h2 className="text-xl font-bold text-gray-800">Resumo Financeiro</h2>
                    <div className="bg-gradient-to-r from-green-600 to-green-800 rounded-xl p-5 text-white shadow-lg">
                        <p className="text-green-100 text-sm mb-1">Total Acumulado (Carregado)</p>
                        <h3 className="text-3xl font-bold">{totalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</h3>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm h-80">
                        <h3 className="font-semibold text-gray-700 mb-4 text-center">Distribuição por Categoria</h3>
                        <div className="h-64 relative"><canvas ref={chartRef}></canvas></div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list'); 
            const [expenses, setExpenses] = useState([]);
            
            useEffect(() => {
                const u = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (u) loadData();
                });
                return () => u();
            }, []);

            // Função para carregar e processar dados
            const loadData = async () => {
                try {
                    // Busca documentos (sem orderBy no Firestore para evitar erro de índice com formatos mistos)
                    // Trazemos tudo e ordenamos no JS para garantir precisão
                    const snapshot = await db.collection("despesas").get();
                    
                    const processed = snapshot.docs.map(doc => {
                        const d = doc.data();
                        const dateObj = parseDate(d.Data); // Usa a função corrigida
                        const rawTotal = formatMoney(d.Total);
                        return { 
                            docId: doc.id, 
                            ...d, 
                            dateObj: dateObj,
                            rawTotal: rawTotal
                        };
                    });

                    // ORDENAÇÃO NO JS: Garante que 24/12 fique no topo
                    processed.sort((a, b) => b.dateObj - a.dateObj);

                    setExpenses(processed);
                } catch (error) {
                    console.error("Erro ao carregar:", error);
                    alert("Erro ao buscar dados.");
                }
            };

            const handleSave = async (data) => {
                const payload = {
                    "Data": data.Data, // Salva como yyyy-mm-dd (padrão input date)
                    "Categoria": data.Categoria,
                    "Sub Categoria": data.SubCategoria,
                    "Descrição": data.Descrição,
                    "Quantidade": parseFloat(data.Quantidade),
                    "Preço Unitário": parseFloat(data.PrecoUnitario),
                    "Total": parseFloat(data.Total),
                    "Timestamp": firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection("despesas").add(payload);
                await loadData();
                setView('list');
            };

            const handleDelete = async (id) => {
                await db.collection("despesas").doc(id).delete();
                setExpenses(prev => prev.filter(e => e.docId !== id));
            };

            if (!user) return <LoginScreen onLogin={() => auth.signInWithPopup(provider)} />;

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-100 relative shadow-2xl overflow-hidden">
                    
                    {view === 'list' && <ExpenseList expenses={expenses} onDelete={handleDelete} />}
                    {view === 'add' && <AddExpense onSave={handleSave} onCancel={() => setView('list')} />}
                    {view === 'dashboard' && <Dashboard expenses={expenses} />}

                    {/* Menu Inferior */}
                    {view !== 'add' && (
                        <nav className="fixed bottom-0 w-full max-w-md bg-white border-t flex justify-around items-center h-16 pb-safe z-30">
                            <button onClick={() => setView('list')} className={`flex flex-col items-center w-full ${view === 'list' ? 'text-green-600' : 'text-gray-400'}`}>
                                <Icon name="list" size={24} />
                                <span className="text-[10px] mt-1">Lançamentos</span>
                            </button>
                            
                            <div className="relative -top-6">
                                <button onClick={() => setView('add')} className="bg-green-600 text-white p-4 rounded-full shadow-lg hover:bg-green-700 transition-transform active:scale-90">
                                    <Icon name="plus" size={32} />
                                </button>
                            </div>

                            <button onClick={() => setView('dashboard')} className={`flex flex-col items-center w-full ${view === 'dashboard' ? 'text-green-600' : 'text-gray-400'}`}>
                                <Icon name="pie-chart" size={24} />
                                <span className="text-[10px] mt-1">Gráficos</span>
                            </button>
                        </nav>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
