<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro - Fazenda WM de Jesus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; margin: auto; height: 400px; width: 100%; }
        .kpi-card { transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        let chartInstances = {};
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

        function signIn() { auth.signInWithPopup(provider).catch(e => console.error("Auth Error:", e)); }
        function signOut() { auth.signOut().catch(e => console.error("Sign Out Error:", e)); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadAllData();
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr.toDate) return dateStr.toDate();
            if (typeof dateStr !== 'string') return null;
            if (dateStr.includes('-')) return new Date(dateStr + "T00:00:00");
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const [day, month, year] = parts;
            return new Date(Number(year), Number(month) - 1, Number(day));
        }

        function parseCurrency(currencyStr) {
            if (typeof currencyStr !== 'string') return Number(currencyStr) || 0;
            return Number(String(currencyStr).replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
        }

        async function loadAllData() {
            try {
                const [receitasSnap, despesasSnap] = await Promise.all([
                    db.collection("receitas").get(),
                    db.collection("despesas").get()
                ]);

                let receitas = receitasSnap.docs.map(doc => ({ ...doc.data(), Data: parseDate(doc.data().Data), Total: parseCurrency(doc.data().Total) }));
                let despesas = despesasSnap.docs.map(doc => ({ ...doc.data(), Data: parseDate(doc.data().Data), Total: parseCurrency(doc.data().Total) }));
                
                receitas = receitas.filter(r => r.Data && !isNaN(r.Data));
                despesas = despesas.filter(d => d.Data && !isNaN(d.Data));

                populateYearFilter([...receitas, ...despesas]);
                document.getElementById('yearFilter').addEventListener('change', () => runAnalysis(receitas, despesas));
                document.getElementById('delete-data-btn').addEventListener('click', deleteAllData);
                runAnalysis(receitas, despesas);

            } catch (error) {
                console.error("Erro ao carregar dados consolidados:", error);
                alert("Erro ao carregar os dados. Verifique as permissões das coleções 'receitas' e 'despesas'.");
            }
        }
        
        async function clearCollection(collectionName) {
            const snapshot = await db.collection(collectionName).get();
            if (snapshot.empty) return;

            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }

        async function deleteAllData() {
            if (!confirm("ATENÇÃO!\n\nVocê está prestes a apagar TODOS os dados de receitas E despesas.\n\nEsta ação é IRREVERSÍVEL. Deseja continuar?")) {
                return;
            }
            if (!confirm("CONFIRMAÇÃO FINAL:\n\nApagar todos os dados financeiros?")) {
                return;
            }

            try {
                document.body.style.cursor = 'wait';
                await Promise.all([
                    clearCollection('receitas'),
                    clearCollection('despesas')
                ]);
                alert("Todos os dados de receitas e despesas foram apagados com sucesso!");
                loadAllData();
            } catch (error) {
                console.error("Erro ao apagar os dados:", error);
                alert("Ocorreu um erro ao apagar os dados. Verifique o console.");
            } finally {
                document.body.style.cursor = 'default';
            }
        }
        
        function populateYearFilter(allData) {
            const yearFilter = document.getElementById('yearFilter');
            const years = [...new Set(allData.map(item => item.Data.getFullYear()))].sort((a,b) => b-a);
            yearFilter.innerHTML = '<option value="all">Todos os Anos</option>';
            years.forEach(year => yearFilter.add(new Option(year, year)));
        }

        function runAnalysis(allReceitas, allDespesas) {
            const year = document.getElementById('yearFilter').value;
            
            const receitas = (year === 'all') ? allReceitas : allReceitas.filter(r => r.Data.getFullYear() == year);
            const despesas = (year === 'all') ? allDespesas : allDespesas.filter(d => d.Data.getFullYear() == year);

            const totalReceitas = receitas.reduce((sum, item) => sum + item.Total, 0);
            const totalDespesas = despesas.reduce((sum, item) => sum + item.Total, 0);
            const lucroLiquido = totalReceitas - totalDespesas;

            document.getElementById('kpi-receita').textContent = totalReceitas.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('kpi-despesa').textContent = totalDespesas.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            const lucroEl = document.getElementById('kpi-lucro');
            lucroEl.textContent = lucroLiquido.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            lucroEl.className = 'text-3xl font-bold ' + (lucroLiquido >= 0 ? 'text-green-500' : 'text-red-500');

            createFinancialEvolutionChart(receitas, despesas);
            createRevenueSourceChart(receitas);
            createExpenseCategoryChart(despesas);
            generateInsights(receitas, despesas);
        }

        function createFinancialEvolutionChart(receitas, despesas) {
            const monthlyReceitas = Array(12).fill(0);
            const monthlyDespesas = Array(12).fill(0);
            const monthlyLucro = Array(12).fill(0);

            receitas.forEach(item => { monthlyReceitas[item.Data.getMonth()] += item.Total; });
            despesas.forEach(item => { monthlyDespesas[item.Data.getMonth()] += item.Total; });
            for(let i=0; i<12; i++) { monthlyLucro[i] = monthlyReceitas[i] - monthlyDespesas[i]; }

            const ctx = document.getElementById('financialEvolutionChart').getContext('2d');
            if(chartInstances.evolution) chartInstances.evolution.destroy();
            chartInstances.evolution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [
                        { label: 'Receitas', data: monthlyReceitas, backgroundColor: '#22c55e' },
                        { label: 'Despesas', data: monthlyDespesas, backgroundColor: '#ef4444' },
                        { label: 'Saldo Líquido', data: monthlyLucro, type: 'line', borderColor: '#3b82f6', tension: 0.1, borderWidth: 3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function createRevenueSourceChart(data){const ctx=document.getElementById('revenueSourceChart').getContext('2d');if(chartInstances.source)chartInstances.source.destroy();const sourceTotals=data.reduce((acc,cur)=>{const type=cur['Tipo de Receita']||'Outros';const total=cur.Total;acc[type]=(acc[type]||0)+total;return acc},{});const sortedSources=Object.entries(sourceTotals).sort((a,b)=>b[1]-a[1]);chartInstances.source=new Chart(ctx,{type:'pie',data:{labels:sortedSources.map(s=>s[0]),datasets:[{data:sortedSources.map(s=>s[1]),backgroundColor:['#22c55e','#84cc16','#f97316','#3b82f6','#8b5cf6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}})}
        function createExpenseCategoryChart(data){const ctx=document.getElementById('expenseCategoryChart').getContext('2d');if(chartInstances.expense)chartInstances.expense.destroy();const categoryTotals=data.reduce((acc,cur)=>{const type=cur.Categoria||'Outras';const total=cur.Total;acc[type]=(acc[type]||0)+total;return acc},{});const sortedCategories=Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1]);chartInstances.expense=new Chart(ctx,{type:'pie',data:{labels:sortedCategories.map(c=>c[0]),datasets:[{data:sortedCategories.map(c=>c[1]),backgroundColor:['#ef4444','#f97316','#eab308','#60a5fa','#d946ef']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}})}
        function generateInsights(receitas, despesas) {
            const insightsList = document.getElementById('insights-list');
            insightsList.innerHTML = '';
            
            const addInsight = (text, color = 'text-gray-300') => {
                const li = document.createElement('li');
                li.className = `flex items-start gap-3 ${color}`;
                li.innerHTML = `<svg class="w-5 h-5 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>${text}</span>`;
                insightsList.appendChild(li);
            };

            const monthlyResults = meses.map((_, i) => {
                const r = receitas.filter(rec => rec.Data.getMonth() === i).reduce((sum, rec) => sum + rec.Total, 0);
                const d = despesas.filter(des => des.Data.getMonth() === i).reduce((sum, des) => sum + des.Total, 0);
                return { mes: meses[i], saldo: r - d };
            }).filter(m => m.saldo !== 0 || (receitas.some(rec => rec.Data.getMonth() === i) || despesas.some(des => des.Data.getMonth() === i)));

            if (monthlyResults.length > 0) {
                const bestMonth = monthlyResults.reduce((max, month) => month.saldo > max.saldo ? month : max, monthlyResults[0]);
                addInsight(`Mês de maior lucro foi <strong>${bestMonth.mes}</strong> com saldo de <strong>${bestMonth.saldo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</strong>.`, 'text-green-400');
                
                const worstMonth = monthlyResults.reduce((min, month) => month.saldo < min.saldo ? month : min, monthlyResults[0]);
                if (worstMonth.saldo < bestMonth.saldo) {
                     addInsight(`Mês de menor resultado foi <strong>${worstMonth.mes}</strong> com saldo de <strong>${worstMonth.saldo.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</strong>.`, worstMonth.saldo < 0 ? 'text-red-400' : 'text-yellow-400');
                }
            } else {
                 addInsight('Não há dados suficientes para analisar o desempenho mensal.');
                 return;
            }

            const revenueSources = receitas.reduce((acc, cur) => { acc[cur['Tipo de Receita']] = (acc[cur['Tipo de Receita']] || 0) + cur.Total; return acc; }, {});
            if (Object.keys(revenueSources).length === 1 && receitas.length > 0) {
                addInsight(`Atenção: A fazenda depende de uma <strong>única fonte de receita</strong> (${Object.keys(revenueSources)[0]}). Considere diversificar.`, 'text-yellow-400');
            }
        }
    </script>
    
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold mb-4">Dashboard Financeiro</h1>
            <p class="mb-6">Por favor, faça login para acessar a análise consolidada.</p>
            <button onclick="signIn()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Entrar com Google</button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow p-4 flex justify-between items-center">
             <h1 class="text-2xl font-bold">Dashboard Financeiro Geral</h1>
             <div class="flex items-center gap-4">
                <div>
                   <label for="yearFilter" class="mr-2">Ano:</label>
                   <select id="yearFilter" class="p-2 rounded-md bg-gray-200 dark:bg-gray-700"></select>
                </div>
                <button id="delete-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                   Zerar Dados
                </button>
            </div>
        </header>

        <main class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="kpi-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Receita Total</h3>
                    <p id="kpi-receita" class="text-3xl font-bold text-green-500">R$ 0,00</p>
                </div>
                <div class="kpi-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Despesa Total</h3>
                    <p id="kpi-despesa" class="text-3xl font-bold text-red-500">R$ 0,00</p>
                </div>
                <div class="kpi-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
                    <h3 class="text-lg font-medium text-gray-500 dark:text-gray-400">Saldo Líquido</h3>
                    <p id="kpi-lucro" class="text-3xl font-bold">R$ 0,00</p>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                <h2 class="text-xl font-semibold mb-4 text-center">Evolução Financeira Mensal</h2>
                <div class="chart-container"><canvas id="financialEvolutionChart"></canvas></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-2 text-center">Composição das Receitas</h2>
                    <div class="chart-container"><canvas id="revenueSourceChart"></canvas></div>
                </div>
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-2 text-center">Composição das Despesas</h2>
                    <div class="chart-container"><canvas id="expenseCategoryChart"></canvas></div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Insights Automáticos</h2>
                <ul id="insights-list" class="space-y-3">
                    <!-- Insights serão gerados aqui -->
                </ul>
            </div>
        </main>
    </div>
</body>
</html>

