<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Despesas da Fazenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; margin: auto; height: 400px; width: 100%; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        #uploadModal.hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-B9s9lH62xvt9TKCMwvUbtQFPlwWIU7c",
            authDomain: "fazendawm-83f34.firebaseapp.com",
            projectId: "fazendawm-83f34",
            storageBucket: "fazendawm-83f34.firebasestorage.app",
            messagingSenderId: "40894938435",
            appId: "1:40894938435:web:1d8bdaf8f7869ecf7183f6",
            measurementId: "G-QQVTP0CQ4H"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        let chartInstances = {};
        let originalData = [];
        const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        function signIn() { auth.signInWithPopup(provider).catch(e => console.error("Auth Error:", e)); }
        function signOut() { auth.signOut().catch(e => console.error("Sign Out Error:", e)); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-img').src = user.photoURL;
                loadAndProcessData();
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        });

        async function loadAndProcessData() {
            try {
                const snapshot = await db.collection("despesas").get();
                const parseDate = (dateStr) => {
                    if (!dateStr || typeof dateStr !== 'string') return new Date();
                    const parts = dateStr.split('/');
                    if (parts.length !== 3) return new Date();
                    const [day, month, year] = parts;
                    return new Date(Number(year), Number(month) - 1, Number(day));
                };
                const parseCurrency = (currencyStr) => {
                    if (typeof currencyStr !== 'string') return Number(currencyStr) || 0;
                    return Number(currencyStr.replace('R$', '').trim().replace(/\./g, '').replace(',', '.')) || 0;
                };

                originalData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { ...data, Data: parseDate(data.Data), Total: parseCurrency(data.Total) };
                }).sort((a, b) => b.Data - a.Data);

                initializeDashboard(originalData);
            } catch (error) {
                console.error("Erro ao carregar dados do Firestore: ", error);
                alert("Erro ao carregar dados. Verifique as permissões do Firestore e se a coleção 'despesas' existe. Veja o console para mais detalhes.");
            }
        }
        
        function initializeDashboard(data) {
            populateFilters(data);
            addEventListeners();
            filterAndRedraw();
        }

        function addEventListeners() {
            document.getElementById('categoryFilter').addEventListener('change', filterAndRedraw);
            document.getElementById('subcategoryFilter').addEventListener('change', filterAndRedraw);
            document.getElementById('yearFilter').addEventListener('change', filterAndRedraw);
            document.getElementById('monthFilter').addEventListener('change', filterAndRedraw);
            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('csv-upload-input').click());
            document.getElementById('csv-upload-input').addEventListener('change', handleFileSelect);
            document.getElementById('compare-btn').addEventListener('click', handleComparison);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const parsedData = parseCSV(e.target.result);
                if (parsedData.length > 0) showUploadModal(parsedData, file.name);
            };
            reader.readAsText(file, 'ISO-8859-1');
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            let headerIndex = -1;
            for(let i=0; i<lines.length; i++){ if(lines[i].toLowerCase().includes('data')){ headerIndex = i; break; } }
            if(headerIndex === -1) { alert("Erro: Cabeçalho 'Data' não encontrado no arquivo CSV."); return []; }
            const headers = lines[headerIndex].split(';').map(h => h.trim());
            const dataLines = lines.slice(headerIndex + 1);
            return dataLines.map(line => {
                const values = line.split(';');
                let obj = {};
                headers.forEach((header, i) => { if (header) obj[header] = values[i] || ''; });
                return obj;
            }).filter(obj => obj.Data);
        }

        function showUploadModal(data, fileName) {
            const modal = document.getElementById('uploadModal');
            const content = document.getElementById('uploadModalContent');
            content.innerHTML = `<h3 class="text-lg font-medium text-gray-900 dark:text-white">Confirmar Upload</h3><div class="mt-2"><p class="text-sm text-gray-500 dark:text-gray-400">Enviar <strong>${data.length}</strong> registros do arquivo <strong>${fileName}</strong>?</p></div>`;
            const actions = document.getElementById('uploadModalActions');
            actions.innerHTML = `<button type="button" id="confirm-upload-btn" class="inline-flex justify-center w-full rounded-md shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">Confirmar</button><button type="button" id="cancel-upload-btn" class="mt-3 sm:mt-0 sm:ml-3 inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>`;
            modal.classList.remove('hidden');
            document.getElementById('confirm-upload-btn').onclick = () => uploadDataToFirestore(data);
            document.getElementById('cancel-upload-btn').onclick = () => modal.classList.add('hidden');
        }

        async function uploadDataToFirestore(data) {
            const modalContent = document.getElementById('uploadModalContent');
            const actions = document.getElementById('uploadModalActions');
            modalContent.innerHTML = `<p>Enviando ${data.length} registros...</p>`;
            actions.innerHTML = '';
            const batch = db.batch();
            const collectionRef = db.collection("despesas");
            data.forEach(item => { const docRef = collectionRef.doc(); batch.set(docRef, item); });
            try {
                await batch.commit();
                modalContent.innerHTML = `<p class="text-green-500">Upload concluído!</p>`;
                setTimeout(() => { document.getElementById('uploadModal').classList.add('hidden'); loadAndProcessData(); }, 2000);
            } catch (error) {
                console.error("Erro ao enviar dados: ", error);
                modalContent.innerHTML = `<p class="text-red-500">Erro no upload: ${error.message}</p>`;
                actions.innerHTML = `<button type="button" onclick="document.getElementById('uploadModal').classList.add('hidden')" class="mt-3 w-full rounded-md border px-4 py-2 bg-white text-gray-700">Fechar</button>`;
            }
        }
        
        function populateFilters(data){
            const categories=[...new Set(data.map(item=>item.Categoria))].filter(Boolean).sort();
            const subcategories=[...new Set(data.map(item=>item['Sub Categoria']))].filter(Boolean).sort();
            const years=[...new Set(data.map(item=>item.Data.getFullYear()))].sort((a,b)=>b-a);
            
            const populateSelect=(elementId,options,isMonth=false)=>{const select=document.getElementById(elementId);select.innerHTML=`<option value="all">${isMonth ? 'Todos os Meses' : 'Todos'}</option>`;if(isMonth){options.forEach((opt,i)=>select.add(new Option(opt,i)))}else{options.forEach(opt=>select.add(new Option(opt,opt)))}};
            
            populateSelect('categoryFilter',categories);
            populateSelect('subcategoryFilter',subcategories);
            populateSelect('yearFilter',years);
            populateSelect('monthFilter', meses, true);
            populateSelect('compareYear', years);
            populateSelect('compareMonthA', meses, true);
            populateSelect('compareMonthB', meses, true);
        }
        function filterAndRedraw(){
            const category=document.getElementById('categoryFilter').value;
            const subcategory=document.getElementById('subcategoryFilter').value;
            const year=document.getElementById('yearFilter').value;
            const month=document.getElementById('monthFilter').value;
            let filteredData=originalData;
            if(category!=='all')filteredData=filteredData.filter(d=>d.Categoria===category);
            if(subcategory!=='all')filteredData=filteredData.filter(d=>d['Sub Categoria']===subcategory);
            if(year!=='all')filteredData=filteredData.filter(d=>d.Data.getFullYear()==year);
            if(month!=='all')filteredData=filteredData.filter(d=>d.Data.getMonth()==month);
            displayData(filteredData);
        }

        function handleComparison() {
            const year = document.getElementById('compareYear').value;
            const monthAIndex = document.getElementById('compareMonthA').value;
            const monthBIndex = document.getElementById('compareMonthB').value;

            if (year === 'all' || monthAIndex === 'all' || monthBIndex === 'all' || monthAIndex === monthBIndex) {
                alert('Por favor, selecione um ano e dois meses diferentes para comparar.');
                return;
            }

            const totalMonthA = originalData
                .filter(d => d.Data.getFullYear() == year && d.Data.getMonth() == monthAIndex)
                .reduce((sum, d) => sum + d.Total, 0);

            const totalMonthB = originalData
                .filter(d => d.Data.getFullYear() == year && d.Data.getMonth() == monthBIndex)
                .reduce((sum, d) => sum + d.Total, 0);
            
            createComparisonChart(totalMonthA, totalMonthB, meses[monthAIndex], meses[monthBIndex], year);
        }

        function createComparisonChart(totalA, totalB, labelA, labelB, year) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (chartInstances.comparison) chartInstances.comparison.destroy();
            chartInstances.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [labelA, labelB],
                    datasets: [{
                        label: `Comparativo de Despesas em ${year}`,
                        data: [totalA, totalB],
                        backgroundColor: ['#3b82f6', '#f97316'],
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { callback: value => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) } } }
                }
            });
        }

        function displayData(data){
            const tableBody=document.getElementById('expensesTableBody');tableBody.innerHTML='';let totalGeral=0;
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Nenhum dado encontrado para os filtros selecionados.</td></tr>`;
            } else {
                data.forEach(row=>{const tr=document.createElement('tr');tr.className='border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800';tr.innerHTML=`<td class="py-3 px-4">${row.Data.toLocaleDateString('pt-BR')}</td><td class="py-3 px-4">${row.Categoria||'N/A'}</td><td class="py-3 px-4">${row['Sub Categoria']||'N/A'}</td><td class="py-3 px-4">${row.Descrição||'N/A'}</td><td class="py-3 px-4 text-right">${row.Total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>`;tableBody.appendChild(tr);totalGeral+=row.Total});
            }
            document.getElementById('total-geral').textContent=totalGeral.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            if (chartInstances.category) chartInstances.category.destroy();
            if (chartInstances.monthly) chartInstances.monthly.destroy();
            createCategoryChart(data);
            createMonthlyChart(data);
        }
        function createCategoryChart(data){const ctx=document.getElementById('categoryChart').getContext('2d');const categoryTotals=data.reduce((acc,cur)=>{acc[cur.Categoria]=(acc[cur.Categoria]||0)+cur.Total;return acc},{});const sortedCategories=Object.entries(categoryTotals).sort((a,b)=>b[1]-a[1]);chartInstances.category=new Chart(ctx,{type:'doughnut',data:{labels:sortedCategories.map(c=>c[0]),datasets:[{label:'Despesas por Categoria',data:sortedCategories.map(c=>c[1]),backgroundColor:['#ef4444','#f97316','#eab308','#84cc16','#22c55e','#14b6a6','#06b6d4','#3b82f6','#8b5cf6','#d946ef'],borderColor:'#1f2937'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}}}})}
        function createMonthlyChart(data){const ctx=document.getElementById('monthlyChart').getContext('2d');const monthlyTotals=Array(12).fill(0);const yearFilter=document.getElementById('yearFilter').value;let filteredData=data;if(yearFilter!=='all'){filteredData=data.filter(d=>d.Data.getFullYear()==yearFilter)}filteredData.forEach(row=>{const month=row.Data.getMonth();monthlyTotals[month]+=row.Total});const label=`Tendência Mensal (${yearFilter==='all'?'Todos os Anos':yearFilter})`;chartInstances.monthly=new Chart(ctx,{type:'line',data:{labels:meses,datasets:[{label:label,data:monthlyTotals,borderColor:'#3b82f6',backgroundColor:'rgba(59, 130, 246, 0.2)',fill:true,tension:0.1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}}}})}
    </script>
    
    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold mb-4">Análise de Despesas da Fazenda</h1>
            <p class="mb-6">Por favor, faça login para continuar.</p>
            <button onclick="signIn()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center mx-auto">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" /><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold">Análise de Despesas</h1>
                <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                <button id="upload-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    Carregar CSV
                </button>
            </div>
            <div class="flex items-center">
                <span id="user-name" class="mr-4 hidden sm:block"></span>
                <img id="user-img" class="w-10 h-10 rounded-full mr-4" alt="User Avatar">
                <button onclick="signOut()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
            </div>
        </header>

        <main class="p-6">
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                 <div><label for="yearFilter" class="block text-sm font-medium">Ano:</label><select id="yearFilter" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm"></select></div>
                 <div><label for="monthFilter" class="block text-sm font-medium">Mês:</label><select id="monthFilter" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm"></select></div>
                 <div><label for="categoryFilter" class="block text-sm font-medium">Categoria:</label><select id="categoryFilter" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm"></select></div>
                 <div><label for="subcategoryFilter" class="block text-sm font-medium">Sub Categoria:</label><select id="subcategoryFilter" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm"></select></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h2 class="text-lg font-semibold mb-2 text-center">Despesas por Categoria</h2><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><h2 class="text-lg font-semibold mb-2 text-center">Tendência Mensal</h2><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
            </div>
            
            <!-- Nova Seção de Comparativo -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                <h2 class="text-lg font-semibold mb-4 text-center">Comparativo Mensal</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div><label for="compareYear" class="block text-sm font-medium">Ano:</label><select id="compareYear" class="mt-1 block w-full p-2 border rounded-md"></select></div>
                    <div><label for="compareMonthA" class="block text-sm font-medium">Mês 1:</label><select id="compareMonthA" class="mt-1 block w-full p-2 border rounded-md"></select></div>
                    <div><label for="compareMonthB" class="block text-sm font-medium">Mês 2:</label><select id="compareMonthB" class="mt-1 block w-full p-2 border rounded-md"></select></div>
                    <button id="compare-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full">Comparar</button>
                </div>
                <div class="mt-4 chart-container"><canvas id="comparisonChart"></canvas></div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold">Tabela de Despesas</h2><div class="text-right"><span class="text-sm font-medium">Total Filtrado:</span><span id="total-geral" class="text-xl font-bold text-green-500 ml-2"></span></div></div><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700 sticky top-0"><tr><th scope="col" class="py-3 px-4">Data</th><th scope="col" class="py-3 px-4">Categoria</th><th scope="col" class="py-3 px-4">Sub Categoria</th><th scope="col" class="py-3 px-4">Descrição</th><th scope="col" class="py-3 px-4 text-right">Total</th></tr></thead><tbody id="expensesTableBody"></tbody></table></div></div>
        </main>
    </div>

    <!-- Modal de Upload -->
    <div id="uploadModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div id="uploadModalContent"></div></div>
                <div id="uploadModalActions" class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"></div>
            </div>
        </div>
    </div>

</body>
</html>
```

### O que foi feito e Próximos Passos

1.  **Filtro por Mês Adicionado:** Incluí um novo menu suspenso para que você possa filtrar as despesas por um mês específico.

2.  **Novo Gráfico Comparativo:** Criei uma nova seção na parte inferior da página chamada "Comparativo Mensal". Nela, você pode selecionar um ano e dois meses diferentes para comparar os totais de despesas lado a lado em um gráfico de barras.

3.  **Melhorias Gerais:** O código foi otimizado para lidar com os novos filtros e gráficos, além de exibir mensagens mais claras caso não encontre dados.

---

### **Ação Obrigatória: Corrija as Regras de Segurança**

O problema do botão "travado" é 100% causado pelas regras de segurança do seu Firebase. Para que a aplicação inteira funcione, você **precisa** fazer a seguinte alteração:

1.  Acesse o [Console do Firebase](https://console.firebase.google.com/project/fazendawm-83f34/firestore).
2.  No menu à esquerda, vá para **Firestore Database**.
3.  Clique na aba **Regras** (ou *Rules*).
4.  Substitua todo o texto que está lá pelo código abaixo:

    ```javascript
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        
        // Regra para a coleção de leite (já existente)
        match /artifacts/fazendawm-83f34/public/data/{document=**} {
          allow read, write: if request.auth != null;
        }

        // NOVA REGRA - Permite acesso à coleção de despesas
        match /despesas/{document=**} {
          allow read, write: if request.auth != null;
        }
      }
    }
    

