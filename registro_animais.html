<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Pecuária Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 min-h-screen">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-chart-line mr-2"></i>DASHBOARD GADO PRO</h1>
            <div class="text-sm text-gray-400">Versão 2.0 (Consolidada)</div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 space-y-6">
        
        <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-600">
            <h2 class="text-lg font-bold text-slate-700 mb-4">1. Carregar Dados Atuais</h2>
            <p class="text-sm text-gray-500 mb-4">Selecione suas 3 planilhas para gerar o dashboard em tempo real.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative group">
                    <input type="file" id="fileFemea" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="lerArquivo(this, 'FEMEA')">
                    <div class="border-2 border-dashed border-gray-300 p-4 rounded text-center group-hover:bg-blue-50 transition" id="box-FEMEA">
                        <i class="fas fa-venus text-pink-500 text-2xl mb-2"></i>
                        <div class="font-bold text-sm">RG FEMEA</div>
                        <div class="text-xs text-gray-400 status-msg">Clique p/ selecionar</div>
                    </div>
                </div>

                <div class="relative group">
                    <input type="file" id="fileMacho" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="lerArquivo(this, 'MACHO')">
                    <div class="border-2 border-dashed border-gray-300 p-4 rounded text-center group-hover:bg-blue-50 transition" id="box-MACHO">
                        <i class="fas fa-mars text-blue-500 text-2xl mb-2"></i>
                        <div class="font-bold text-sm">RG MACHO</div>
                        <div class="text-xs text-gray-400 status-msg">Clique p/ selecionar</div>
                    </div>
                </div>

                <div class="relative group">
                    <input type="file" id="fileNasc" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="lerArquivo(this, 'NASCIMENTO')">
                    <div class="border-2 border-dashed border-gray-300 p-4 rounded text-center group-hover:bg-blue-50 transition" id="box-NASCIMENTO">
                        <i class="fas fa-baby text-green-500 text-2xl mb-2"></i>
                        <div class="font-bold text-sm">NASCIMENTO</div>
                        <div class="text-xs text-gray-400 status-msg">Clique p/ selecionar</div>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="hidden mt-4 text-center text-blue-600 font-bold animate-pulse">
                Processando dados e gerando gráficos...
            </div>
        </div>

        <div id="painel-kpi" class="grid grid-cols-1 md:grid-cols-4 gap-4 hidden">
            <div class="bg-white p-5 rounded shadow border-t-4 border-slate-700">
                <div class="text-gray-500 text-xs font-bold uppercase">Total Animais</div>
                <div class="text-3xl font-extrabold text-slate-800" id="kpi-total">0</div>
            </div>
            <div class="bg-white p-5 rounded shadow border-t-4 border-green-500">
                <div class="text-gray-500 text-xs font-bold uppercase">Vacas em Lactação</div>
                <div class="text-3xl font-extrabold text-green-600" id="kpi-lactacao">0</div>
                <div class="text-xs text-green-700 mt-1" id="kpi-lactacao-pct">0% do total de fêmeas</div>
            </div>
            <div class="bg-white p-5 rounded shadow border-t-4 border-orange-500">
                <div class="text-gray-500 text-xs font-bold uppercase">Bezerros (< 1 ano)</div>
                <div class="text-3xl font-extrabold text-orange-500" id="kpi-bezerros">0</div>
            </div>
            <div class="bg-white p-5 rounded shadow border-t-4 border-red-500">
                <div class="text-gray-500 text-xs font-bold uppercase">Alertas Críticos</div>
                <div class="text-3xl font-extrabold text-red-600 animate-pulse" id="kpi-alertas">0</div>
            </div>
        </div>

        <div id="painel-graficos" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
            
            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Histórico de Nascimentos (Últimos 12 Meses)</h3>
                <div class="h-64">
                    <canvas id="chartNascimentos"></canvas>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Status Produtivo (Fêmeas)</h3>
                <div class="h-64 flex justify-center">
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>

        <div id="painel-detalhes" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-400">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i>Lactação > 300 Dias</h3>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Secar Urgente</span>
                </div>
                <div class="overflow-y-auto max-h-60">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-yellow-50 text-yellow-900 sticky top-0">
                            <tr>
                                <th class="p-2">Vaca</th>
                                <th class="p-2">Dias Lact.</th>
                                <th class="p-2">Desde</th>
                            </tr>
                        </thead>
                        <tbody id="lista-lactacao-longa" class="text-gray-600 divide-y">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow border-l-4 border-red-400">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-red-800"><i class="fas fa-times-circle mr-2"></i>Secas há muito tempo</h3>
                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">> 60 dias Seca</span>
                </div>
                <div class="overflow-y-auto max-h-60">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-red-50 text-red-900 sticky top-0">
                            <tr>
                                <th class="p-2">Vaca</th>
                                <th class="p-2">Status</th>
                                <th class="p-2">Últ. Parto</th>
                            </tr>
                        </thead>
                        <tbody id="lista-secas-longas" class="text-gray-600 divide-y">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // BANCO DE DADOS EM MEMÓRIA
        const DB = {
            femeas: [],
            machos: [],
            nascimentos: [],
            pronto: { FEMEA: false, MACHO: false, NASCIMENTO: false }
        };

        // 1. LEITURA DE ARQUIVOS
        function lerArquivo(input, tipo) {
            const file = input.files[0];
            if (!file) return;

            // Feedback visual
            document.querySelector(`#box-${tipo} .status-msg`).innerText = file.name;
            document.querySelector(`#box-${tipo}`).classList.add('bg-blue-50', 'border-blue-500');

            Papa.parse(file, {
                header: false, // Vamos processar manualmente para pular linhas de lixo
                skipEmptyLines: true,
                encoding: "ISO-8859-1", // Tentativa padrão para Excel Brasil. Se falhar, tente UTF-8.
                complete: (results) => {
                    processarCSV(results.data, tipo);
                }
            });
        }

        // 2. PROCESSAMENTO INTELIGENTE (Ignora cabeçalhos ruins)
        function processarCSV(linhas, tipo) {
            let dadosLimpos = [];
            let inicioDados = 0;

            // Descobre onde começam os dados reais (pula linhas vazias ou de metadados)
            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i];
                // Critério: A linha tem que ter um ID válido na primeira coluna ou ser um cabeçalho reconhecível
                const col0 = linha[0] ? String(linha[0]).trim().toUpperCase() : '';
                
                // Se achou o cabeçalho, os dados começam na próxima
                if (col0.includes('ID') || col0.includes('VACA')) {
                    inicioDados = i + 1;
                    break;
                }
            }

            // Extrai dados
            for (let i = inicioDados; i < linhas.length; i++) {
                const row = linhas[i];
                if (!row || row.length < 2) continue; // Linha inválida

                if (tipo === 'FEMEA') {
                    // Col 0: ID, Col 1: Data Parto, Col 2: Status
                    if (row[0] && !row[0].includes('TOTAL')) {
                        dadosLimpos.push({
                            id: row[0],
                            dataParto: parseData(row[1]),
                            status: String(row[2]).toUpperCase() // Força UPPERCASE para comparação
                        });
                    }
                } 
                else if (tipo === 'MACHO') {
                    // Col 0: ID, Col 1: Data Nasc
                    if (row[0] && !row[0].includes('TOTAL')) {
                        dadosLimpos.push({
                            id: row[0],
                            nascimento: parseData(row[1]),
                            tipo: 'MACHO'
                        });
                    }
                }
                else if (tipo === 'NASCIMENTO') {
                    // Col 0: Mãe, Col 1: Data Nasc
                    if (row[0] && !row[0].includes('MACHO')) {
                        dadosLimpos.push({
                            mae: row[0],
                            nascimento: parseData(row[1]),
                            sexo: row[3] // Coluna 3 costuma ser Sexo
                        });
                    }
                }
            }

            DB[tipo.toLowerCase() + 's'] = dadosLimpos; // DB.femeas, DB.machos...
            DB.pronto[tipo] = true;

            // Se carregou pelo menos 1, tenta atualizar. 
            // O ideal é carregar todos, mas vamos atualizando em tempo real.
            atualizarDashboard();
        }

        // 3. ATUALIZAÇÃO DO DASHBOARD
        function atualizarDashboard() {
            if (!DB.femeas.length && !DB.nascimentos.length) return;

            document.getElementById('painel-kpi').classList.remove('hidden');
            document.getElementById('painel-graficos').classList.remove('hidden');
            document.getElementById('painel-detalhes').classList.remove('hidden');

            const hoje = new Date(); // Data de referência (hoje real)

            // --- CÁLCULOS ---
            
            // A. Lactação
            // Busca flexível: contém "LACTA" (resolve Lactação, Lactacao, LACTAÇÃO, etc)
            const emLactacao = DB.femeas.filter(v => v.status && v.status.includes('LACTA'));
            const secas = DB.femeas.filter(v => v.status && v.status.includes('SECA'));
            
            // B. Bezerros < 1 Ano (Baseado em Nascimentos)
            const umAnoAtras = new Date();
            umAnoAtras.setFullYear(hoje.getFullYear() - 1);
            
            const bezerrosRecentes = DB.nascimentos.filter(n => n.nascimento && n.nascimento >= umAnoAtras);

            // C. Alertas (Lactação > 300 dias)
            let alertasCount = 0;
            const lactacaoLonga = emLactacao.filter(v => {
                if (!v.dataParto) return false;
                const dias = Math.floor((hoje - v.dataParto) / (1000 * 60 * 60 * 24));
                v.diasLactacao = dias; // Guarda para usar na tabela
                return dias > 300;
            });
            alertasCount += lactacaoLonga.length;

            // --- RENDERIZAR KPIs ---
            document.getElementById('kpi-total').innerText = DB.femeas.length + DB.machos.length;
            document.getElementById('kpi-lactacao').innerText = emLactacao.length;
            
            const pct = DB.femeas.length > 0 ? ((emLactacao.length / DB.femeas.length) * 100).toFixed(1) : 0;
            document.getElementById('kpi-lactacao-pct').innerText = `${pct}% do plantel de fêmeas`;
            
            document.getElementById('kpi-bezerros').innerText = bezerrosRecentes.length;
            document.getElementById('kpi-alertas').innerText = alertasCount;

            // --- RENDERIZAR TABELAS DE ALERTA ---
            
            // 1. Tabela > 300 dias
            const tbody300 = document.getElementById('lista-lactacao-longa');
            tbody300.innerHTML = '';
            lactacaoLonga.sort((a,b) => b.diasLactacao - a.diasLactacao).forEach(v => {
                tbody300.innerHTML += `
                    <tr class="border-b hover:bg-yellow-50">
                        <td class="p-2 font-bold">${v.id}</td>
                        <td class="p-2 text-red-600 font-bold">${v.diasLactacao} dias</td>
                        <td class="p-2 text-xs text-gray-500">${v.dataParto.toLocaleDateString()}</td>
                    </tr>
                `;
            });

            // 2. Tabela Secas (Só listando as que não tem data recente)
            const tbodySecas = document.getElementById('lista-secas-longas');
            tbodySecas.innerHTML = '';
            secas.slice(0, 10).forEach(v => { // Mostra top 10
                 tbodySecas.innerHTML += `
                    <tr class="border-b hover:bg-red-50">
                        <td class="p-2 font-bold">${v.id}</td>
                        <td class="p-2 text-gray-600">${v.status}</td>
                        <td class="p-2 text-xs text-gray-500">${v.dataParto ? v.dataParto.toLocaleDateString() : 'Sem data'}</td>
                    </tr>
                `;
            });

            // --- GRÁFICOS (CHART.JS) ---
            renderizarGraficos(bezerrosRecentes, emLactacao.length, secas.length);
        }

        // 4. FUNÇÃO AUXILIAR DE DATA
        function parseData(str) {
            if (!str) return null;
            // Espera formato dd/mm/aaaa ou dd/mm/aa
            const partes = str.split('/');
            if (partes.length !== 3) return null;
            
            let dia = parseInt(partes[0]);
            let mes = parseInt(partes[1]) - 1; // JS conta meses de 0 a 11
            let ano = parseInt(partes[2]);

            // Corrige ano "25" para "2025"
            if (ano < 100) ano += 2000;

            return new Date(ano, mes, dia);
        }

        // 5. RENDERIZAÇÃO DE GRÁFICOS
        let chartNascInstance = null;
        let chartStatusInstance = null;

        function renderizarGraficos(nascimentos, qtdLactacao, qtdSecas) {
            // A. PREPARAR DADOS DE NASCIMENTO (Agrupar por Mês)
            const mesesCount = {};
            const mesesLabels = [];
            const hoje = new Date();
            
            // Cria labels dos últimos 12 meses (Ex: "Jan", "Fev")
            for(let i=11; i>=0; i--) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const label = d.toLocaleString('pt-BR', { month: 'short' }); // "jan", "fev"
                mesesLabels.push(label);
                mesesCount[label] = 0;
            }

            // Conta nascimentos
            nascimentos.forEach(n => {
                const label = n.nascimento.toLocaleString('pt-BR', { month: 'short' });
                if (mesesCount[label] !== undefined) mesesCount[label]++;
            });

            const dataNasc = mesesLabels.map(m => mesesCount[m]);

            // B. DESENHAR GRÁFICO 1 (BARRAS)
            const ctx1 = document.getElementById('chartNascimentos').getContext('2d');
            if (chartNascInstance) chartNascInstance.destroy(); // Limpa anterior
            
            chartNascInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: mesesLabels,
                    datasets: [{
                        label: 'Bezerros Nascidos',
                        data: dataNasc,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // C. DESENHAR GRÁFICO 2 (ROSCA)
            const ctx2 = document.getElementById('chartStatus').getContext('2d');
            if (chartStatusInstance) chartStatusInstance.destroy();

            chartStatusInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Em Lactação', 'Secas'],
                    datasets: [{
                        data: [qtdLactacao, qtdSecas],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
