<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema Pecuária Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col">

    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-cow mr-2"></i>GADO PRO <span class="text-xs text-gray-400 font-normal">v3.0</span></h1>
            <div class="space-x-1 md:space-x-4">
                <button onclick="nav('dashboard')" class="px-3 py-2 rounded hover:bg-slate-700 transition"><i class="fas fa-chart-pie mr-1"></i> Dashboard</button>
                <button onclick="nav('cadastro')" class="px-3 py-2 rounded hover:bg-slate-700 transition"><i class="fas fa-plus-circle mr-1"></i> Novo Nascimento</button>
                <button onclick="nav('lista')" class="px-3 py-2 rounded hover:bg-slate-700 transition"><i class="fas fa-list mr-1"></i> Rebanho</button>
                <button onclick="nav('config')" class="px-3 py-2 rounded bg-blue-900 hover:bg-blue-800 transition"><i class="fas fa-file-import mr-1"></i> Importar</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-6 w-full flex-grow">
        
        <div id="tela-dashboard" class="space-y-6 animate-fade">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded shadow border-l-4 border-slate-700">
                    <div class="text-gray-500 text-xs font-bold uppercase">Total Animais</div>
                    <div class="text-3xl font-extrabold text-slate-800" id="kpi-total">0</div>
                </div>
                <div class="bg-white p-5 rounded shadow border-l-4 border-green-500">
                    <div class="text-gray-500 text-xs font-bold uppercase">Em Lactação</div>
                    <div class="text-3xl font-extrabold text-green-600" id="kpi-lactacao">0</div>
                    <div class="text-xs text-green-700 mt-1" id="kpi-lactacao-pct">0%</div>
                </div>
                <div class="bg-white p-5 rounded shadow border-l-4 border-orange-500">
                    <div class="text-gray-500 text-xs font-bold uppercase">Bezerros (< 1 ano)</div>
                    <div class="text-3xl font-extrabold text-orange-500" id="kpi-bezerros">0</div>
                </div>
                <div class="bg-white p-5 rounded shadow border-l-4 border-red-500">
                    <div class="text-gray-500 text-xs font-bold uppercase">Alertas (>300 dias)</div>
                    <div class="text-3xl font-extrabold text-red-600 animate-pulse" id="kpi-alertas">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Nascimentos (Estimativa)</h3>
                    <div class="h-64"><canvas id="chartNascimentos"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">Status Produtivo</h3>
                    <div class="h-64 flex justify-center"><canvas id="chartStatus"></canvas></div>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow border-t-4 border-yellow-400">
                <h3 class="font-bold text-yellow-800 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Vacas com Lactação Prolongada (>300 dias)</h3>
                <div class="overflow-x-auto max-h-60">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-yellow-50 text-yellow-900 sticky top-0">
                            <tr><th class="p-2">Vaca</th><th class="p-2">Dias Lact.</th><th class="p-2">Data Parto</th></tr>
                        </thead>
                        <tbody id="lista-alertas"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tela-cadastro" class="hidden max-w-2xl mx-auto bg-white rounded shadow-lg p-8">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Registrar Parto / Nascimento</h2>
            <form id="formNascimento" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ID do Bezerro(a)</label>
                        <input type="text" id="cad-idBezerro" class="w-full border p-3 rounded focus:ring-2 ring-blue-500" placeholder="Ex: 405" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Data Nascimento</label>
                        <input type="date" id="cad-data" class="w-full border p-3 rounded" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Sexo</label>
                        <select id="cad-sexo" class="w-full border p-3 rounded">
                            <option value="MACHO">Macho</option>
                            <option value="FEMEA">Fêmea</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ID da Mãe</label>
                        <input type="text" id="cad-idMae" class="w-full border p-3 rounded" placeholder="Ex: 009" required>
                        <p class="text-xs text-gray-500 mt-1">* A mãe entrará em lactação automaticamente.</p>
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow">
                    SALVAR NO BANCO DE DADOS
                </button>
            </form>
        </div>

        <div id="tela-lista" class="hidden space-y-4">
            <div class="flex justify-between items-center bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold text-slate-700">Plantel Completo</h2>
                <input type="text" id="buscaLista" onkeyup="filtrarLista()" placeholder="Buscar brinco..." class="border p-2 rounded w-64">
            </div>
            <div class="bg-white rounded shadow overflow-hidden">
                <div class="overflow-x-auto max-h-[70vh]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 uppercase font-bold text-gray-600 sticky top-0">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Tipo</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Data Ref.</th>
                                <th class="p-3">Mãe</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-lista" class="divide-y">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tela-config" class="hidden max-w-4xl mx-auto space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-600 p-4">
                <h3 class="font-bold text-blue-800">Migração de Dados</h3>
                <p class="text-sm text-blue-700">Carregue suas planilhas antigas. As datas serão corrigidas automaticamente (Ex: "25" vira "2025").</p>
                <p class="text-xs text-red-600 mt-2"><strong>Atenção:</strong> Certifique-se de ter alterado as regras do Firebase para "public" antes de importar.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded shadow text-center border-t-4 border-pink-500">
                    <i class="fas fa-venus text-3xl text-pink-500 mb-2"></i>
                    <h4 class="font-bold">1. RG FÊMEA</h4>
                    <input type="file" id="fileFemea" class="block w-full text-sm mt-2" accept=".csv">
                    <button onclick="importarCSV('FEMEA')" class="mt-2 w-full bg-slate-800 text-white text-xs py-2 rounded">PROCESSAR</button>
                </div>
                <div class="bg-white p-6 rounded shadow text-center border-t-4 border-blue-500">
                    <i class="fas fa-mars text-3xl text-blue-500 mb-2"></i>
                    <h4 class="font-bold">2. RG MACHO</h4>
                    <input type="file" id="fileMacho" class="block w-full text-sm mt-2" accept=".csv">
                    <button onclick="importarCSV('MACHO')" class="mt-2 w-full bg-slate-800 text-white text-xs py-2 rounded">PROCESSAR</button>
                </div>
                <div class="bg-white p-6 rounded shadow text-center border-t-4 border-green-500">
                    <i class="fas fa-baby text-3xl text-green-500 mb-2"></i>
                    <h4 class="font-bold">3. NASCIMENTOS</h4>
                    <input type="file" id="fileNasc" class="block w-full text-sm mt-2" accept=".csv">
                    <button onclick="importarCSV('NASCIMENTO')" class="mt-2 w-full bg-slate-800 text-white text-xs py-2 rounded">PROCESSAR</button>
                </div>
            </div>
            
            <div class="bg-slate-800 text-green-400 p-4 rounded font-mono text-xs h-40 overflow-y-auto" id="console-log">
                > Aguardando ação...
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, writeBatch, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- SUAS CREDENCIAIS REAIS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDT93mKi2kTXKLxdQngup6D-czdu9_vTYk",
            authDomain: "registro-animais.firebaseapp.com",
            projectId: "registro-animais",
            storageBucket: "registro-animais.firebasestorage.app",
            messagingSenderId: "343289114136",
            appId: "1:343289114136:web:d98ed164d8bbd3f7b9dd6d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NAVEGAÇÃO ---
        window.nav = (tela) => {
            ['dashboard', 'cadastro', 'lista', 'config'].forEach(t => document.getElementById('tela-' + t).classList.add('hidden'));
            document.getElementById('tela-' + tela).classList.remove('hidden');
            if(tela === 'dashboard' || tela === 'lista') carregarDadosDoBanco();
        }

        // --- LOG DE IMPORTAÇÃO ---
        window.log = (msg) => {
            const el = document.getElementById('console-log');
            el.innerHTML = `> ${msg}<br>` + el.innerHTML;
        }

        // --- FUNÇÃO DE IMPORTAR CSV ---
        window.importarCSV = (tipo) => {
            let inputId = tipo === 'FEMEA' ? 'fileFemea' : tipo === 'MACHO' ? 'fileMacho' : 'fileNasc';
            const file = document.getElementById(inputId).files[0];
            if(!file) return alert('Selecione o arquivo CSV primeiro.');

            window.log(`Lendo arquivo ${tipo}...`);
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                encoding: "ISO-8859-1", 
                complete: async (results) => {
                    window.log(`${results.data.length} linhas lidas. Iniciando envio para o banco de dados...`);
                    await salvarNoFirebase(results.data, tipo);
                },
                error: (err) => window.log(`Erro ao ler arquivo: ${err.message}`)
            });
        }

        async function salvarNoFirebase(linhas, tipo) {
            const batch = writeBatch(db);
            let count = 0;
            let totalLotes = 0;

            // O Firestore aceita no máximo 500 operações por lote (batch). 
            // Como seus arquivos podem ser grandes, vamos fazer um loop cuidadoso.
            
            // Vamos processar linha por linha
            for (let i = 0; i < linhas.length; i++) {
                const row = linhas[i];

                // Validação Simples: Ignorar cabeçalhos e linhas vazias
                if(!row[0] || row[0].length > 20 || row[0].toLowerCase().includes('id') || row[0].toLowerCase().includes('vaca')) continue;

                let id = row[0].trim().toUpperCase();
                let dados = null;

                try {
                    if(tipo === 'FEMEA') {
                        dados = {
                            id: id,
                            tipo: 'FEMEA',
                            status_produtivo: row[2] ? row[2].toUpperCase().trim() : 'DESCONHECIDO',
                            data_evento: corrigirData(row[1]), // Último Parto
                            status: 'Ativo'
                        };
                    } else if(tipo === 'MACHO') {
                        // Na sua planilha macho, col 3 é "BEZERRO" ou "BOI"
                        dados = {
                            id: id,
                            tipo: 'MACHO',
                            categoria_manual: row[3] || '',
                            status: 'Ativo'
                        };
                    } else if(tipo === 'NASCIMENTO') {
                        const mae = id;
                        const data = corrigirData(row[1]);
                        const sexo = row[3] ? row[3].toUpperCase() : 'INDEFINIDO';
                        if(!data) continue;
                        
                        // Cria um ID único para o bezerro se não tiver brinco ainda
                        const novoId = `BEZ-${mae}-${data.replace(/-/g,'').slice(2)}`;
                        
                        // Salva diretamente (sem batch) para evitar conflitos de ID complexos
                        await setDoc(doc(db, 'animais', novoId), {
                            id: novoId,
                            tipo: sexo === 'FEMEA' ? 'FEMEA' : 'MACHO',
                            nascimento: data,
                            id_mae: mae,
                            origem: 'Importado Nascimento'
                        });
                        count++;
                        continue; // Pula para próxima linha
                    }

                    if(dados && dados.id) {
                        const ref = doc(db, 'animais', dados.id);
                        // setDoc direto é mais seguro para iniciantes que batch complexo
                        await setDoc(ref, dados, { merge: true });
                        count++;
                    }
                } catch(e) { 
                    console.error("Erro na linha " + i, e); 
                }
            }

            window.log(`SUCESSO FINAL: ${count} registros processados e salvos.`);
            alert('Processo concluído! Vá para o Dashboard conferir.');
        }

        // --- CORREÇÃO DE DATAS (dd/mm/yy -> yyyy-mm-dd) ---
        function corrigirData(str) {
            if(!str) return null;
            let partes = str.split('/');
            if(partes.length !== 3) return null;
            
            let dia = partes[0].padStart(2,'0');
            let mes = partes[1].padStart(2,'0');
            let ano = parseInt(partes[2]);
            
            // Lógica para transformar "25" em "2025"
            if(ano < 100) ano += 2000; 
            
            return `${ano}-${mes}-${dia}`;
        }

        // --- SALVAR NOVO NASCIMENTO ---
        document.getElementById('formNascimento').addEventListener('submit', async (e) => {
            e.preventDefault();
            const bt = e.target.querySelector('button');
            bt.innerText = "Salvando...";
            bt.disabled = true;

            const idBez = document.getElementById('cad-idBezerro').value.toUpperCase();
            const idMae = document.getElementById('cad-idMae').value.toUpperCase();
            const data = document.getElementById('cad-data').value;
            const sexo = document.getElementById('cad-sexo').value;

            try {
                // 1. Cria Ficha do Bezerro
                await setDoc(doc(db, "animais", idBez), {
                    id: idBez,
                    tipo: sexo,
                    nascimento: data,
                    id_mae: idMae,
                    status: 'Ativo'
                });

                // 2. Atualiza Mãe para Lactação
                await setDoc(doc(db, "animais", idMae), {
                    id: idMae, 
                    status_produtivo: 'LACTAÇÃO',
                    data_evento: data 
                }, { merge: true });

                alert('Sucesso! Bezerro registrado e mãe atualizada.');
                document.getElementById('formNascimento').reset();
            } catch(erro) {
                alert('Erro ao salvar (Verifique suas Regras no Firebase): ' + erro.message);
                console.error(erro);
            } finally {
                bt.innerText = "SALVAR NO BANCO DE DADOS";
                bt.disabled = false;
            }
        });

        // --- CARREGAR DADOS ---
        async function carregarDadosDoBanco() {
            try {
                const snap = await getDocs(collection(db, 'animais'));
                let animais = [];
                snap.forEach(d => animais.push(d.data()));

                atualizarDashboard(animais);
                atualizarTabela(animais);
            } catch (error) {
                console.error("Erro ao ler dados:", error);
                if(error.message.includes("permission")) {
                    alert("ERRO DE PERMISSÃO: Você precisa alterar as Regras do Firestore para 'allow read, write: if true;'");
                }
            }
        }

        function atualizarDashboard(dados) {
            // Filtros
            const lactacao = dados.filter(a => a.status_produtivo && a.status_produtivo.includes('LACTA'));
            
            const umAnoAtras = new Date();
            umAnoAtras.setFullYear(umAnoAtras.getFullYear() - 1);
            
            const bezerros = dados.filter(a => {
                if(!a.nascimento) return false;
                return new Date(a.nascimento) >= umAnoAtras;
            });

            // Alertas (> 300 dias)
            let alertas = [];
            const hoje = new Date();
            lactacao.forEach(v => {
                if(v.data_evento) {
                    // Tenta criar data, lidando com possível formato yyyy-mm-dd
                    const partes = v.data_evento.split('-'); 
                    const dataParto = new Date(partes[0], partes[1]-1, partes[2]);
                    
                    const dias = Math.floor((hoje - dataParto) / (86400000));
                    if(dias > 300) alertas.push({ id: v.id, dias: dias, data: v.data_evento });
                }
            });

            // Preencher HTML
            document.getElementById('kpi-total').innerText = dados.length;
            document.getElementById('kpi-lactacao').innerText = lactacao.length;
            document.getElementById('kpi-bezerros').innerText = bezerros.length;
            document.getElementById('kpi-alertas').innerText = alertas.length;
            
            const pct = dados.length > 0 ? ((lactacao.length / dados.length) * 100).toFixed(0) : 0;
            document.getElementById('kpi-lactacao-pct').innerText = pct + "% do rebanho total";

            // Tabela Alertas
            const listaAlerta = document.getElementById('lista-alertas');
            listaAlerta.innerHTML = '';
            alertas.forEach(a => {
                listaAlerta.innerHTML += `<tr><td class="p-2 font-bold">${a.id}</td><td class="p-2 text-red-600 font-bold">${a.dias} dias</td><td class="p-2 text-gray-500">${a.data}</td></tr>`;
            });

            renderCharts(lactacao.length, dados.length - lactacao.length);
        }

        function atualizarTabela(dados) {
            const tbody = document.getElementById('tbody-lista');
            tbody.innerHTML = '';
            
            // Filtro de busca simples
            const termo = document.getElementById('buscaLista').value.toUpperCase();
            const dadosFiltrados = termo ? dados.filter(d => d.id.includes(termo)) : dados;

            // Mostra os primeiros 100 para não travar
            dadosFiltrados.slice(0, 100).forEach(a => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-3 font-bold text-slate-700">${a.id}</td>
                        <td class="p-3">${a.tipo}</td>
                        <td class="p-3 text-xs font-bold ${a.status_produtivo?.includes('LACTA') ? 'text-green-600' : 'text-gray-400'}">${a.status_produtivo || '-'}</td>
                        <td class="p-3 text-xs">${a.data_evento || a.nascimento || '-'}</td>
                        <td class="p-3 text-xs text-gray-500">${a.id_mae || '-'}</td>
                    </tr>
                `;
            });
        }

        // Busca na tabela (Função Global)
        window.filtrarLista = () => carregarDadosDoBanco();

        // Gráficos
        let chartStatus, chartNasc;
        function renderCharts(qtdLact, qtdOutros) {
            if(chartStatus) chartStatus.destroy();
            chartStatus = new Chart(document.getElementById('chartStatus'), {
                type: 'doughnut',
                data: {
                    labels: ['Em Lactação', 'Secas/Outros'],
                    datasets: [{ data: [qtdLact, qtdOutros], backgroundColor: ['#22c55e', '#cbd5e1'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            if(chartNasc) chartNasc.destroy();
            chartNasc = new Chart(document.getElementById('chartNascimentos'), {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [{ label: 'Nascimentos', data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], backgroundColor: '#3b82f6' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // Inicia
        nav('dashboard');

    </script>
</body>
</html>
